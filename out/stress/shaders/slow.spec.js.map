{"version":3,"sources":["../../../src/stress/shaders/slow.spec.ts"],"names":["description","makeTestGroup","GPUTest","g","test","desc","fn","t","kDispatchSize","data","Uint32Array","buffer","makeBufferWithContents","GPUBufferUsage","STORAGE","COPY_SRC","module","device","createShaderModule","code","pipeline","createComputePipeline","layout","compute","entryPoint","encoder","createCommandEncoder","pass","beginComputePass","setPipeline","bindGroup","createBindGroup","getBindGroupLayout","entries","binding","resource","setBindGroup","dispatch","end","queue","submit","finish","expectGPUBufferValuesEqual","Array","fill","createRenderPipeline","vertex","buffers","primitive","topology","fragment","targets","format","uniforms","UNIFORM","renderTarget","createTexture","size","usage","GPUTextureUsage","RENDER_ATTACHMENT","beginRenderPass","colorAttachments","view","createView","clearValue","loadOp","storeOp","draw","expectSinglePixelIn2DTexture","x","y","exp","Uint8Array"],"mappings":";AAAA;AACA,GADA,OAAO,MAAMA,WAAW,GAAI;AAC5B;AACA,CAFO,CAIP,SAASC,aAAT,QAA8B,sCAA9B;AACA,SAASC,OAAT,QAAwB,0BAAxB;;AAEA,OAAO,MAAMC,CAAC,GAAGF,aAAa,CAACC,OAAD,CAAvB;;AAEPC,CAAC,CAACC,IAAF,CAAO,SAAP;AACGC,IADH,CACS,+EADT;AAEGC,EAFH,CAEM,OAAMC,CAAN,KAAW;AACb,QAAMC,aAAa,GAAG,IAAtB;AACA,QAAMC,IAAI,GAAG,IAAIC,WAAJ,CAAgBF,aAAhB,CAAb;AACA,QAAMG,MAAM,GAAGJ,CAAC,CAACK,sBAAF,CAAyBH,IAAzB,EAA+BI,cAAc,CAACC,OAAf,GAAyBD,cAAc,CAACE,QAAvE,CAAf;AACA,QAAMC,MAAM,GAAGT,CAAC,CAACU,MAAF,CAASC,kBAAT,CAA4B;AACzCC,IAAAA,IAAI,EAAG;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAb+C,EAA5B,CAAf;;AAeA,QAAMC,QAAQ,GAAGb,CAAC,CAACU,MAAF,CAASI,qBAAT,CAA+B;AAC9CC,IAAAA,MAAM,EAAE,MADsC;AAE9CC,IAAAA,OAAO,EAAE,EAAEP,MAAF,EAAUQ,UAAU,EAAE,MAAtB,EAFqC,EAA/B,CAAjB;;AAIA,QAAMC,OAAO,GAAGlB,CAAC,CAACU,MAAF,CAASS,oBAAT,EAAhB;AACA,QAAMC,IAAI,GAAGF,OAAO,CAACG,gBAAR,EAAb;AACAD,EAAAA,IAAI,CAACE,WAAL,CAAiBT,QAAjB;AACA,QAAMU,SAAS,GAAGvB,CAAC,CAACU,MAAF,CAASc,eAAT,CAAyB;AACzCT,IAAAA,MAAM,EAAEF,QAAQ,CAACY,kBAAT,CAA4B,CAA5B,CADiC;AAEzCC,IAAAA,OAAO,EAAE,CAAC,EAAEC,OAAO,EAAE,CAAX,EAAcC,QAAQ,EAAE,EAAExB,MAAF,EAAxB,EAAD,CAFgC,EAAzB,CAAlB;;AAIAgB,EAAAA,IAAI,CAACS,YAAL,CAAkB,CAAlB,EAAqBN,SAArB;AACAH,EAAAA,IAAI,CAACU,QAAL,CAAc7B,aAAd;AACAmB,EAAAA,IAAI,CAACW,GAAL;AACA/B,EAAAA,CAAC,CAACU,MAAF,CAASsB,KAAT,CAAeC,MAAf,CAAsB,CAACf,OAAO,CAACgB,MAAR,EAAD,CAAtB;AACAlC,EAAAA,CAAC,CAACmC,0BAAF,CAA6B/B,MAA7B,EAAqC,IAAID,WAAJ,CAAgB,IAAIiC,KAAJ,CAAUnC,aAAV,EAAyBoC,IAAzB,CAA8B,OAA9B,CAAhB,CAArC;AACD,CArCH;;AAuCAzC,CAAC,CAACC,IAAF,CAAO,QAAP;AACGC,IADH,CACS,yEADT;AAEGC,EAFH,CAEM,OAAMC,CAAN,KAAW;AACb,QAAMS,MAAM,GAAGT,CAAC,CAACU,MAAF,CAASC,kBAAT,CAA4B;AACzCC,IAAAA,IAAI,EAAG;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAjB+C,EAA5B,CAAf;;;AAoBA,QAAMC,QAAQ,GAAGb,CAAC,CAACU,MAAF,CAAS4B,oBAAT,CAA8B;AAC7CvB,IAAAA,MAAM,EAAE,MADqC;AAE7CwB,IAAAA,MAAM,EAAE,EAAE9B,MAAF,EAAUQ,UAAU,EAAE,OAAtB,EAA+BuB,OAAO,EAAE,EAAxC,EAFqC;AAG7CC,IAAAA,SAAS,EAAE,EAAEC,QAAQ,EAAE,YAAZ,EAHkC;AAI7CC,IAAAA,QAAQ,EAAE;AACRC,MAAAA,OAAO,EAAE,CAAC,EAAEC,MAAM,EAAE,YAAV,EAAD,CADD;AAERpC,MAAAA,MAFQ;AAGRQ,MAAAA,UAAU,EAAE,OAHJ,EAJmC,EAA9B,CAAjB;;;AAUA,QAAM6B,QAAQ,GAAG9C,CAAC,CAACK,sBAAF,CAAyB,IAAIF,WAAJ,CAAgB,CAAC,CAAD,EAAI,CAAJ,CAAhB,CAAzB,EAAkDG,cAAc,CAACyC,OAAjE,CAAjB;AACA,QAAMxB,SAAS,GAAGvB,CAAC,CAACU,MAAF,CAASc,eAAT,CAAyB;AACzCT,IAAAA,MAAM,EAAEF,QAAQ,CAACY,kBAAT,CAA4B,CAA5B,CADiC;AAEzCC,IAAAA,OAAO,EAAE;AACP;AACEC,MAAAA,OAAO,EAAE,CADX;AAEEC,MAAAA,QAAQ,EAAE,EAAExB,MAAM,EAAE0C,QAAV,EAFZ,EADO,CAFgC,EAAzB,CAAlB;;;;AASA,QAAME,YAAY,GAAGhD,CAAC,CAACU,MAAF,CAASuC,aAAT,CAAuB;AAC1CC,IAAAA,IAAI,EAAE,CAAC,CAAD,EAAI,CAAJ,CADoC;AAE1CC,IAAAA,KAAK,EAAEC,eAAe,CAACC,iBAAhB,GAAoCD,eAAe,CAAC5C,QAFjB;AAG1CqC,IAAAA,MAAM,EAAE,YAHkC,EAAvB,CAArB;;AAKA,QAAM3B,OAAO,GAAGlB,CAAC,CAACU,MAAF,CAASS,oBAAT,EAAhB;AACA,QAAMC,IAAI,GAAGF,OAAO,CAACoC,eAAR,CAAwB;AACnCC,IAAAA,gBAAgB,EAAE;AAChB;AACEC,MAAAA,IAAI,EAAER,YAAY,CAACS,UAAb,EADR;AAEEC,MAAAA,UAAU,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV,CAFd;AAGEC,MAAAA,MAAM,EAAE,OAHV;AAIEC,MAAAA,OAAO,EAAE,OAJX,EADgB,CADiB,EAAxB,CAAb;;;;AAUAxC,EAAAA,IAAI,CAACE,WAAL,CAAiBT,QAAjB;AACAO,EAAAA,IAAI,CAACS,YAAL,CAAkB,CAAlB,EAAqBN,SAArB;AACAH,EAAAA,IAAI,CAACyC,IAAL,CAAU,CAAV;AACAzC,EAAAA,IAAI,CAACW,GAAL;AACA/B,EAAAA,CAAC,CAACU,MAAF,CAASsB,KAAT,CAAeC,MAAf,CAAsB,CAACf,OAAO,CAACgB,MAAR,EAAD,CAAtB;AACAlC,EAAAA,CAAC,CAAC8D,4BAAF;AACEd,EAAAA,YADF;AAEE,cAFF;AAGE,IAAEe,CAAC,EAAE,CAAL,EAAQC,CAAC,EAAE,CAAX,EAHF;AAIE;AACEC,IAAAA,GAAG,EAAE,IAAIC,UAAJ,CAAe,CAAC,GAAD,EAAM,GAAN,EAAW,CAAX,EAAc,GAAd,CAAf,CADP,EAJF;;;AAQD,CAxEH;;AA0EAtE,CAAC,CAACC,IAAF,CAAO,UAAP;AACGC,IADH,CACS,2EADT;AAEGC,EAFH,CAEM,OAAMC,CAAN,KAAW;AACb,QAAMS,MAAM,GAAGT,CAAC,CAACU,MAAF,CAASC,kBAAT,CAA4B;AACzCC,IAAAA,IAAI,EAAG;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAjB+C,EAA5B,CAAf;;;AAoBA,QAAMC,QAAQ,GAAGb,CAAC,CAACU,MAAF,CAAS4B,oBAAT,CAA8B;AAC7CvB,IAAAA,MAAM,EAAE,MADqC;AAE7CwB,IAAAA,MAAM,EAAE,EAAE9B,MAAF,EAAUQ,UAAU,EAAE,OAAtB,EAA+BuB,OAAO,EAAE,EAAxC,EAFqC;AAG7CC,IAAAA,SAAS,EAAE,EAAEC,QAAQ,EAAE,YAAZ,EAHkC;AAI7CC,IAAAA,QAAQ,EAAE;AACRC,MAAAA,OAAO,EAAE,CAAC,EAAEC,MAAM,EAAE,YAAV,EAAD,CADD;AAERpC,MAAAA,MAFQ;AAGRQ,MAAAA,UAAU,EAAE,OAHJ,EAJmC,EAA9B,CAAjB;;;AAUA,QAAM6B,QAAQ,GAAG9C,CAAC,CAACK,sBAAF,CAAyB,IAAIF,WAAJ,CAAgB,CAAC,CAAD,EAAI,CAAJ,CAAhB,CAAzB,EAAkDG,cAAc,CAACyC,OAAjE,CAAjB;AACA,QAAMxB,SAAS,GAAGvB,CAAC,CAACU,MAAF,CAASc,eAAT,CAAyB;AACzCT,IAAAA,MAAM,EAAEF,QAAQ,CAACY,kBAAT,CAA4B,CAA5B,CADiC;AAEzCC,IAAAA,OAAO,EAAE;AACP;AACEC,MAAAA,OAAO,EAAE,CADX;AAEEC,MAAAA,QAAQ,EAAE,EAAExB,MAAM,EAAE0C,QAAV,EAFZ,EADO,CAFgC,EAAzB,CAAlB;;;;AASA,QAAME,YAAY,GAAGhD,CAAC,CAACU,MAAF,CAASuC,aAAT,CAAuB;AAC1CC,IAAAA,IAAI,EAAE,CAAC,CAAD,EAAI,CAAJ,CADoC;AAE1CC,IAAAA,KAAK,EAAEC,eAAe,CAACC,iBAAhB,GAAoCD,eAAe,CAAC5C,QAFjB;AAG1CqC,IAAAA,MAAM,EAAE,YAHkC,EAAvB,CAArB;;AAKA,QAAM3B,OAAO,GAAGlB,CAAC,CAACU,MAAF,CAASS,oBAAT,EAAhB;AACA,QAAMC,IAAI,GAAGF,OAAO,CAACoC,eAAR,CAAwB;AACnCC,IAAAA,gBAAgB,EAAE;AAChB;AACEC,MAAAA,IAAI,EAAER,YAAY,CAACS,UAAb,EADR;AAEEC,MAAAA,UAAU,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV,CAFd;AAGEC,MAAAA,MAAM,EAAE,OAHV;AAIEC,MAAAA,OAAO,EAAE,OAJX,EADgB,CADiB,EAAxB,CAAb;;;;AAUAxC,EAAAA,IAAI,CAACE,WAAL,CAAiBT,QAAjB;AACAO,EAAAA,IAAI,CAACS,YAAL,CAAkB,CAAlB,EAAqBN,SAArB;AACAH,EAAAA,IAAI,CAACyC,IAAL,CAAU,CAAV;AACAzC,EAAAA,IAAI,CAACW,GAAL;AACA/B,EAAAA,CAAC,CAACU,MAAF,CAASsB,KAAT,CAAeC,MAAf,CAAsB,CAACf,OAAO,CAACgB,MAAR,EAAD,CAAtB;AACAlC,EAAAA,CAAC,CAAC8D,4BAAF;AACEd,EAAAA,YADF;AAEE,cAFF;AAGE,IAAEe,CAAC,EAAE,CAAL,EAAQC,CAAC,EAAE,CAAX,EAHF;AAIE;AACEC,IAAAA,GAAG,EAAE,IAAIC,UAAJ,CAAe,CAAC,GAAD,EAAM,GAAN,EAAW,CAAX,EAAc,GAAd,CAAf,CADP,EAJF;;;AAQD,CAxEH","sourcesContent":["export const description = `\nStress tests covering robustness in the presence of slow shaders.\n`;\n\nimport { makeTestGroup } from '../../common/framework/test_group.js';\nimport { GPUTest } from '../../webgpu/gpu_test.js';\n\nexport const g = makeTestGroup(GPUTest);\n\ng.test('compute')\n  .desc(`Tests execution of compute passes with very long-running dispatch operations.`)\n  .fn(async t => {\n    const kDispatchSize = 1000;\n    const data = new Uint32Array(kDispatchSize);\n    const buffer = t.makeBufferWithContents(data, GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC);\n    const module = t.device.createShaderModule({\n      code: `\n        struct Buffer { data: array<u32>, };\n        @group(0) @binding(0) var<storage, read_write> buffer: Buffer;\n        @compute @workgroup_size(1) fn main(\n            @builtin(global_invocation_id) id: vec3<u32>) {\n          loop {\n            if (buffer.data[id.x] == 1000000u) {\n              break;\n            }\n            buffer.data[id.x] = buffer.data[id.x] + 1u;\n          }\n        }\n      `,\n    });\n    const pipeline = t.device.createComputePipeline({\n      layout: 'auto',\n      compute: { module, entryPoint: 'main' },\n    });\n    const encoder = t.device.createCommandEncoder();\n    const pass = encoder.beginComputePass();\n    pass.setPipeline(pipeline);\n    const bindGroup = t.device.createBindGroup({\n      layout: pipeline.getBindGroupLayout(0),\n      entries: [{ binding: 0, resource: { buffer } }],\n    });\n    pass.setBindGroup(0, bindGroup);\n    pass.dispatch(kDispatchSize);\n    pass.end();\n    t.device.queue.submit([encoder.finish()]);\n    t.expectGPUBufferValuesEqual(buffer, new Uint32Array(new Array(kDispatchSize).fill(1000000)));\n  });\n\ng.test('vertex')\n  .desc(`Tests execution of render passes with a very long-running vertex stage.`)\n  .fn(async t => {\n    const module = t.device.createShaderModule({\n      code: `\n        struct Data { counter: u32, increment: u32, };\n        @group(0) @binding(0) var<uniform> data: Data;\n        @vertex fn vmain() -> @builtin(position) vec4<f32> {\n          var counter: u32 = data.counter;\n          loop {\n            counter = counter + data.increment;\n            if (counter % 50000000u == 0u) {\n              break;\n            }\n          }\n          return vec4<f32>(1.0, 1.0, 0.0, f32(counter));\n        }\n        @fragment fn fmain() -> @location(0) vec4<f32> {\n          return vec4<f32>(1.0, 1.0, 0.0, 1.0);\n        }\n      `,\n    });\n\n    const pipeline = t.device.createRenderPipeline({\n      layout: 'auto',\n      vertex: { module, entryPoint: 'vmain', buffers: [] },\n      primitive: { topology: 'point-list' },\n      fragment: {\n        targets: [{ format: 'rgba8unorm' }],\n        module,\n        entryPoint: 'fmain',\n      },\n    });\n    const uniforms = t.makeBufferWithContents(new Uint32Array([0, 1]), GPUBufferUsage.UNIFORM);\n    const bindGroup = t.device.createBindGroup({\n      layout: pipeline.getBindGroupLayout(0),\n      entries: [\n        {\n          binding: 0,\n          resource: { buffer: uniforms },\n        },\n      ],\n    });\n    const renderTarget = t.device.createTexture({\n      size: [3, 3],\n      usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n      format: 'rgba8unorm',\n    });\n    const encoder = t.device.createCommandEncoder();\n    const pass = encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: renderTarget.createView(),\n          clearValue: [0, 0, 0, 0],\n          loadOp: 'clear',\n          storeOp: 'store',\n        },\n      ],\n    });\n    pass.setPipeline(pipeline);\n    pass.setBindGroup(0, bindGroup);\n    pass.draw(1);\n    pass.end();\n    t.device.queue.submit([encoder.finish()]);\n    t.expectSinglePixelIn2DTexture(\n      renderTarget,\n      'rgba8unorm',\n      { x: 1, y: 1 },\n      {\n        exp: new Uint8Array([255, 255, 0, 255]),\n      }\n    );\n  });\n\ng.test('fragment')\n  .desc(`Tests execution of render passes with a very long-running fragment stage.`)\n  .fn(async t => {\n    const module = t.device.createShaderModule({\n      code: `\n        struct Data { counter: u32, increment: u32, };\n        @group(0) @binding(0) var<uniform> data: Data;\n        @vertex fn vmain() -> @builtin(position) vec4<f32> {\n          return vec4<f32>(0.0, 0.0, 0.0, 1.0);\n        }\n        @fragment fn fmain() -> @location(0) vec4<f32> {\n          var counter: u32 = data.counter;\n          loop {\n            counter = counter + data.increment;\n            if (counter % 50000000u == 0u) {\n              break;\n            }\n          }\n          return vec4<f32>(1.0, 1.0, 1.0 / f32(counter), 1.0);\n        }\n      `,\n    });\n\n    const pipeline = t.device.createRenderPipeline({\n      layout: 'auto',\n      vertex: { module, entryPoint: 'vmain', buffers: [] },\n      primitive: { topology: 'point-list' },\n      fragment: {\n        targets: [{ format: 'rgba8unorm' }],\n        module,\n        entryPoint: 'fmain',\n      },\n    });\n    const uniforms = t.makeBufferWithContents(new Uint32Array([0, 1]), GPUBufferUsage.UNIFORM);\n    const bindGroup = t.device.createBindGroup({\n      layout: pipeline.getBindGroupLayout(0),\n      entries: [\n        {\n          binding: 0,\n          resource: { buffer: uniforms },\n        },\n      ],\n    });\n    const renderTarget = t.device.createTexture({\n      size: [3, 3],\n      usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n      format: 'rgba8unorm',\n    });\n    const encoder = t.device.createCommandEncoder();\n    const pass = encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: renderTarget.createView(),\n          clearValue: [0, 0, 0, 0],\n          loadOp: 'clear',\n          storeOp: 'store',\n        },\n      ],\n    });\n    pass.setPipeline(pipeline);\n    pass.setBindGroup(0, bindGroup);\n    pass.draw(1);\n    pass.end();\n    t.device.queue.submit([encoder.finish()]);\n    t.expectSinglePixelIn2DTexture(\n      renderTarget,\n      'rgba8unorm',\n      { x: 1, y: 1 },\n      {\n        exp: new Uint8Array([255, 255, 0, 255]),\n      }\n    );\n  });\n"],"file":"slow.spec.js"}