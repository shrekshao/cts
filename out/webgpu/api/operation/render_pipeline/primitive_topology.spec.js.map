{"version":3,"sources":["../../../../../src/webgpu/api/operation/render_pipeline/primitive_topology.spec.ts"],"names":["description","makeTestGroup","GPUTest","kRTSize","kColorFormat","kValidPixelColor","Uint8Array","kInvalidPixelColor","Point2D","constructor","x","y","z","w","toNDC","getMidpoint","a","b","getCentroid","c","VertexLocations","getPointTestLocations","expectedColor","testLocations","location","push","color","getLineTestLocations","getPrimitiveRestartLineTestLocations","getLineStripTestLocations","getTriangleListTestLocations","getTriangleStripTestLocations","generateVertexBuffer","vertexLocations","vertexCoords","Float32Array","length","i","point","PrimitiveTopologyTest","makeAttachmentTexture","device","createTexture","format","size","width","height","depth","usage","GPUTextureUsage","OUTPUT_ATTACHMENT","COPY_SRC","run","primitiveTopology","usePrimitiveRestart","colorAttachment","encoder","createCommandEncoder","renderPass","beginRenderPass","colorAttachments","attachment","createView","loadValue","r","g","indexFormat","undefined","setPipeline","createRenderPipeline","vertexStage","module","createShaderModule","code","entryPoint","fragmentStage","colorStates","vertexState","vertexBuffers","arrayStride","BYTES_PER_ELEMENT","attributes","offset","shaderLocation","vertexBuffer","makeBufferWithContents","GPUBufferUsage","VERTEX","setVertexBuffer","indexBuffer","Uint32Array","INDEX","setIndexBuffer","drawIndexed","draw","endPass","defaultQueue","submit","finish","testPixel","expectSinglePixelIn2DTexture","exp","test","fn","t","concat"],"mappings":"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","sourcesContent":["export const description = `Test primitive topology rendering.\n\nDraw a primitive using 6 vertices with each topology and check if the pixel is covered.\n\nVertex sequence and coordinates are the same for each topology:\n  - Vertex buffer = [v1, v2, v3, v4, v5, v6]\n  - Topology = [point-list, line-list, line-strip, triangle-list, triangle-strip]\n\nTest locations are framebuffer coordinates:\n  - Pixel value { valid: green, invalid: black, format: 'rgba8unorm'}\n  - Test point is valid if the pixel value equals the covered pixel value at the test location.\n  - Primitive restart occurs for strips (line-strip and triangle-strip) between [v3, v4].\n\n  Topology: point-list         Valid test location(s)           Invalid test location(s)\n\n       v2    v4     v6         Every vertex.                    Line-strip locations.\n                                                                Triangle-list locations.\n                                                                Triangle-strip locations.\n\n   v1     v3     v5\n\n  Topology: line-list (3 lines)\n\n       v2    v4     v6         Center of three line segments:   Line-strip locations.\n      *      *      *          {v1,V2}, {v3,v4}, and {v4,v5}.   Triangle-list locations.\n     *      *      *                                            Triangle-strip locations.\n    *      *      *\n   v1     v3     v5\n\n  Topology: line-strip (5 lines)\n\n       v2    v4     v6\n       **    **     *\n      *  *  *  *   *           Line-list locations              Triangle-list locations.\n     *    **     **          + Center of two line segments:     Triangle-strip locations.\n    v1    v3     v5            {v2,v3} and {v4,v5}.\n                                                                With primitive restart:\n                                                                Line segment {v3, v4}.\n\n  Topology: triangle-list (2 triangles)\n\n      v2       v4    v6\n      **        ******         Center of two triangle(s):       Triangle-strip locations.\n     ****        ****          {v1,v2,v3} and {v4,v5,v6}.\n    ******        **\n   v1     v3      v5\n\n  Topology: triangle-strip (4 triangles)\n\n      v2        v4      v6\n      ** ****** ** ******      Triangle-list locations          None.\n     **** **** **** ****     + Center of two triangle(s):\n    ****** ** ****** **        {v2,v3,v4} and {v3,v4,v5}.       With primitive restart:\n   v1       v3        v5                                        Triangle {v2, v3, v4}\n                                                                and {v3, v4, v5}.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { GPUTest } from '../../../gpu_test.js';\n\nconst kRTSize: number = 56;\nconst kColorFormat = 'rgba8unorm';\nconst kValidPixelColor = new Uint8Array([0x00, 0xff, 0x00, 0xff]); // green\nconst kInvalidPixelColor = new Uint8Array([0x00, 0x00, 0x00, 0x00]); // black\n\nclass Point2D {\n  x: number;\n  y: number;\n  z: number;\n  w: number;\n\n  constructor(x: number, y: number) {\n    this.x = x;\n    this.y = y;\n    this.z = 0;\n    this.w = 1;\n  }\n\n  toNDC(): Point2D {\n    // NDC coordinate space is y-up, so we negate the y mapping.\n    // To ensure the resulting vertex in NDC will be placed at the center of the pixel, we\n    // must offset by the pixel coordinates or 0.5.\n    return new Point2D((2 * (this.x + 0.5)) / kRTSize - 1, (-2 * (this.y + 0.5)) / kRTSize + 1);\n  }\n\n  static getMidpoint(a: Point2D, b: Point2D) {\n    return new Point2D((a.x + b.x) / 2, (a.y + b.y) / 2);\n  }\n\n  static getCentroid(a: Point2D, b: Point2D, c: Point2D) {\n    return new Point2D((a.x + b.x + c.x) / 3, (a.y + b.y + c.y) / 3);\n  }\n}\n\ninterface TestLocation {\n  location: Point2D;\n  color: Uint8Array;\n}\n\nconst VertexLocations = [\n  new Point2D(8, 24), // v1\n  new Point2D(16, 8), // v2\n  new Point2D(24, 24), // v3\n  new Point2D(32, 8), // v4\n  new Point2D(40, 24), // v5\n  new Point2D(48, 8), // v6\n];\n\nfunction getPointTestLocations(expectedColor: Uint8Array): TestLocation[] {\n  // Test points are always equal to vertex locations.\n  const testLocations: TestLocation[] = [];\n  for (const location of VertexLocations) {\n    testLocations.push({ location, color: expectedColor });\n  }\n  return testLocations;\n}\n\nfunction getLineTestLocations(expectedColor: Uint8Array): TestLocation[] {\n  // Midpoints of 3 line segments\n  return [\n    {\n      // Line {v1, v2}\n      location: Point2D.getMidpoint(VertexLocations[0], VertexLocations[1]),\n      color: expectedColor,\n    },\n    {\n      // Line {v3, v4}\n      location: Point2D.getMidpoint(VertexLocations[2], VertexLocations[3]),\n      color: expectedColor,\n    },\n    {\n      // Line {v5, v6}\n      location: Point2D.getMidpoint(VertexLocations[4], VertexLocations[5]),\n      color: expectedColor,\n    },\n  ];\n}\n\nfunction getPrimitiveRestartLineTestLocations(expectedColor: Uint8Array): TestLocation[] {\n  // Midpoints of 2 line segments\n  return [\n    {\n      // Line {v1, v2}\n      location: Point2D.getMidpoint(VertexLocations[0], VertexLocations[1]),\n      color: expectedColor,\n    },\n    {\n      // Line {v5, v6}\n      location: Point2D.getMidpoint(VertexLocations[4], VertexLocations[5]),\n      color: expectedColor,\n    },\n  ];\n}\n\nfunction getLineStripTestLocations(expectedColor: Uint8Array): TestLocation[] {\n  // Midpoints of 2 line segments\n  return [\n    {\n      // Line {v2, v3}\n      location: Point2D.getMidpoint(VertexLocations[1], VertexLocations[2]),\n      color: expectedColor,\n    },\n    {\n      // Line {v4, v5}\n      location: Point2D.getMidpoint(VertexLocations[3], VertexLocations[4]),\n      color: expectedColor,\n    },\n  ];\n}\n\nfunction getTriangleListTestLocations(expectedColor: Uint8Array): TestLocation[] {\n  // Center of two triangles\n  return [\n    {\n      // Triangle {v1, v2, v3}\n      location: Point2D.getCentroid(VertexLocations[0], VertexLocations[1], VertexLocations[2]),\n      color: expectedColor,\n    },\n    {\n      // Triangle {v4, v5, v6}\n      location: Point2D.getCentroid(VertexLocations[3], VertexLocations[4], VertexLocations[5]),\n      color: expectedColor,\n    },\n  ];\n}\n\nfunction getTriangleStripTestLocations(expectedColor: Uint8Array): TestLocation[] {\n  // Center of two triangles\n  return [\n    {\n      // Triangle {v2, v3, v4}\n      location: Point2D.getCentroid(VertexLocations[1], VertexLocations[2], VertexLocations[3]),\n      color: expectedColor,\n    },\n    {\n      // Triangle {v3, v4, v5}\n      location: Point2D.getCentroid(VertexLocations[2], VertexLocations[3], VertexLocations[4]),\n      color: expectedColor,\n    },\n  ];\n}\n\nfunction generateVertexBuffer(vertexLocations: Point2D[]): Float32Array {\n  const vertexCoords = new Float32Array(vertexLocations.length * 4);\n  for (let i = 0; i < vertexLocations.length; i++) {\n    const point = vertexLocations[i].toNDC();\n    vertexCoords[i * 4 + 0] = point.x;\n    vertexCoords[i * 4 + 1] = point.y;\n    vertexCoords[i * 4 + 2] = point.z;\n    vertexCoords[i * 4 + 3] = point.w;\n  }\n  return vertexCoords;\n}\n\nclass PrimitiveTopologyTest extends GPUTest {\n  makeAttachmentTexture(): GPUTexture {\n    return this.device.createTexture({\n      format: kColorFormat,\n      size: { width: kRTSize, height: kRTSize, depth: 1 },\n      usage: GPUTextureUsage.OUTPUT_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n    });\n  }\n\n  run(\n    primitiveTopology: GPUPrimitiveTopology,\n    testLocations: TestLocation[],\n    usePrimitiveRestart: boolean\n  ): void {\n    const colorAttachment = this.makeAttachmentTexture();\n\n    // Color load operator will clear color attachment to zero.\n    const encoder = this.device.createCommandEncoder();\n    const renderPass = encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          attachment: colorAttachment.createView(),\n          loadValue: { r: 0.0, g: 0.0, b: 0.0, a: 0.0 },\n        },\n      ],\n    });\n\n    let indexFormat = undefined;\n    if (primitiveTopology === 'triangle-strip' || primitiveTopology === 'line-strip') {\n      indexFormat = 'uint32' as const;\n    }\n\n    // Draw a primitive using 6 vertices based on the type.\n    // Pixels are generated based on vertex position.\n    // If point, 1 pixel is generated at each vertex location.\n    // Otherwise, >1 pixels could be generated.\n    // Output color is solid green.\n    renderPass.setPipeline(\n      this.device.createRenderPipeline({\n        vertexStage: {\n          module: this.device.createShaderModule({\n            code: `\n              [[location(0)]] var<in> pos : vec4<f32>;\n              [[builtin(position)]] var<out> Position : vec4<f32>;\n\n              [[stage(vertex)]] fn main() -> void {\n                Position = pos;\n                return;\n              }`,\n          }),\n          entryPoint: 'main',\n        },\n        fragmentStage: {\n          module: this.device.createShaderModule({\n            code: `\n              [[location(0)]] var<out> fragColor : vec4<f32>;\n              [[stage(fragment)]] fn main() -> void {\n                fragColor = vec4<f32>(0.0, 1.0, 0.0, 1.0);\n                return;\n              }`,\n          }),\n          entryPoint: 'main',\n        },\n        primitiveTopology,\n        colorStates: [{ format: kColorFormat }],\n        vertexState: {\n          indexFormat,\n          vertexBuffers: [\n            {\n              arrayStride: 4 * Float32Array.BYTES_PER_ELEMENT,\n              attributes: [\n                {\n                  format: 'float4',\n                  offset: 0,\n                  shaderLocation: 0,\n                },\n              ],\n            },\n          ],\n        },\n      })\n    );\n\n    // Create vertices for the primitive in a vertex buffer and bind it.\n    const vertexCoords = generateVertexBuffer(VertexLocations);\n    const vertexBuffer = this.makeBufferWithContents(vertexCoords, GPUBufferUsage.VERTEX);\n    renderPass.setVertexBuffer(0, vertexBuffer);\n\n    // Restart the strip between [v3, <restart>, v4].\n    if (usePrimitiveRestart) {\n      const indexBuffer = this.makeBufferWithContents(\n        new Uint32Array([0, 1, 2, -1, 3, 4, 5]),\n        GPUBufferUsage.INDEX\n      );\n      renderPass.setIndexBuffer(indexBuffer, 'uint32');\n      renderPass.drawIndexed(7); // extra index for restart\n    } else {\n      renderPass.draw(6);\n    }\n\n    renderPass.endPass();\n\n    this.device.defaultQueue.submit([encoder.finish()]);\n\n    for (const testPixel of testLocations) {\n      this.expectSinglePixelIn2DTexture(\n        colorAttachment,\n        kColorFormat,\n        { x: testPixel.location.x, y: testPixel.location.y },\n        { exp: testPixel.color }\n      );\n    }\n  }\n}\n\nexport const g = makeTestGroup(PrimitiveTopologyTest);\n\n// Compute test locations for valid and invalid pixels for each topology.\n// If the primitive covers the pixel, the color value will be |kValidPixelColor|.\n// Otherwise, a non-covered pixel will be |kInvalidPixelColor|.\ng.test('render_pipeline,primitive_topology_point_list').fn(async t => {\n  // Check valid test locations\n  const testLocations = getPointTestLocations(kValidPixelColor);\n\n  // Check invalid test locations\n  testLocations.concat(getLineStripTestLocations(kInvalidPixelColor));\n  testLocations.concat(getTriangleListTestLocations(kInvalidPixelColor));\n  testLocations.concat(getTriangleStripTestLocations(kInvalidPixelColor));\n\n  t.run('point-list', testLocations, /*usePrimitiveRestart=*/ false);\n});\n\ng.test('render_pipeline,primitive_topology_line_list').fn(async t => {\n  // Check valid test locations\n  const testLocations = getLineTestLocations(kValidPixelColor);\n\n  // Check invalid test locations\n  testLocations.concat(getLineStripTestLocations(kInvalidPixelColor));\n  testLocations.concat(getTriangleListTestLocations(kInvalidPixelColor));\n  testLocations.concat(getTriangleStripTestLocations(kInvalidPixelColor));\n  t.run('line-list', testLocations, /*usePrimitiveRestart=*/ false);\n});\n\ng.test('render_pipeline,primitive_topology_line_strip').fn(async t => {\n  // Check valid test locations\n  const testLocations = getLineTestLocations(kValidPixelColor);\n  testLocations.concat(getLineStripTestLocations(kValidPixelColor));\n\n  // Check invalid test locations\n  testLocations.concat(getTriangleListTestLocations(kInvalidPixelColor));\n  testLocations.concat(getTriangleStripTestLocations(kInvalidPixelColor));\n\n  t.run('line-strip', testLocations, /*usePrimitiveRestart=*/ false);\n});\n\ng.test('render_pipeline,primitive_topology_line_strip,primitive_restart').fn(async t => {\n  // Check valid test locations\n  const testLocations = getPrimitiveRestartLineTestLocations(kValidPixelColor);\n  testLocations.concat(getLineStripTestLocations(kValidPixelColor));\n\n  // Check invalid test locations\n  testLocations.concat(getTriangleListTestLocations(kInvalidPixelColor));\n  testLocations.concat(getTriangleStripTestLocations(kInvalidPixelColor));\n\n  t.run('line-strip', testLocations, /*usePrimitiveRestart=*/ true);\n});\n\ng.test('render_pipeline,primitive_topology_triangle_list').fn(async t => {\n  // Check valid test locations\n  const testLocations = getTriangleListTestLocations(kValidPixelColor);\n\n  // Check invalid test locations\n  testLocations.concat(getTriangleStripTestLocations(kInvalidPixelColor));\n\n  t.run('triangle-list', testLocations, /*usePrimitiveRestart=*/ false);\n});\n\ng.test('render_pipeline,primitive_topology_triangle_strip').fn(async t => {\n  // Check valid test locations\n  const testLocations = getTriangleListTestLocations(kValidPixelColor);\n  testLocations.concat(getTriangleStripTestLocations(kValidPixelColor));\n\n  t.run('triangle-strip', testLocations, /*usePrimitiveRestart=*/ false);\n});\n\ng.test('render_pipeline,primitive_topology_triangle_strip,primitive_restart').fn(async t => {\n  // Check valid test locations\n  const testLocations = getTriangleListTestLocations(kValidPixelColor);\n  testLocations.concat(getTriangleStripTestLocations(kInvalidPixelColor));\n\n  t.run('triangle-strip', testLocations, /*usePrimitiveRestart=*/ true);\n});\n"],"file":"primitive_topology.spec.js"}