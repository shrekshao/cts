{"version":3,"sources":["../../../../../../src/webgpu/api/operation/command_buffer/render/state_tracking.spec.ts"],"names":["description","makeTestGroup","GPUTest","VertexAndIndexStateTrackingTest","GetRenderPipelineForTest","device","createRenderPipeline","vertex","module","createShaderModule","code","entryPoint","buffers","arrayStride","kVertexAttributeSize","attributes","format","offset","shaderLocation","fragment","targets","primitive","topology","g","test","desc","fn","t","indexBuffer","makeBufferWithContents","Uint16Array","GPUBufferUsage","INDEX","kVertexAttributesCount","vertexBuffer","createBuffer","usage","VERTEX","size","mappedAtCreation","trackForCleanup","vertexAttributes","getMappedRange","kPositions","kColors","Uint8Array","i","length","baseOffset","vertexPosition","Float32Array","vertexColor","set","lastOffset","lastVertexPosition","lastVertexColor","unmap","renderPipeline","outputTexture","createTexture","GPUTextureUsage","COPY_SRC","RENDER_ATTACHMENT","encoder","createCommandEncoder","renderPass","beginRenderPass","colorAttachments","view","createView","loadValue","storeOp","setPipeline","setVertexBuffer","setIndexBuffer","drawIndexed","endPass","queue","submit","finish","expectedColor","expectSinglePixelIn2DTexture","x","y","exp","draw"],"mappings":"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","sourcesContent":["export const description = `\nEnsure state is set correctly. Tries to stress state caching (setting different states multiple\ntimes in different orders) for setIndexBuffer and setVertexBuffer.\nEquivalent tests for setBindGroup and setPipeline are in programmable/state_tracking.spec.ts.\nEquivalent tests for viewport/scissor/blend/reference are in render/dynamic_state.spec.ts\n\nTODO: plan and implement\n- try changing the pipeline {before,after} the vertex/index buffers.\n  (In D3D12, the vertex buffer stride is part of SetVertexBuffer instead of the pipeline.)\n- Test that drawing after having set vertex buffer slots not used by the pipeline.\n- Test that setting / not setting the index buffer does not impact a non-indexed draw.\n`;\n\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\nimport { GPUTest } from '../../../../gpu_test.js';\n\nclass VertexAndIndexStateTrackingTest extends GPUTest {\n  GetRenderPipelineForTest(): GPURenderPipeline {\n    return this.device.createRenderPipeline({\n      vertex: {\n        module: this.device.createShaderModule({\n          code: `\n        struct Inputs {\n          [[location(0)]] vertexPosition : f32;\n          [[location(1)]] vertexColor : vec4<f32>;\n        };\n        struct Outputs {\n          [[builtin(position)]] position : vec4<f32>;\n          [[location(0)]] color : vec4<f32>;\n        };\n        [[stage(vertex)]]\n        fn main(input : Inputs)-> Outputs {\n          var outputs : Outputs;\n          outputs.position =\n            vec4<f32>(input.vertexPosition, 0.5, 0.0, 1.0);\n          outputs.color = input.vertexColor;\n          return outputs;\n        }`,\n        }),\n        entryPoint: 'main',\n        buffers: [\n          {\n            arrayStride: this.kVertexAttributeSize,\n            attributes: [\n              {\n                format: 'float32',\n                offset: 0,\n                shaderLocation: 0,\n              },\n              {\n                format: 'unorm8x4',\n                offset: 4,\n                shaderLocation: 1,\n              },\n            ],\n          },\n        ],\n      },\n      fragment: {\n        module: this.device.createShaderModule({\n          code: `\n        struct Input {\n          [[location(0)]] color : vec4<f32>;\n        };\n        [[stage(fragment)]]\n        fn main(input : Input) -> [[location(0)]] vec4<f32> {\n          return input.color;\n        }`,\n        }),\n        entryPoint: 'main',\n        targets: [{ format: 'rgba8unorm' }],\n      },\n      primitive: {\n        topology: 'point-list',\n      },\n    });\n  }\n\n  kVertexAttributeSize = 8;\n}\n\nexport const g = makeTestGroup(VertexAndIndexStateTrackingTest);\n\ng.test('set_index_buffer_without_changing_buffer')\n  .desc(\n    `\n  Test that setting index buffer states (index format, offset, size) multiple times in different\n  orders still keeps the correctness of each draw call.\n`\n  )\n  .fn(async t => {\n    // Initialize the index buffer with 5 uint16 indices (0, 1, 2, 3, 4).\n    const indexBuffer = t.makeBufferWithContents(\n      new Uint16Array([0, 1, 2, 3, 4]),\n      GPUBufferUsage.INDEX\n    );\n\n    // Initialize the vertex buffer with required vertex attributes (position: f32, color: f32x4)\n    // Note that the maximum index in the test is 0x10000.\n    const kVertexAttributesCount = 0x10000 + 1;\n    const vertexBuffer = t.device.createBuffer({\n      usage: GPUBufferUsage.VERTEX,\n      size: t.kVertexAttributeSize * kVertexAttributesCount,\n      mappedAtCreation: true,\n    });\n    t.trackForCleanup(vertexBuffer);\n    const vertexAttributes = vertexBuffer.getMappedRange();\n    const kPositions = [-0.8, -0.4, 0.0, 0.4, 0.8, -0.4];\n    const kColors = [\n      new Uint8Array([255, 0, 0, 255]),\n      new Uint8Array([255, 255, 255, 255]),\n      new Uint8Array([0, 0, 255, 255]),\n      new Uint8Array([255, 0, 255, 255]),\n      new Uint8Array([0, 255, 255, 255]),\n      new Uint8Array([0, 255, 0, 255]),\n    ];\n    // Set vertex attributes at index {0..4} in Uint16.\n    // Note that the vertex attribute at index 1 will not be used.\n    for (let i = 0; i < kPositions.length - 1; ++i) {\n      const baseOffset = t.kVertexAttributeSize * i;\n      const vertexPosition = new Float32Array(vertexAttributes, baseOffset, 1);\n      vertexPosition[0] = kPositions[i];\n      const vertexColor = new Uint8Array(vertexAttributes, baseOffset + 4, 4);\n      vertexColor.set(kColors[i]);\n    }\n    // Set vertex attributes at index 0x10000.\n    const lastOffset = t.kVertexAttributeSize * (kVertexAttributesCount - 1);\n    const lastVertexPosition = new Float32Array(vertexAttributes, lastOffset, 1);\n    lastVertexPosition[0] = kPositions[kPositions.length - 1];\n    const lastVertexColor = new Uint8Array(vertexAttributes, lastOffset + 4, 4);\n    lastVertexColor.set(kColors[kColors.length - 1]);\n\n    vertexBuffer.unmap();\n\n    const renderPipeline = t.GetRenderPipelineForTest();\n\n    const outputTexture = t.device.createTexture({\n      format: 'rgba8unorm',\n      size: [kPositions.length - 1, 1, 1],\n      usage: GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    const encoder = t.device.createCommandEncoder();\n    const renderPass = encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: outputTexture.createView(),\n          loadValue: [0, 0, 0, 1],\n          storeOp: 'store',\n        },\n      ],\n    });\n    renderPass.setPipeline(renderPipeline);\n    renderPass.setVertexBuffer(0, vertexBuffer);\n\n    // 1st draw: indexFormat = 'uint32', offset = 0, size = 4 (index value: 0x10000)\n    renderPass.setIndexBuffer(indexBuffer, 'uint32', 0, 4);\n    renderPass.drawIndexed(1);\n\n    // 2nd draw: indexFormat = 'uint16', offset = 0, size = 4 (index value: 0)\n    renderPass.setIndexBuffer(indexBuffer, 'uint16', 0, 4);\n    renderPass.drawIndexed(1);\n\n    // 3rd draw: indexFormat = 'uint16', offset = 4, size = 2 (index value: 2)\n    renderPass.setIndexBuffer(indexBuffer, 'uint16', 0, 2);\n    renderPass.setIndexBuffer(indexBuffer, 'uint16', 4, 2);\n    renderPass.drawIndexed(1);\n\n    // 4th draw: indexformat = 'uint16', offset = 6, size = 4 (index values: 3, 4)\n    renderPass.setIndexBuffer(indexBuffer, 'uint16', 6, 2);\n    renderPass.setIndexBuffer(indexBuffer, 'uint16', 6, 4);\n    renderPass.drawIndexed(2);\n\n    renderPass.endPass();\n    t.queue.submit([encoder.finish()]);\n\n    for (let i = 0; i < kPositions.length - 1; ++i) {\n      const expectedColor = i === 1 ? kColors[kPositions.length - 1] : kColors[i];\n      t.expectSinglePixelIn2DTexture(\n        outputTexture,\n        'rgba8unorm',\n        { x: i, y: 0 },\n        { exp: expectedColor }\n      );\n    }\n  });\n\ng.test('set_vertex_buffer_without_changing_buffer')\n  .desc(\n    `\n  Test that setting vertex buffer states (offset, size) multiple times in different orders still\n  keeps the correctness of each draw call.\n  - Tries several different sequences of setVertexBuffer+draw commands, each of which draws vertices\n    in all 4 output pixels, and check they were drawn correctly.\n`\n  )\n  .fn(async t => {\n    const kPositions = [-0.875, -0.625, -0.375, -0.125, 0.125, 0.375, 0.625, 0.875];\n    const kColors = [\n      new Uint8Array([255, 0, 0, 255]),\n      new Uint8Array([0, 255, 0, 255]),\n      new Uint8Array([0, 0, 255, 255]),\n      new Uint8Array([51, 0, 0, 255]),\n      new Uint8Array([0, 51, 0, 255]),\n      new Uint8Array([0, 0, 51, 255]),\n      new Uint8Array([255, 0, 255, 255]),\n      new Uint8Array([255, 255, 0, 255]),\n    ];\n\n    // Initialize the vertex buffer with required vertex attributes (position: f32, color: f32x4)\n    const kVertexAttributesCount = 8;\n    const vertexBuffer = t.device.createBuffer({\n      usage: GPUBufferUsage.VERTEX,\n      size: t.kVertexAttributeSize * kVertexAttributesCount,\n      mappedAtCreation: true,\n    });\n    t.trackForCleanup(vertexBuffer);\n    const vertexAttributes = vertexBuffer.getMappedRange();\n    for (let i = 0; i < kPositions.length; ++i) {\n      const baseOffset = t.kVertexAttributeSize * i;\n      const vertexPosition = new Float32Array(vertexAttributes, baseOffset, 1);\n      vertexPosition[0] = kPositions[i];\n      const vertexColor = new Uint8Array(vertexAttributes, baseOffset + 4, 4);\n      vertexColor.set(kColors[i]);\n    }\n\n    vertexBuffer.unmap();\n\n    const renderPipeline = t.GetRenderPipelineForTest();\n\n    const outputTexture = t.device.createTexture({\n      format: 'rgba8unorm',\n      size: [kPositions.length, 1, 1],\n      usage: GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    const encoder = t.device.createCommandEncoder();\n    const renderPass = encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: outputTexture.createView(),\n          loadValue: [0, 0, 0, 1],\n          storeOp: 'store',\n        },\n      ],\n    });\n    renderPass.setPipeline(renderPipeline);\n\n    // Change 'size' in setVertexBuffer()\n    renderPass.setVertexBuffer(0, vertexBuffer, 0, t.kVertexAttributeSize);\n    renderPass.setVertexBuffer(0, vertexBuffer, 0, t.kVertexAttributeSize * 2);\n    renderPass.draw(2);\n\n    // Change 'offset' in setVertexBuffer()\n    renderPass.setVertexBuffer(\n      0,\n      vertexBuffer,\n      t.kVertexAttributeSize * 2,\n      t.kVertexAttributeSize * 2\n    );\n    renderPass.draw(2);\n\n    // Change 'size' again in setVertexBuffer()\n    renderPass.setVertexBuffer(\n      0,\n      vertexBuffer,\n      t.kVertexAttributeSize * 4,\n      t.kVertexAttributeSize * 2\n    );\n    renderPass.setVertexBuffer(\n      0,\n      vertexBuffer,\n      t.kVertexAttributeSize * 4,\n      t.kVertexAttributeSize * 4\n    );\n    renderPass.draw(4);\n\n    renderPass.endPass();\n    t.queue.submit([encoder.finish()]);\n\n    for (let i = 0; i < kPositions.length; ++i) {\n      t.expectSinglePixelIn2DTexture(\n        outputTexture,\n        'rgba8unorm',\n        { x: i, y: 0 },\n        { exp: kColors[i] }\n      );\n    }\n  });\n"],"file":"state_tracking.spec.js"}