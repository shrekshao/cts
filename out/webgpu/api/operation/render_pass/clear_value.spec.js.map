{"version":3,"sources":["../../../../../src/webgpu/api/operation/render_pass/clear_value.spec.ts"],"names":["description","makeTestGroup","assert","kTextureFormatInfo","kDepthStencilFormats","depthStencilFormatAspectSize","GPUTest","g","test","desc","unimplemented","params","u","combine","filter","t","stencilFormat","stencil","beforeAllSubcases","info","selectDeviceOrSkipTestCase","feature","fn","stencilClearValue","applyStencilClearValueAsStencilReferenceValue","kSize","colorFormat","stencilTexture","device","createTexture","format","size","usage","GPUTextureUsage","RENDER_ATTACHMENT","COPY_SRC","colorTexture","renderPipeline","createRenderPipeline","layout","vertex","module","createShaderModule","code","entryPoint","fragment","targets","depthStencil","depthCompare","stencilFront","compare","stencilBack","primitive","topology","stencilAspectSizeInBytes","expectedStencilValue","stencilReference","encoder","createCommandEncoder","depthStencilAttachment","view","createView","stencilLoadOp","stencilStoreOp","depth","depthClearValue","depthLoadOp","depthStoreOp","renderPassEncoder","beginRenderPass","colorAttachments","loadOp","storeOp","clearValue","setPipeline","setStencilReference","draw","end","destinationBuffer","createBuffer","GPUBufferUsage","COPY_DST","trackForCleanup","copyTextureToBuffer","texture","aspect","buffer","queue","submit","finish","expectSingleColor","exp","R","G","B","A","expectGPUBufferValuesEqual","Uint8Array"],"mappings":"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","sourcesContent":["export const description = `\nTests for render pass clear values.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { assert } from '../../../../common/util/util.js';\nimport {\n  kTextureFormatInfo,\n  kDepthStencilFormats,\n  depthStencilFormatAspectSize,\n} from '../../../capability_info.js';\nimport { GPUTest } from '../../../gpu_test.js';\n\nexport const g = makeTestGroup(GPUTest);\n\ng.test('stored')\n  .desc(`Test render pass clear values are stored at the end of an empty pass.`)\n  .unimplemented();\n\ng.test('loaded')\n  .desc(\n    `Test render pass clear values are visible during the pass by doing some trivial blending\nwith the attachment (e.g. add [0,0,0,0] to the color and verify the stored result).`\n  )\n  .unimplemented();\n\ng.test('srgb')\n  .desc(\n    `Test that clear values on '-srgb' type attachments are interpreted as unencoded (linear),\nnot decoded from srgb to linear.`\n  )\n  .unimplemented();\n\ng.test('layout')\n  .desc(\n    `Test that bind group layouts of the default pipeline layout are correct by passing various\nshaders and then checking their computed bind group layouts are compatible with particular bind\ngroups.`\n  )\n  .unimplemented();\n\ng.test('stencil_clear_value')\n  .desc(\n    `Test that when stencilLoadOp is \"clear\", the stencil aspect should be correctly cleared by\n     GPURenderPassDepthStencilAttachment.stencilClearValue, which will be converted to the type of\n     the stencil aspect of view by taking the same number of LSBs as the number of bits in the\n     stencil aspect of one texel block of view.`\n  )\n  .params(u =>\n    u\n      .combine('stencilFormat', kDepthStencilFormats)\n      .combine('stencilClearValue', [0, 1, 0xff, 0x100 + 2, 0x10000 + 3])\n      .combine('applyStencilClearValueAsStencilReferenceValue', [true, false])\n      .filter(t => kTextureFormatInfo[t.stencilFormat].stencil)\n  )\n  .beforeAllSubcases(t => {\n    const { stencilFormat } = t.params;\n    const info = kTextureFormatInfo[stencilFormat];\n    t.selectDeviceOrSkipTestCase(info.feature);\n  })\n  .fn(async t => {\n    const {\n      stencilFormat,\n      stencilClearValue,\n      applyStencilClearValueAsStencilReferenceValue,\n    } = t.params;\n\n    const kSize = [1, 1, 1] as const;\n    const colorFormat = 'rgba8unorm';\n    const stencilTexture = t.device.createTexture({\n      format: stencilFormat,\n      size: kSize,\n      usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n    });\n    const colorTexture = t.device.createTexture({\n      format: colorFormat,\n      size: kSize,\n      usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n    });\n    const renderPipeline = t.device.createRenderPipeline({\n      layout: 'auto',\n      vertex: {\n        module: t.device.createShaderModule({\n          code: `\n            @vertex\n            fn main(@builtin(vertex_index) VertexIndex : u32)-> @builtin(position) vec4<f32> {\n              var pos : array<vec2<f32>, 6> = array<vec2<f32>, 6>(\n                  vec2<f32>(-1.0,  1.0),\n                  vec2<f32>(-1.0, -1.0),\n                  vec2<f32>( 1.0,  1.0),\n                  vec2<f32>(-1.0, -1.0),\n                  vec2<f32>( 1.0,  1.0),\n                  vec2<f32>( 1.0, -1.0));\n              return vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n            }`,\n        }),\n        entryPoint: 'main',\n      },\n      fragment: {\n        module: t.device.createShaderModule({\n          code: `\n            @fragment\n            fn main() -> @location(0) vec4<f32> {\n              return vec4<f32>(0.0, 1.0, 0.0, 1.0);\n            }`,\n        }),\n        entryPoint: 'main',\n        targets: [{ format: colorFormat }],\n      },\n      depthStencil: {\n        format: stencilFormat,\n        depthCompare: 'always',\n        stencilFront: {\n          compare: 'equal',\n        },\n        stencilBack: {\n          compare: 'equal',\n        },\n      },\n      primitive: {\n        topology: 'triangle-list',\n      },\n    });\n\n    const stencilAspectSizeInBytes = depthStencilFormatAspectSize(stencilFormat, 'stencil-only');\n    assert(stencilAspectSizeInBytes > 0);\n    const expectedStencilValue = stencilClearValue & ((stencilAspectSizeInBytes << 8) - 1);\n\n    // StencilReference used in setStencilReference will also be masked to the lowest valid bits, so\n    // no matter what we set in the rest high bits that will be masked out (different or same\n    // between stencilClearValue and stencilReference), the test will pass if and only if the valid\n    // lowest bits are the same.\n    const stencilReference = applyStencilClearValueAsStencilReferenceValue\n      ? stencilClearValue\n      : expectedStencilValue;\n\n    const encoder = t.device.createCommandEncoder();\n\n    const depthStencilAttachment: GPURenderPassDepthStencilAttachment = {\n      view: stencilTexture.createView(),\n      stencilLoadOp: 'clear',\n      stencilStoreOp: 'store',\n      stencilClearValue,\n    };\n    if (kTextureFormatInfo[stencilFormat].depth) {\n      depthStencilAttachment.depthClearValue = 0;\n      depthStencilAttachment.depthLoadOp = 'clear';\n      depthStencilAttachment.depthStoreOp = 'store';\n    }\n    const renderPassEncoder = encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: colorTexture.createView(),\n          loadOp: 'clear',\n          storeOp: 'store',\n          clearValue: [1, 0, 0, 1] as const,\n        },\n      ],\n      depthStencilAttachment,\n    });\n    renderPassEncoder.setPipeline(renderPipeline);\n    renderPassEncoder.setStencilReference(stencilReference);\n    renderPassEncoder.draw(6);\n    renderPassEncoder.end();\n\n    const destinationBuffer = t.device.createBuffer({\n      usage: GPUBufferUsage.COPY_SRC | GPUBufferUsage.COPY_DST,\n      size: 4,\n    });\n    t.trackForCleanup(destinationBuffer);\n    encoder.copyTextureToBuffer(\n      {\n        texture: stencilTexture,\n        aspect: 'stencil-only',\n      },\n      {\n        buffer: destinationBuffer,\n      },\n      [1, 1, 1]\n    );\n\n    t.queue.submit([encoder.finish()]);\n\n    t.expectSingleColor(colorTexture, colorFormat, {\n      size: [1, 1, 1],\n      exp: { R: 0, G: 1, B: 0, A: 1 },\n    });\n    t.expectGPUBufferValuesEqual(destinationBuffer, new Uint8Array([expectedStencilValue]));\n  });\n"],"file":"clear_value.spec.js"}