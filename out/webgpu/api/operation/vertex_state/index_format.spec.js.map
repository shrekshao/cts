{"version":3,"sources":["../../../../../src/webgpu/api/operation/vertex_state/index_format.spec.ts"],"names":["description","makeTestGroup","GPUTest","getTextureCopyLayout","kHeight","kWidth","kTextureFormat","kBottomLeftTriangle","kSquare","kNothing","byteLength","bytesPerRow","rowsPerImage","IndexFormatTest","MakeRenderPipeline","topology","stripIndexFormat","vertexModule","device","createShaderModule","code","fragmentModule","createRenderPipeline","layout","createPipelineLayout","bindGroupLayouts","vertex","module","entryPoint","fragment","targets","format","primitive","CreateIndexBuffer","indices","indexFormat","typedArrayConstructor","uint16","Uint16Array","uint32","Uint32Array","indexBuffer","createBuffer","size","length","BYTES_PER_ELEMENT","usage","GPUBufferUsage","INDEX","mappedAtCreation","getMappedRange","set","unmap","run","indexCount","indexOffset","primitiveTopology","pipeline","colorAttachment","createTexture","width","height","depthOrArrayLayers","GPUTextureUsage","COPY_SRC","RENDER_ATTACHMENT","result","COPY_DST","encoder","createCommandEncoder","pass","beginRenderPass","colorAttachments","view","createView","loadValue","storeOp","setPipeline","setIndexBuffer","drawIndexed","endPass","copyTextureToBuffer","texture","buffer","queue","submit","finish","CreateExpectedUint8Array","renderShape","arrayBuffer","Uint8Array","row","col","texel","kBytesPerTexel","byteOffset","g","test","desc","paramsSubcasesOnly","_expectedShape","fn","t","params","expectedTextureValues","expectGPUBufferValuesEqual","u","combine","combineWithParams","_indices"],"mappings":"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","sourcesContent":["export const description = `\nTest indexing, index format and primitive restart.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { GPUTest } from '../../../gpu_test.js';\nimport { getTextureCopyLayout } from '../../../util/texture/layout.js';\n\nconst kHeight = 4;\nconst kWidth = 8;\nconst kTextureFormat = 'r8uint' as const;\n\n/** 4x4 grid of r8uint values (each 0 or 1). */\ntype Raster8x4 = readonly [\n  readonly [0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1],\n  readonly [0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1],\n  readonly [0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1],\n  readonly [0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1, 0 | 1]\n];\n\n/** Expected 4x4 rasterization of a bottom-left triangle. */\nconst kBottomLeftTriangle: Raster8x4 = [\n  [0, 0, 0, 0, 0, 0, 0, 0],\n  [0, 0, 0, 0, 1, 0, 0, 0],\n  [0, 0, 0, 0, 1, 1, 0, 0],\n  [0, 0, 0, 0, 1, 1, 1, 0],\n];\n\n/** Expected 4x4 rasterization filling the whole quad. */\nconst kSquare: Raster8x4 = [\n  [0, 0, 0, 0, 1, 1, 1, 1],\n  [0, 0, 0, 0, 1, 1, 1, 1],\n  [0, 0, 0, 0, 1, 1, 1, 1],\n  [0, 0, 0, 0, 1, 1, 1, 1],\n];\n\n/** Expected 4x4 rasterization with no pixels. */\nconst kNothing: Raster8x4 = [\n  [0, 0, 0, 0, 0, 0, 0, 0],\n  [0, 0, 0, 0, 0, 0, 0, 0],\n  [0, 0, 0, 0, 0, 0, 0, 0],\n  [0, 0, 0, 0, 0, 0, 0, 0],\n];\n\nconst { byteLength, bytesPerRow, rowsPerImage } = getTextureCopyLayout(kTextureFormat, '2d', [\n  kWidth,\n  kHeight,\n  1,\n]);\n\nclass IndexFormatTest extends GPUTest {\n  MakeRenderPipeline(\n    topology: GPUPrimitiveTopology,\n    stripIndexFormat?: GPUIndexFormat\n  ): GPURenderPipeline {\n    const vertexModule = this.device.createShaderModule({\n      // TODO?: These positions will create triangles that cut right through pixel centers. If this\n      // results in different rasterization results on different hardware, tweak to avoid this.\n      code: `\n        let pos: array<vec2<f32>, 4> = array<vec2<f32>, 4>(\n          vec2<f32>(0.01,  0.98),\n          vec2<f32>(0.99, -0.98),\n          vec2<f32>(0.99,  0.98),\n          vec2<f32>(0.01, -0.98));\n\n        [[stage(vertex)]]\n        fn main([[builtin(vertex_index)]] VertexIndex : u32)\n             -> [[builtin(position)]] vec4<f32> {\n          var Position : vec4<f32>;\n          if (VertexIndex == 0xFFFFu || VertexIndex == 0xFFFFFFFFu) {\n            Position = vec4<f32>(-0.99, -0.98, 0.0, 1.0);\n          } else {\n            Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n          }\n          return Position;\n        }\n      `,\n    });\n\n    const fragmentModule = this.device.createShaderModule({\n      code: `\n        [[stage(fragment)]]\n        fn main() -> [[location(0)]] u32 {\n          return 1u;\n        }\n      `,\n    });\n\n    return this.device.createRenderPipeline({\n      layout: this.device.createPipelineLayout({ bindGroupLayouts: [] }),\n      vertex: { module: vertexModule, entryPoint: 'main' },\n      fragment: {\n        module: fragmentModule,\n        entryPoint: 'main',\n        targets: [{ format: kTextureFormat }],\n      },\n      primitive: {\n        topology,\n        stripIndexFormat,\n      },\n    });\n  }\n\n  CreateIndexBuffer(indices: readonly number[], indexFormat: GPUIndexFormat): GPUBuffer {\n    const typedArrayConstructor = { uint16: Uint16Array, uint32: Uint32Array }[indexFormat];\n\n    const indexBuffer = this.device.createBuffer({\n      size: indices.length * typedArrayConstructor.BYTES_PER_ELEMENT,\n      usage: GPUBufferUsage.INDEX,\n      mappedAtCreation: true,\n    });\n\n    new typedArrayConstructor(indexBuffer.getMappedRange()).set(indices);\n\n    indexBuffer.unmap();\n    return indexBuffer;\n  }\n\n  run(\n    indexBuffer: GPUBuffer,\n    indexCount: number,\n    indexFormat: GPUIndexFormat,\n    indexOffset: number = 0,\n    primitiveTopology: GPUPrimitiveTopology = 'triangle-list'\n  ): GPUBuffer {\n    let pipeline: GPURenderPipeline;\n    // The indexFormat must be set in render pipeline descriptor that specifys a strip primitive\n    // topology for primitive restart testing\n    if (primitiveTopology === 'line-strip' || primitiveTopology === 'triangle-strip') {\n      pipeline = this.MakeRenderPipeline(primitiveTopology, indexFormat);\n    } else {\n      pipeline = this.MakeRenderPipeline(primitiveTopology);\n    }\n\n    const colorAttachment = this.device.createTexture({\n      format: kTextureFormat,\n      size: { width: kWidth, height: kHeight, depthOrArrayLayers: 1 },\n      usage: GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    const result = this.device.createBuffer({\n      size: byteLength,\n      usage: GPUBufferUsage.COPY_SRC | GPUBufferUsage.COPY_DST,\n    });\n\n    const encoder = this.device.createCommandEncoder();\n    const pass = encoder.beginRenderPass({\n      colorAttachments: [\n        { view: colorAttachment.createView(), loadValue: [0, 0, 0, 0], storeOp: 'store' },\n      ],\n    });\n    pass.setPipeline(pipeline);\n    pass.setIndexBuffer(indexBuffer, indexFormat, indexOffset);\n    pass.drawIndexed(indexCount);\n    pass.endPass();\n    encoder.copyTextureToBuffer(\n      { texture: colorAttachment },\n      { buffer: result, bytesPerRow, rowsPerImage },\n      [kWidth, kHeight]\n    );\n    this.device.queue.submit([encoder.finish()]);\n\n    return result;\n  }\n\n  CreateExpectedUint8Array(renderShape: Raster8x4): Uint8Array {\n    const arrayBuffer = new Uint8Array(byteLength);\n    for (let row = 0; row < renderShape.length; row++) {\n      for (let col = 0; col < renderShape[row].length; col++) {\n        const texel: 0 | 1 = renderShape[row][col];\n\n        const kBytesPerTexel = 1; // r8uint\n        const byteOffset = row * bytesPerRow + col * kBytesPerTexel;\n        arrayBuffer[byteOffset] = texel;\n      }\n    }\n    return arrayBuffer;\n  }\n}\n\nexport const g = makeTestGroup(IndexFormatTest);\n\ng.test('index_format,uint16')\n  .desc('Test rendering result of indexed draw with index format of uint16.')\n  .paramsSubcasesOnly([\n    { indexOffset: 0, _expectedShape: kSquare },\n    { indexOffset: 6, _expectedShape: kBottomLeftTriangle },\n    { indexOffset: 18, _expectedShape: kNothing },\n  ])\n  .fn(t => {\n    const { indexOffset, _expectedShape } = t.params;\n\n    // If this is written as uint16 but interpreted as uint32, it will have index 1 and 2 be both 0\n    // and render nothing.\n    // And the index buffer size - offset must be not less than the size required by triangle\n    // list, otherwise it also render nothing.\n    const indices: number[] = [1, 2, 0, 0, 0, 0, 0, 1, 3, 0];\n    const indexBuffer = t.CreateIndexBuffer(indices, 'uint16');\n    const result = t.run(indexBuffer, indices.length, 'uint16', indexOffset);\n\n    const expectedTextureValues = t.CreateExpectedUint8Array(_expectedShape);\n    t.expectGPUBufferValuesEqual(result, expectedTextureValues);\n  });\n\ng.test('index_format,uint32')\n  .desc('Test rendering result of indexed draw with index format of uint32.')\n  .paramsSubcasesOnly([\n    { indexOffset: 0, _expectedShape: kSquare },\n    { indexOffset: 12, _expectedShape: kBottomLeftTriangle },\n    { indexOffset: 36, _expectedShape: kNothing },\n  ])\n  .fn(t => {\n    const { indexOffset, _expectedShape } = t.params;\n\n    // If this is interpreted as uint16, then it would be 0, 1, 0, ... and would draw nothing.\n    // And the index buffer size - offset must be not less than the size required by triangle\n    // list, otherwise it also render nothing.\n    const indices: number[] = [1, 2, 0, 0, 0, 0, 0, 1, 3, 0];\n    const indexBuffer = t.CreateIndexBuffer(indices, 'uint32');\n    const result = t.run(indexBuffer, indices.length, 'uint32', indexOffset);\n\n    const expectedTextureValues = t.CreateExpectedUint8Array(_expectedShape);\n    t.expectGPUBufferValuesEqual(result, expectedTextureValues);\n  });\n\ng.test('primitive_restart')\n  .desc(\n    `\nTest primitive restart with each primitive topology.\n\nPrimitive restart should be always active with strip primitive topologies\n('line-strip' or 'triangle-strip') and never active for other topologies, where\nthe primitive restart value isn't special and should be treated as a regular index value.\n\nThe value -1 gets uploaded as 0xFFFF or 0xFFFF_FFFF according to the format.\n\nThe positions of these points are embedded in the shader above, and look like this:\n  |   0  2|\n  |       |\n  -1  3  1|\n\nBelow are the indices lists used for each test, and the expected rendering result of each\n(approximately, in the case of incorrect results). This shows the expected result (marked '->')\nis different from what you would get if the topology were incorrect.\n\n- primitiveTopology: triangle-list\n  indices: [0, 1, 3, -1, 2, 1, 0, 0],\n   -> triangle-list:              (0, 1, 3), (-1, 2, 1)\n        |    #  #|\n        |    ####|\n        |   #####|\n        | #######|\n      triangle-list with restart: (0, 1, 3), (2, 1, 0)\n      triangle-strip:             (0, 1, 3), (2, 1, 0), (1, 0, 0)\n        |    ####|\n        |    ####|\n        |    ####|\n        |    ####|\n      triangle-strip w/o restart: (0, 1, 3), (1, 3, -1), (3, -1, 2), (-1, 2, 1), (2, 1, 0), (1, 0, 0)\n        |    ####|\n        |    ####|\n        |   #####|\n        | #######|\n\n- primitiveTopology: triangle-strip\n  indices: [3, 1, 0, -1, 2, 2, 1, 3],\n   -> triangle-strip:             (3, 1, 0), (2, 2, 1), (2, 1, 3)\n        |    #  #|\n        |    ####|\n        |    ####|\n        |    ####|\n      triangle-strip w/o restart: (3, 1, 0), (1, 0, -1), (0, -1, 2), (2, 2, 1), (2, 3, 1)\n        |    ####|\n        |   #####|\n        |  ######|\n        | #######|\n      triangle-list:              (3, 1, 0), (-1, 2, 2)\n      triangle-list with restart: (3, 1, 0), (2, 2, 1)\n        |        |\n        |    #   |\n        |    ##  |\n        |    ### |\n\n- primitiveTopology: point, line-list, line-strip:\n  indices: [0, 1, -1, 2, -1, 2, 3, 0],\n   -> point-list:             (0), (1), (-1), (2), (3), (0)\n        |    #  #|\n        |        |\n        |        |\n        |#   #  #|\n      point-list with restart (0), (1), (2), (3), (0)\n        |    #  #|\n        |        |\n        |        |\n        |    #  #|\n   -> line-list:              (0, 1), (-1, 2), (3, 0)\n        |    # ##|\n        |    ##  |\n        |  ### # |\n        |##  #  #|\n      line-list with restart: (0, 1), (2, 3)\n        |    #  #|\n        |     ## |\n        |     ## |\n        |    #  #|\n   -> line-strip:             (0, 1), (2, 3), (3, 0)\n        |    #  #|\n        |    ### |\n        |    ### |\n        |    #  #|\n      line-strip w/o restart: (0, 1), (1, -1), (-1, 2), (2, 3), (3, 3)\n        |    # ##|\n        |    ### |\n        |  ## ## |\n        |########|\n`\n  )\n  .params(u =>\n    u //\n      .combine('indexFormat', ['uint16', 'uint32'] as const)\n      .combineWithParams([\n        {\n          primitiveTopology: 'point-list',\n          _indices: [0, 1, -1, 2, 3, 0],\n          _expectedShape: [\n            [0, 0, 0, 0, 1, 0, 0, 1],\n            [0, 0, 0, 0, 0, 0, 0, 0],\n            [0, 0, 0, 0, 0, 0, 0, 0],\n            [1, 0, 0, 0, 1, 0, 0, 1],\n          ],\n        },\n        {\n          primitiveTopology: 'line-list',\n          _indices: [0, 1, -1, 2, 3, 0],\n          _expectedShape: [\n            [0, 0, 0, 0, 1, 0, 1, 1],\n            [0, 0, 0, 0, 1, 1, 0, 0],\n            [0, 0, 1, 1, 1, 0, 1, 0],\n            [1, 1, 0, 0, 1, 0, 0, 1],\n          ],\n        },\n        {\n          primitiveTopology: 'line-strip',\n          _indices: [0, 1, -1, 2, 3, 0],\n          _expectedShape: [\n            [0, 0, 0, 0, 1, 0, 0, 1],\n            [0, 0, 0, 0, 1, 1, 1, 0],\n            [0, 0, 0, 0, 1, 1, 1, 0],\n            [0, 0, 0, 0, 1, 0, 0, 1],\n          ],\n        },\n        {\n          primitiveTopology: 'triangle-list',\n          _indices: [0, 1, 3, -1, 2, 1, 0, 0],\n          _expectedShape: [\n            [0, 0, 0, 0, 0, 0, 0, 1],\n            [0, 0, 0, 0, 1, 1, 1, 1],\n            [0, 0, 0, 1, 1, 1, 1, 1],\n            [0, 1, 1, 1, 1, 1, 1, 1],\n          ],\n        },\n        {\n          primitiveTopology: 'triangle-strip',\n          _indices: [3, 1, 0, -1, 2, 2, 1, 3],\n          _expectedShape: [\n            [0, 0, 0, 0, 0, 0, 0, 1],\n            [0, 0, 0, 0, 1, 0, 1, 1],\n            [0, 0, 0, 0, 1, 1, 1, 1],\n            [0, 0, 0, 0, 1, 1, 1, 1],\n          ],\n        },\n      ] as const)\n  )\n  .fn(t => {\n    const { indexFormat, primitiveTopology, _indices, _expectedShape } = t.params;\n\n    const indexBuffer = t.CreateIndexBuffer(_indices, indexFormat);\n    const result = t.run(indexBuffer, _indices.length, indexFormat, 0, primitiveTopology);\n\n    const expectedTextureValues = t.CreateExpectedUint8Array(_expectedShape);\n    t.expectGPUBufferValuesEqual(result, expectedTextureValues);\n  });\n"],"file":"index_format.spec.js"}