{"version":3,"sources":["../../../../../src/webgpu/api/validation/texture/destroy.spec.ts"],"names":["description","makeTestGroup","kTextureAspects","kTextureFormatInfo","ValidationTest","g","test","desc","fn","t","texture","getSampledTexture","destroy","params","u","combine","colorTextureState","depthStencilTextureAspect","depthStencilTextureState","isSubmitSuccess","colorTextureFormat","depthStencilTextureFormat","colorTextureDesc","size","width","height","depthOrArrayLayers","format","usage","GPUTextureUsage","COPY_DST","RENDER_ATTACHMENT","depthStencilTextureDesc","colorTexture","device","createTexture","depthStencilTexture","commandEncoder","createCommandEncoder","depthStencilAttachment","view","createView","aspect","depth","depthClearValue","depthLoadOp","depthStoreOp","stencil","stencilClearValue","stencilLoadOp","stencilStoreOp","renderPass","beginRenderPass","colorAttachments","clearValue","loadOp","storeOp","end","cmd","finish","expectValidationError","queue","submit"],"mappings":"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","sourcesContent":["export const description = `\nDestroying a texture more than once is allowed.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { kTextureAspects, kTextureFormatInfo } from '../../../capability_info.js';\nimport { ValidationTest } from '../validation_test.js';\n\nexport const g = makeTestGroup(ValidationTest);\n\ng.test('base')\n  .desc(`Test that it is valid to destroy a texture.`)\n  .fn(t => {\n    const texture = t.getSampledTexture();\n    texture.destroy();\n  });\n\ng.test('twice')\n  .desc(`Test that it is valid to destroy a destroyed texture.`)\n  .fn(t => {\n    const texture = t.getSampledTexture();\n    texture.destroy();\n    texture.destroy();\n  });\n\ng.test('submit_a_destroyed_texture_as_attachment')\n  .desc(\n    `\nTest that it is invalid to submit with a texture as {color, depth, stencil, depth-stencil} attachment\nthat was destroyed {before, after} encoding finishes.\n`\n  )\n  .params(u =>\n    u //\n      .combine('depthStencilTextureAspect', kTextureAspects)\n      .combine('colorTextureState', [\n        'valid',\n        'destroyedBeforeEncode',\n        'destroyedAfterEncode',\n      ] as const)\n      .combine('depthStencilTextureState', [\n        'valid',\n        'destroyedBeforeEncode',\n        'destroyedAfterEncode',\n      ] as const)\n  )\n  .fn(async t => {\n    const { colorTextureState, depthStencilTextureAspect, depthStencilTextureState } = t.params;\n\n    const isSubmitSuccess = colorTextureState === 'valid' && depthStencilTextureState === 'valid';\n\n    const colorTextureFormat: GPUTextureFormat = 'rgba32float';\n    const depthStencilTextureFormat: GPUTextureFormat =\n      depthStencilTextureAspect === 'all'\n        ? 'depth24plus-stencil8'\n        : depthStencilTextureAspect === 'depth-only'\n        ? 'depth32float'\n        : 'stencil8';\n\n    const colorTextureDesc: GPUTextureDescriptor = {\n      size: { width: 16, height: 16, depthOrArrayLayers: 1 },\n      format: colorTextureFormat,\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    };\n\n    const depthStencilTextureDesc: GPUTextureDescriptor = {\n      size: { width: 16, height: 16, depthOrArrayLayers: 1 },\n      format: depthStencilTextureFormat,\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    };\n\n    const colorTexture = t.device.createTexture(colorTextureDesc);\n    const depthStencilTexture = t.device.createTexture(depthStencilTextureDesc);\n\n    if (colorTextureState === 'destroyedBeforeEncode') {\n      colorTexture.destroy();\n    }\n    if (depthStencilTextureState === 'destroyedBeforeEncode') {\n      depthStencilTexture.destroy();\n    }\n\n    const commandEncoder = t.device.createCommandEncoder();\n    const depthStencilAttachment: GPURenderPassDepthStencilAttachment = {\n      view: depthStencilTexture.createView({ aspect: depthStencilTextureAspect }),\n    };\n    if (kTextureFormatInfo[depthStencilTextureFormat].depth) {\n      depthStencilAttachment.depthClearValue = 0;\n      depthStencilAttachment.depthLoadOp = 'clear';\n      depthStencilAttachment.depthStoreOp = 'discard';\n    }\n    if (kTextureFormatInfo[depthStencilTextureFormat].stencil) {\n      depthStencilAttachment.stencilClearValue = 0;\n      depthStencilAttachment.stencilLoadOp = 'clear';\n      depthStencilAttachment.stencilStoreOp = 'discard';\n    }\n    const renderPass = commandEncoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: colorTexture.createView(),\n          clearValue: [0, 0, 0, 0],\n          loadOp: 'clear',\n          storeOp: 'store',\n        },\n      ],\n      depthStencilAttachment,\n    });\n    renderPass.end();\n\n    const cmd = commandEncoder.finish();\n\n    if (colorTextureState === 'destroyedAfterEncode') {\n      colorTexture.destroy();\n    }\n    if (depthStencilTextureState === 'destroyedAfterEncode') {\n      depthStencilTexture.destroy();\n    }\n\n    t.expectValidationError(() => t.queue.submit([cmd]), !isSubmitSuccess);\n  });\n"],"file":"destroy.spec.js"}