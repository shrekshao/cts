{"version":3,"sources":["../../../../src/webgpu/api/validation/attachment_compatibility.spec.ts"],"names":["description","makeTestGroup","range","kRegularTextureFormats","kSizedDepthStencilFormats","kUnsizedDepthStencilFormats","kTextureSampleCounts","kMaxColorAttachments","kTextureFormatInfo","ValidationTest","kColorAttachmentCounts","i","kColorAttachments","map","count","result","Array","fill","concat","r","cases","j","push","flat","kDepthStencilAttachmentFormats","undefined","F","createAttachmentTextureView","format","sampleCount","device","createTexture","size","usage","GPUTextureUsage","RENDER_ATTACHMENT","createView","createColorAttachment","view","clearValue","loadOp","storeOp","createDepthAttachment","attachment","depth","depthClearValue","depthLoadOp","depthStoreOp","stencil","stencilClearValue","stencilLoadOp","stencilStoreOp","createRenderPipeline","targets","depthStencil","cullMode","vertex","module","createShaderModule","code","entryPoint","fragment","primitive","topology","multisample","g","kColorAttachmentFormats","filter","info","color","renderable","test","desc","paramsSubcasesOnly","u","combine","fn","t","passFormat","bundleFormat","params","bundleEncoder","createRenderBundleEncoder","colorFormats","bundle","finish","encoder","validateFinishAndSubmit","createEncoder","pass","beginRenderPass","colorAttachments","executeBundles","end","passCount","bundleCount","beginSubcases","p","attachmentCount","passAttachments","length","bundleAttachments","every","v","selectDeviceForTextureFormatOrSkipTestCase","depthStencilFormat","depthStencilAttachment","renderSampleCount","bundleSampleCount","encoderType","encoderFormat","pipelineFormat","pipeline","writeMask","attachmentInfo","setPipeline","encoderCount","pipelineCount","encoderAttachments","pipelineAttachments","colorTargets","kStencilFaceStates","failOp","depthFailOp","passOp","depthStencilInfo","depthReadOnly","stencilReadOnly","depthWriteEnabled","stencilFront","stencilBack","stencilWriteMask","writesDepth","writesStencil","isValid","attachmentType","encoderSampleCount","pipelineSampleCount"],"mappings":"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","sourcesContent":["export const description = `\nValidation for attachment compatibility between render passes, bundles, and pipelines\n`;\n\nimport { makeTestGroup } from '../../../common/framework/test_group.js';\nimport { range } from '../../../common/util/util.js';\nimport {\n  kRegularTextureFormats,\n  kSizedDepthStencilFormats,\n  kUnsizedDepthStencilFormats,\n  kTextureSampleCounts,\n  kMaxColorAttachments,\n  kTextureFormatInfo,\n} from '../../capability_info.js';\n\nimport { ValidationTest } from './validation_test.js';\n\nconst kColorAttachmentCounts = range(kMaxColorAttachments, i => i + 1);\nconst kColorAttachments = kColorAttachmentCounts\n  .map(count => {\n    // generate cases with 0..1 null attachments at different location\n    // e.g. count == 2\n    // [\n    //    [1, 1],\n    //    [0, 1],\n    //    [1, 0],\n    // ]\n    // 0 (false) means null attachment, 1 (true) means non-null attachment, at the slot\n\n    // Special cases: we need at least a color attachment, when we don't have depth stencil attachment\n    if (count === 1) {\n      return [[1]];\n    }\n    if (count === 2) {\n      return [\n        [1, 1],\n        [0, 1],\n        [1, 0],\n      ];\n    }\n\n    // [1, 1, ..., 1]: all color attachment are used\n    let result = [new Array<boolean>(count).fill(true)];\n\n    // [1, 0, 1, ..., 1]: generate cases with one null attachment at different locations\n    result = result.concat(\n      range(count, i => {\n        const r = new Array<boolean>(count).fill(true);\n        r[i] = false;\n        return r;\n      })\n    );\n\n    // [1, 0, 1, ..., 0, 1]: generate cases with two null attachments at different locations\n    // To reduce test run time, limit the attachment count to <= 4\n    if (count <= 4) {\n      result = result.concat(\n        range(count - 1, i => {\n          const cases = [] as boolean[][];\n          for (let j = i + 1; j < count; j++) {\n            const r = new Array<boolean>(count).fill(true);\n            r[i] = false;\n            r[j] = false;\n            cases.push(r);\n          }\n          return cases;\n        }).flat()\n      );\n    }\n\n    return result;\n  })\n  .flat() as boolean[][];\n\nconst kDepthStencilAttachmentFormats = [\n  undefined,\n  ...kSizedDepthStencilFormats,\n  ...kUnsizedDepthStencilFormats,\n] as const;\n\nclass F extends ValidationTest {\n  createAttachmentTextureView(format: GPUTextureFormat, sampleCount?: number) {\n    return this.device\n      .createTexture({\n        // Size matching the \"arbitrary\" size used by ValidationTest helpers.\n        size: [16, 16, 1],\n        format,\n        usage: GPUTextureUsage.RENDER_ATTACHMENT,\n        sampleCount,\n      })\n      .createView();\n  }\n\n  createColorAttachment(\n    format: GPUTextureFormat | null,\n    sampleCount?: number\n  ): GPURenderPassColorAttachment | null {\n    return format === null\n      ? null\n      : {\n          view: this.createAttachmentTextureView(format, sampleCount),\n          clearValue: [0, 0, 0, 0],\n          loadOp: 'clear',\n          storeOp: 'store',\n        };\n  }\n\n  createDepthAttachment(\n    format: GPUTextureFormat,\n    sampleCount?: number\n  ): GPURenderPassDepthStencilAttachment {\n    const attachment: GPURenderPassDepthStencilAttachment = {\n      view: this.createAttachmentTextureView(format, sampleCount),\n    };\n    if (kTextureFormatInfo[format].depth) {\n      attachment.depthClearValue = 0;\n      attachment.depthLoadOp = 'clear';\n      attachment.depthStoreOp = 'discard';\n    }\n    if (kTextureFormatInfo[format].stencil) {\n      attachment.stencilClearValue = 1;\n      attachment.stencilLoadOp = 'clear';\n      attachment.stencilStoreOp = 'discard';\n    }\n    return attachment;\n  }\n\n  createRenderPipeline(\n    targets: Iterable<GPUColorTargetState | null>,\n    depthStencil?: GPUDepthStencilState,\n    sampleCount?: number,\n    cullMode?: GPUCullMode\n  ) {\n    return this.device.createRenderPipeline({\n      vertex: {\n        module: this.device.createShaderModule({\n          code: `\n            @stage(vertex) fn main() -> @builtin(position) vec4<f32> {\n              return vec4<f32>(0.0, 0.0, 0.0, 0.0);\n            }`,\n        }),\n        entryPoint: 'main',\n      },\n      fragment: {\n        module: this.device.createShaderModule({\n          code: '@stage(fragment) fn main() {}',\n        }),\n        entryPoint: 'main',\n        targets,\n      },\n      primitive: { topology: 'triangle-list', cullMode },\n      depthStencil,\n      multisample: { count: sampleCount },\n    });\n  }\n}\n\nexport const g = makeTestGroup(F);\n\nconst kColorAttachmentFormats = kRegularTextureFormats.filter(format => {\n  const info = kTextureFormatInfo[format];\n  return info.color && info.renderable;\n});\n\ng.test('render_pass_and_bundle,color_format')\n  .desc('Test that color attachment formats in render passes and bundles must match.')\n  .paramsSubcasesOnly(u =>\n    u //\n      .combine('passFormat', kColorAttachmentFormats)\n      .combine('bundleFormat', kColorAttachmentFormats)\n  )\n  .fn(t => {\n    const { passFormat, bundleFormat } = t.params;\n    const bundleEncoder = t.device.createRenderBundleEncoder({\n      colorFormats: [bundleFormat],\n    });\n    const bundle = bundleEncoder.finish();\n\n    const { encoder, validateFinishAndSubmit } = t.createEncoder('non-pass');\n    const pass = encoder.beginRenderPass({\n      colorAttachments: [t.createColorAttachment(passFormat)],\n    });\n    pass.executeBundles([bundle]);\n    pass.end();\n    validateFinishAndSubmit(passFormat === bundleFormat, true);\n  });\n\ng.test('render_pass_and_bundle,color_count')\n  .desc(\n    `\n  Test that the number of color attachments in render passes and bundles must match.\n  `\n  )\n  .paramsSubcasesOnly(u =>\n    u //\n      .combine('passCount', kColorAttachmentCounts)\n      .combine('bundleCount', kColorAttachmentCounts)\n  )\n  .fn(t => {\n    const { passCount, bundleCount } = t.params;\n    const bundleEncoder = t.device.createRenderBundleEncoder({\n      colorFormats: range(bundleCount, () => 'rgba8unorm'),\n    });\n    const bundle = bundleEncoder.finish();\n\n    const { encoder, validateFinishAndSubmit } = t.createEncoder('non-pass');\n    const pass = encoder.beginRenderPass({\n      colorAttachments: range(passCount, () => t.createColorAttachment('rgba8unorm')),\n    });\n    pass.executeBundles([bundle]);\n    pass.end();\n    validateFinishAndSubmit(passCount === bundleCount, true);\n  });\n\ng.test('render_pass_and_bundle,color_sparse')\n  .desc(\n    `\n  Test that each of color attachments in render passes and bundles must match.\n  `\n  )\n  .params(u =>\n    u //\n      // introduce attachmentCount to make it easier to split the test\n      .combine('attachmentCount', kColorAttachmentCounts)\n      .beginSubcases()\n      .combine('passAttachments', kColorAttachments)\n      .combine('bundleAttachments', kColorAttachments)\n      .filter(\n        p =>\n          p.attachmentCount === p.passAttachments.length &&\n          p.attachmentCount === p.bundleAttachments.length\n      )\n  )\n  .fn(t => {\n    const { passAttachments, bundleAttachments } = t.params;\n    const colorFormats = bundleAttachments.map(i => (i ? 'rgba8unorm' : null));\n    const bundleEncoder = t.device.createRenderBundleEncoder({\n      colorFormats,\n    });\n    const bundle = bundleEncoder.finish();\n\n    const { encoder, validateFinishAndSubmit } = t.createEncoder('non-pass');\n    const colorAttachments = passAttachments.map(i =>\n      t.createColorAttachment(i ? 'rgba8unorm' : null)\n    );\n    const pass = encoder.beginRenderPass({\n      colorAttachments,\n    });\n    pass.executeBundles([bundle]);\n    pass.end();\n    validateFinishAndSubmit(\n      passAttachments.every((v, i) => v === bundleAttachments[i]),\n      true\n    );\n  });\n\ng.test('render_pass_and_bundle,depth_format')\n  .desc('Test that the depth attachment format in render passes and bundles must match.')\n  .paramsSubcasesOnly(u =>\n    u //\n      .combine('passFormat', kDepthStencilAttachmentFormats)\n      .combine('bundleFormat', kDepthStencilAttachmentFormats)\n  )\n  .fn(async t => {\n    const { passFormat, bundleFormat } = t.params;\n    await t.selectDeviceForTextureFormatOrSkipTestCase([passFormat, bundleFormat]);\n\n    const bundleEncoder = t.device.createRenderBundleEncoder({\n      colorFormats: ['rgba8unorm'],\n      depthStencilFormat: bundleFormat,\n    });\n    const bundle = bundleEncoder.finish();\n\n    const { encoder, validateFinishAndSubmit } = t.createEncoder('non-pass');\n    const pass = encoder.beginRenderPass({\n      colorAttachments: [t.createColorAttachment('rgba8unorm')],\n      depthStencilAttachment:\n        passFormat !== undefined ? t.createDepthAttachment(passFormat) : undefined,\n    });\n    pass.executeBundles([bundle]);\n    pass.end();\n    validateFinishAndSubmit(passFormat === bundleFormat, true);\n  });\n\ng.test('render_pass_and_bundle,sample_count')\n  .desc('Test that the sample count in render passes and bundles must match.')\n  .paramsSubcasesOnly(u =>\n    u //\n      .combine('renderSampleCount', kTextureSampleCounts)\n      .combine('bundleSampleCount', kTextureSampleCounts)\n  )\n  .fn(t => {\n    const { renderSampleCount, bundleSampleCount } = t.params;\n    const bundleEncoder = t.device.createRenderBundleEncoder({\n      colorFormats: ['rgba8unorm'],\n      sampleCount: bundleSampleCount,\n    });\n    const bundle = bundleEncoder.finish();\n    const { encoder, validateFinishAndSubmit } = t.createEncoder('non-pass');\n    const pass = encoder.beginRenderPass({\n      colorAttachments: [t.createColorAttachment('rgba8unorm', renderSampleCount)],\n    });\n    pass.executeBundles([bundle]);\n    pass.end();\n    validateFinishAndSubmit(renderSampleCount === bundleSampleCount, true);\n  });\n\ng.test('render_pass_or_bundle_and_pipeline,color_format')\n  .desc(\n    `\nTest that color attachment formats in render passes or bundles match the pipeline color format.\n`\n  )\n  .params(u =>\n    u\n      .combine('encoderType', ['render pass', 'render bundle'] as const)\n      .beginSubcases()\n      .combine('encoderFormat', kColorAttachmentFormats)\n      .combine('pipelineFormat', kColorAttachmentFormats)\n  )\n  .fn(t => {\n    const { encoderType, encoderFormat, pipelineFormat } = t.params;\n    const pipeline = t.createRenderPipeline([{ format: pipelineFormat, writeMask: 0 }]);\n\n    const { encoder, validateFinishAndSubmit } = t.createEncoder(encoderType, {\n      attachmentInfo: { colorFormats: [encoderFormat] },\n    });\n    encoder.setPipeline(pipeline);\n    validateFinishAndSubmit(encoderFormat === pipelineFormat, true);\n  });\n\ng.test('render_pass_or_bundle_and_pipeline,color_count')\n  .desc(\n    `\nTest that the number of color attachments in render passes or bundles match the pipeline color\ncount.\n`\n  )\n  .params(u =>\n    u\n      .combine('encoderType', ['render pass', 'render bundle'] as const)\n      .beginSubcases()\n      .combine('encoderCount', kColorAttachmentCounts)\n      .combine('pipelineCount', kColorAttachmentCounts)\n  )\n  .fn(t => {\n    const { encoderType, encoderCount, pipelineCount } = t.params;\n    const pipeline = t.createRenderPipeline(\n      range(pipelineCount, () => ({ format: 'rgba8unorm', writeMask: 0 }))\n    );\n\n    const { encoder, validateFinishAndSubmit } = t.createEncoder(encoderType, {\n      attachmentInfo: { colorFormats: range(encoderCount, () => 'rgba8unorm') },\n    });\n    encoder.setPipeline(pipeline);\n    validateFinishAndSubmit(encoderCount === pipelineCount, true);\n  });\n\ng.test('render_pass_or_bundle_and_pipeline,color_sparse')\n  .desc(\n    `\nTest that each of color attachments in render passes or bundles match that of the pipeline.\n`\n  )\n  .params(u =>\n    u\n      .combine('encoderType', ['render pass', 'render bundle'] as const)\n      // introduce attachmentCount to make it easier to split the test\n      .combine('attachmentCount', kColorAttachmentCounts)\n      .beginSubcases()\n      .combine('encoderAttachments', kColorAttachments)\n      .combine('pipelineAttachments', kColorAttachments)\n      .filter(\n        p =>\n          p.attachmentCount === p.encoderAttachments.length &&\n          p.attachmentCount === p.pipelineAttachments.length\n      )\n  )\n  .fn(t => {\n    const { encoderType, encoderAttachments, pipelineAttachments } = t.params;\n\n    const colorTargets = pipelineAttachments.map(i =>\n      i ? ({ format: 'rgba8unorm', writeMask: 0 } as GPUColorTargetState) : null\n    );\n    const pipeline = t.createRenderPipeline(colorTargets);\n\n    const colorFormats = encoderAttachments.map(i => (i ? 'rgba8unorm' : null));\n    const { encoder, validateFinishAndSubmit } = t.createEncoder(encoderType, {\n      attachmentInfo: { colorFormats },\n    });\n    encoder.setPipeline(pipeline);\n    validateFinishAndSubmit(\n      encoderAttachments.every((v, i) => v === pipelineAttachments[i]),\n      true\n    );\n  });\n\ng.test('render_pass_or_bundle_and_pipeline,depth_format')\n  .desc(\n    `\nTest that the depth attachment format in render passes or bundles match the pipeline depth format.\n`\n  )\n  .params(u =>\n    u\n      .combine('encoderType', ['render pass', 'render bundle'] as const)\n      .beginSubcases()\n      .combine('encoderFormat', kDepthStencilAttachmentFormats)\n      .combine('pipelineFormat', kDepthStencilAttachmentFormats)\n  )\n  .fn(async t => {\n    const { encoderType, encoderFormat, pipelineFormat } = t.params;\n    await t.selectDeviceForTextureFormatOrSkipTestCase([encoderFormat, pipelineFormat]);\n\n    const pipeline = t.createRenderPipeline(\n      [{ format: 'rgba8unorm', writeMask: 0 }],\n      pipelineFormat !== undefined ? { format: pipelineFormat } : undefined\n    );\n\n    const { encoder, validateFinishAndSubmit } = t.createEncoder(encoderType, {\n      attachmentInfo: { colorFormats: ['rgba8unorm'], depthStencilFormat: encoderFormat },\n    });\n    encoder.setPipeline(pipeline);\n    validateFinishAndSubmit(encoderFormat === pipelineFormat, true);\n  });\n\nconst kStencilFaceStates = [\n  { failOp: 'keep', depthFailOp: 'keep', passOp: 'keep' },\n  { failOp: 'zero', depthFailOp: 'zero', passOp: 'zero' },\n] as GPUStencilFaceState[];\n\ng.test('render_pass_or_bundle_and_pipeline,depth_stencil_read_only_write_state')\n  .desc(\n    `\nTest that the depth stencil read only state in render passes or bundles is compatible with the depth stencil write state of the pipeline.\n`\n  )\n  .params(u =>\n    u\n      .combine('encoderType', ['render pass', 'render bundle'] as const)\n      .combine('format', kDepthStencilAttachmentFormats)\n      .beginSubcases()\n      // pass/bundle state\n      .combine('depthReadOnly', [false, true])\n      .combine('stencilReadOnly', [false, true])\n      .combine('stencilFront', kStencilFaceStates)\n      .combine('stencilBack', kStencilFaceStates)\n      // pipeline state\n      .combine('depthWriteEnabled', [false, true])\n      .combine('stencilWriteMask', [0, 0xffffffff])\n      .combine('cullMode', ['none', 'front', 'back'] as const)\n      .filter(p => {\n        if (p.format) {\n          const depthStencilInfo = kTextureFormatInfo[p.format];\n          // For combined depth/stencil formats the depth and stencil read only state must match\n          // in order to create a valid render bundle or render pass.\n          if (depthStencilInfo.depth && depthStencilInfo.stencil) {\n            if (p.depthReadOnly !== p.stencilReadOnly) {\n              return false;\n            }\n          }\n          // If the format has no depth aspect, the depthReadOnly, depthWriteEnabled of the pipeline must not be true\n          // in order to create a valid render pipeline.\n          if (!depthStencilInfo.depth && p.depthWriteEnabled) {\n            return false;\n          }\n          // If the format has no stencil aspect, the stencil state operation must be 'keep'\n          // in order to create a valid render pipeline.\n          if (\n            !depthStencilInfo.stencil &&\n            (p.stencilFront.failOp !== 'keep' || p.stencilBack.failOp !== 'keep')\n          ) {\n            return false;\n          }\n        }\n        // No depthStencil attachment\n        return true;\n      })\n  )\n  .fn(async t => {\n    const {\n      encoderType,\n      format,\n      depthReadOnly,\n      stencilReadOnly,\n      depthWriteEnabled,\n      stencilWriteMask,\n      cullMode,\n      stencilFront,\n      stencilBack,\n    } = t.params;\n    await t.selectDeviceForTextureFormatOrSkipTestCase(format);\n\n    const pipeline = t.createRenderPipeline(\n      [{ format: 'rgba8unorm', writeMask: 0 }],\n      format === undefined\n        ? undefined\n        : {\n            format,\n            depthWriteEnabled,\n            stencilWriteMask,\n            stencilFront,\n            stencilBack,\n          },\n      1,\n      cullMode\n    );\n\n    const { encoder, validateFinishAndSubmit } = t.createEncoder(encoderType, {\n      attachmentInfo: { colorFormats: ['rgba8unorm'], depthStencilFormat: format },\n    });\n    encoder.setPipeline(pipeline);\n\n    let writesDepth = false;\n    let writesStencil = false;\n    if (format) {\n      writesDepth = depthWriteEnabled;\n      if (stencilWriteMask !== 0) {\n        if (\n          cullMode !== 'front' &&\n          (stencilFront.passOp !== 'keep' ||\n            stencilFront.depthFailOp !== 'keep' ||\n            stencilFront.failOp !== 'keep')\n        ) {\n          writesStencil = true;\n        }\n        if (\n          cullMode !== 'back' &&\n          (stencilBack.passOp !== 'keep' ||\n            stencilBack.depthFailOp !== 'keep' ||\n            stencilBack.failOp !== 'keep')\n        ) {\n          writesStencil = true;\n        }\n      }\n    }\n\n    let isValid = true;\n    if (writesDepth) {\n      isValid &&= !depthReadOnly;\n    }\n    if (writesStencil) {\n      isValid &&= !stencilReadOnly;\n    }\n\n    validateFinishAndSubmit(isValid, true);\n  });\n\ng.test('render_pass_or_bundle_and_pipeline,sample_count')\n  .desc(\n    `\nTest that the sample count in render passes or bundles match the pipeline sample count for both color texture and depthstencil texture.\n`\n  )\n  .params(u =>\n    u\n      .combine('encoderType', ['render pass', 'render bundle'] as const)\n      .combine('attachmentType', ['color', 'depthstencil'] as const)\n      .beginSubcases()\n      .combine('encoderSampleCount', kTextureSampleCounts)\n      .combine('pipelineSampleCount', kTextureSampleCounts)\n  )\n  .fn(t => {\n    const { encoderType, attachmentType, encoderSampleCount, pipelineSampleCount } = t.params;\n\n    const colorFormats = attachmentType === 'color' ? ['rgba8unorm' as const] : [];\n    const depthStencilFormat =\n      attachmentType === 'depthstencil' ? ('depth24plus-stencil8' as const) : undefined;\n\n    const pipeline = t.createRenderPipeline(\n      colorFormats.map(format => ({ format, writeMask: 0 })),\n      depthStencilFormat ? { format: depthStencilFormat } : undefined,\n      pipelineSampleCount\n    );\n\n    const { encoder, validateFinishAndSubmit } = t.createEncoder(encoderType, {\n      attachmentInfo: { colorFormats, depthStencilFormat, sampleCount: encoderSampleCount },\n    });\n    encoder.setPipeline(pipeline);\n    validateFinishAndSubmit(encoderSampleCount === pipelineSampleCount, true);\n  });\n"],"file":"attachment_compatibility.spec.js"}