{"version":3,"file":"depth_stencil_state.spec.js","names":["description","makeTestGroup","unreachable","kTextureFormats","kTextureFormatInfo","kDepthStencilFormats","kCompareFunctions","kStencilOperations","CreateRenderPipelineValidationTest","g","test","desc","params","u","combine","beforeAllSubcases","t","format","info","selectDeviceOrSkipTestCase","feature","fn","isAsync","descriptor","getDescriptor","depthStencil","doCreateRenderPipelineTest","depth","stencil","undefined","depthCompare","depthTestEnabled","depthWriteEnabled","face","compare","stencilFront","stencilBack","stencilTestEnabled","faceAndOpType","op","failOp","depthFailOp","passOp","stencilWriteEnabled"],"sources":["../../../../../src/webgpu/api/validation/render_pipeline/depth_stencil_state.spec.ts"],"sourcesContent":["export const description = `\nThis test dedicatedly tests validation of GPUDepthStencilState of createRenderPipeline.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { unreachable } from '../../../../common/util/util.js';\nimport {\n  kTextureFormats,\n  kTextureFormatInfo,\n  kDepthStencilFormats,\n  kCompareFunctions,\n  kStencilOperations,\n} from '../../../capability_info.js';\n\nimport { CreateRenderPipelineValidationTest } from './common.js';\n\nexport const g = makeTestGroup(CreateRenderPipelineValidationTest);\n\ng.test('format')\n  .desc(`The texture format in depthStencilState must be a depth/stencil format.`)\n  .params(u => u.combine('isAsync', [false, true]).combine('format', kTextureFormats))\n  .beforeAllSubcases(t => {\n    const { format } = t.params;\n    const info = kTextureFormatInfo[format];\n    t.selectDeviceOrSkipTestCase(info.feature);\n  })\n  .fn(async t => {\n    const { isAsync, format } = t.params;\n    const info = kTextureFormatInfo[format];\n\n    const descriptor = t.getDescriptor({ depthStencil: { format } });\n\n    t.doCreateRenderPipelineTest(isAsync, info.depth || info.stencil, descriptor);\n  });\n\ng.test('depth_test')\n  .desc(\n    `Depth aspect must be contained in the format if depth test is enabled in depthStencilState.`\n  )\n  .params(u =>\n    u\n      .combine('isAsync', [false, true])\n      .combine('format', kDepthStencilFormats)\n      .combine('depthCompare', [undefined, ...kCompareFunctions])\n  )\n  .beforeAllSubcases(t => {\n    const { format } = t.params;\n    const info = kTextureFormatInfo[format];\n    t.selectDeviceOrSkipTestCase(info.feature);\n  })\n  .fn(async t => {\n    const { isAsync, format, depthCompare } = t.params;\n    const info = kTextureFormatInfo[format];\n\n    const descriptor = t.getDescriptor({\n      depthStencil: { format, depthCompare },\n    });\n\n    const depthTestEnabled = depthCompare !== undefined && depthCompare !== 'always';\n    t.doCreateRenderPipelineTest(isAsync, !depthTestEnabled || info.depth, descriptor);\n  });\n\ng.test('depth_write')\n  .desc(\n    `Depth aspect must be contained in the format if depth write is enabled in depthStencilState.`\n  )\n  .params(u =>\n    u\n      .combine('isAsync', [false, true])\n      .combine('format', kDepthStencilFormats)\n      .combine('depthWriteEnabled', [false, true])\n  )\n  .beforeAllSubcases(t => {\n    const { format } = t.params;\n    const info = kTextureFormatInfo[format];\n    t.selectDeviceOrSkipTestCase(info.feature);\n  })\n  .fn(async t => {\n    const { isAsync, format, depthWriteEnabled } = t.params;\n    const info = kTextureFormatInfo[format];\n\n    const descriptor = t.getDescriptor({\n      depthStencil: { format, depthWriteEnabled },\n    });\n    t.doCreateRenderPipelineTest(isAsync, !depthWriteEnabled || info.depth, descriptor);\n  });\n\ng.test('stencil_test')\n  .desc(\n    `Stencil aspect must be contained in the format if stencil test is enabled in depthStencilState.`\n  )\n  .params(u =>\n    u\n      .combine('isAsync', [false, true])\n      .combine('format', kDepthStencilFormats)\n      .combine('face', ['front', 'back'] as const)\n      .combine('compare', [undefined, ...kCompareFunctions])\n  )\n  .beforeAllSubcases(t => {\n    const { format } = t.params;\n    const info = kTextureFormatInfo[format];\n    t.selectDeviceOrSkipTestCase(info.feature);\n  })\n  .fn(async t => {\n    const { isAsync, format, face, compare } = t.params;\n    const info = kTextureFormatInfo[format];\n\n    let descriptor: GPURenderPipelineDescriptor;\n    if (face === 'front') {\n      descriptor = t.getDescriptor({ depthStencil: { format, stencilFront: { compare } } });\n    } else {\n      descriptor = t.getDescriptor({ depthStencil: { format, stencilBack: { compare } } });\n    }\n\n    const stencilTestEnabled = compare !== undefined && compare !== 'always';\n    t.doCreateRenderPipelineTest(isAsync, !stencilTestEnabled || info.stencil, descriptor);\n  });\n\ng.test('stencil_write')\n  .desc(\n    `Stencil aspect must be contained in the format if stencil write is enabled in depthStencilState.`\n  )\n  .params(u =>\n    u\n      .combine('isAsync', [false, true])\n      .combine('format', kDepthStencilFormats)\n      .combine('faceAndOpType', [\n        'frontFailOp',\n        'frontDepthFailOp',\n        'frontPassOp',\n        'backFailOp',\n        'backDepthFailOp',\n        'backPassOp',\n      ] as const)\n      .combine('op', [undefined, ...kStencilOperations])\n  )\n  .beforeAllSubcases(t => {\n    const { format } = t.params;\n    const info = kTextureFormatInfo[format];\n    t.selectDeviceOrSkipTestCase(info.feature);\n  })\n  .fn(async t => {\n    const { isAsync, format, faceAndOpType, op } = t.params;\n    const info = kTextureFormatInfo[format];\n\n    let depthStencil: GPUDepthStencilState;\n    switch (faceAndOpType) {\n      case 'frontFailOp':\n        depthStencil = { format, stencilFront: { failOp: op } };\n        break;\n      case 'frontDepthFailOp':\n        depthStencil = { format, stencilFront: { depthFailOp: op } };\n        break;\n      case 'frontPassOp':\n        depthStencil = { format, stencilFront: { passOp: op } };\n        break;\n      case 'backFailOp':\n        depthStencil = { format, stencilBack: { failOp: op } };\n        break;\n      case 'backDepthFailOp':\n        depthStencil = { format, stencilBack: { depthFailOp: op } };\n        break;\n      case 'backPassOp':\n        depthStencil = { format, stencilBack: { passOp: op } };\n        break;\n      default:\n        unreachable();\n    }\n    const descriptor = t.getDescriptor({ depthStencil });\n\n    const stencilWriteEnabled = op !== undefined && op !== 'keep';\n    t.doCreateRenderPipelineTest(isAsync, !stencilWriteEnabled || info.stencil, descriptor);\n  });\n"],"mappings":"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"}