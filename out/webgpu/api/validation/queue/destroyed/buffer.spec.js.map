{"version":3,"file":"buffer.spec.js","names":["description","makeTestGroup","ValidationTest","g","test","desc","paramsSubcasesOnly","u","combine","fn","t","destroyed","params","buffer","trackForCleanup","device","createBuffer","size","usage","GPUBufferUsage","COPY_DST","destroy","expectValidationError","queue","writeBuffer","Uint8Array","src","COPY_SRC","dst","encoder","createCommandEncoder","copyBufferToBuffer","commandBuffer","finish","shouldError","submit","texture","createTexture","format","GPUTextureUsage","copyBufferToTexture","copyTextureToBuffer"],"sources":["../../../../../../src/webgpu/api/validation/queue/destroyed/buffer.spec.ts"],"sourcesContent":["export const description = `\nTests using a destroyed buffer on a queue.\n\nTODO:\n- test renderPass/renderBundle (setVertexBuffer, setIndexBuffer)\n- test renderPass (resolveQuerySet)\n- test renderPass/computePass (setBindGroup)\n`;\n\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\nimport { ValidationTest } from '../../validation_test.js';\n\nexport const g = makeTestGroup(ValidationTest);\n\ng.test('writeBuffer')\n  .desc(\n    `\nTests that using a destroyed buffer in writeBuffer fails.\n- x= {destroyed, not destroyed (control case)}\n  `\n  )\n  .paramsSubcasesOnly(u => u.combine('destroyed', [false, true] as const))\n  .fn(t => {\n    const { destroyed } = t.params;\n    const buffer = t.trackForCleanup(\n      t.device.createBuffer({\n        size: 4,\n        usage: GPUBufferUsage.COPY_DST,\n      })\n    );\n\n    if (destroyed) {\n      buffer.destroy();\n    }\n\n    t.expectValidationError(() => t.queue.writeBuffer(buffer, 0, new Uint8Array(4)), destroyed);\n  });\n\ng.test('copyBufferToBuffer')\n  .desc(\n    `\nTests that using a destroyed buffer in copyBufferToBuffer fails.\n- x= {not destroyed (control case), src destroyed, dst destroyed}\n  `\n  )\n  .paramsSubcasesOnly(u => u.combine('destroyed', ['none', 'src', 'dst', 'both'] as const))\n  .fn(t => {\n    const src = t.trackForCleanup(\n      t.device.createBuffer({ size: 4, usage: GPUBufferUsage.COPY_SRC })\n    );\n    const dst = t.trackForCleanup(\n      t.device.createBuffer({ size: 4, usage: GPUBufferUsage.COPY_DST })\n    );\n\n    const encoder = t.device.createCommandEncoder();\n    encoder.copyBufferToBuffer(src, 0, dst, 0, dst.size);\n    const commandBuffer = encoder.finish();\n\n    let shouldError = true;\n    switch (t.params.destroyed) {\n      case 'none':\n        shouldError = false;\n        break;\n      case 'src':\n        src.destroy();\n        break;\n      case 'dst':\n        dst.destroy();\n        break;\n      case 'both':\n        src.destroy();\n        dst.destroy();\n        break;\n    }\n\n    t.expectValidationError(() => {\n      t.queue.submit([commandBuffer]);\n    }, shouldError);\n  });\n\ng.test('copyBufferToTexture')\n  .desc(\n    `\nTests that using a destroyed buffer in copyBufferToTexture fails.\n- x= {not destroyed (control case), src destroyed}\n  `\n  )\n  .paramsSubcasesOnly(u => u.combine('destroyed', [false, true] as const))\n  .fn(t => {\n    const { destroyed } = t.params;\n    const buffer = t.trackForCleanup(\n      t.device.createBuffer({ size: 4, usage: GPUBufferUsage.COPY_SRC })\n    );\n    const texture = t.trackForCleanup(\n      t.device.createTexture({\n        size: [1, 1, 1],\n        format: 'rgba8unorm',\n        usage: GPUTextureUsage.COPY_DST,\n      })\n    );\n\n    const encoder = t.device.createCommandEncoder();\n    encoder.copyBufferToTexture({ buffer }, { texture }, [1, 1, 1]);\n    const commandBuffer = encoder.finish();\n\n    if (destroyed) {\n      buffer.destroy();\n    }\n\n    t.expectValidationError(() => {\n      t.queue.submit([commandBuffer]);\n    }, destroyed);\n  });\n\ng.test('copyTextureToBuffer')\n  .desc(\n    `\nTests that using a destroyed buffer in copyTextureToBuffer fails.\n- x= {not destroyed (control case), dst destroyed}\n  `\n  )\n  .paramsSubcasesOnly(u => u.combine('destroyed', [false, true] as const))\n  .fn(t => {\n    const { destroyed } = t.params;\n    const texture = t.trackForCleanup(\n      t.device.createTexture({\n        size: [1, 1, 1],\n        format: 'rgba8unorm',\n        usage: GPUTextureUsage.COPY_SRC,\n      })\n    );\n    const buffer = t.trackForCleanup(\n      t.device.createBuffer({ size: 4, usage: GPUBufferUsage.COPY_DST })\n    );\n\n    const encoder = t.device.createCommandEncoder();\n    encoder.copyTextureToBuffer({ texture }, { buffer }, [1, 1, 1]);\n    const commandBuffer = encoder.finish();\n\n    if (destroyed) {\n      buffer.destroy();\n    }\n\n    t.expectValidationError(() => {\n      t.queue.submit([commandBuffer]);\n    }, destroyed);\n  });\n"],"mappings":"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"}