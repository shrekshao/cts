{"version":3,"file":"maxStorageTexturesPerShaderStage.spec.js","names":["range","reorder","kReorderOrderKeys","GPUConst","kMaximumLimitBaseParams","makeLimitTestGroup","kBindGroupTests","getPerStageWGSLForBindingCombinationStorageTextures","getPipelineTypeForBindingCombination","kExtraLimits","maxFragmentCombinedOutputResources","limit","g","description","createBindGroupLayout","device","visibility","order","numBindings","entries","i","binding","storageTexture","format","test","desc","params","combine","ShaderStage","FRAGMENT","COMPUTE","fn","t","limitTest","testValueName","testDeviceWithRequestedMaximumLimits","testValue","shouldError","expectValidationError","kNumGroups","bindGroupLayouts","minInGroup","Math","floor","numInGroup","createPipelineLayout","async","bindingCombination","bindGroupTest","pipelineType","actualLimit","limits","code","j","module","createShaderModule","testCreatePipeline"],"sources":["../../../../../../src/webgpu/api/validation/capability_checks/limits/maxStorageTexturesPerShaderStage.spec.ts"],"sourcesContent":["import {\n  range,\n  reorder,\n  ReorderOrder,\n  kReorderOrderKeys,\n} from '../../../../../common/util/util.js';\nimport { GPUConst } from '../../../../constants.js';\n\nimport {\n  kMaximumLimitBaseParams,\n  makeLimitTestGroup,\n  kBindGroupTests,\n  LimitsRequest,\n  getPerStageWGSLForBindingCombinationStorageTextures,\n  getPipelineTypeForBindingCombination,\n  BindingCombination,\n} from './limit_utils.js';\n\nconst kExtraLimits: LimitsRequest = {\n  maxFragmentCombinedOutputResources: 'adapterLimit',\n};\n\nconst limit = 'maxStorageTexturesPerShaderStage';\nexport const { g, description } = makeLimitTestGroup(limit);\n\nfunction createBindGroupLayout(\n  device: GPUDevice,\n  visibility: number,\n  order: ReorderOrder,\n  numBindings: number\n) {\n  return device.createBindGroupLayout({\n    entries: reorder(\n      order,\n      range(numBindings, i => ({\n        binding: i,\n        visibility,\n        storageTexture: { format: 'rgba8unorm' },\n      }))\n    ),\n  });\n}\n\ng.test('createBindGroupLayout,at_over')\n  .desc(\n    `\n  Test using at and over ${limit} limit in createBindGroupLayout\n  \n  Note: We also test order to make sure the implementation isn't just looking\n  at just the last entry.\n  `\n  )\n  .params(\n    kMaximumLimitBaseParams\n      .combine('visibility', [\n        GPUConst.ShaderStage.FRAGMENT,\n        GPUConst.ShaderStage.COMPUTE,\n        GPUConst.ShaderStage.FRAGMENT | GPUConst.ShaderStage.COMPUTE,\n      ])\n      .combine('order', kReorderOrderKeys)\n  )\n  .fn(async t => {\n    const { limitTest, testValueName, visibility, order } = t.params;\n    await t.testDeviceWithRequestedMaximumLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, shouldError }) => {\n        await t.expectValidationError(\n          () => createBindGroupLayout(device, visibility, order, testValue),\n          shouldError\n        );\n      }\n    );\n  });\n\ng.test('createPipelineLayout,at_over')\n  .desc(\n    `\n  Test using at and over ${limit} limit in createPipelineLayout\n  \n  Note: We also test order to make sure the implementation isn't just looking\n  at just the last entry.\n  `\n  )\n  .params(\n    kMaximumLimitBaseParams\n      .combine('visibility', [\n        GPUConst.ShaderStage.FRAGMENT,\n        GPUConst.ShaderStage.COMPUTE,\n        GPUConst.ShaderStage.FRAGMENT | GPUConst.ShaderStage.COMPUTE,\n      ])\n      .combine('order', kReorderOrderKeys)\n  )\n  .fn(async t => {\n    const { limitTest, testValueName, visibility, order } = t.params;\n    await t.testDeviceWithRequestedMaximumLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, shouldError }) => {\n        const kNumGroups = 3;\n        const bindGroupLayouts = range(kNumGroups, i => {\n          const minInGroup = Math.floor(testValue / kNumGroups);\n          const numInGroup = i ? minInGroup : testValue - minInGroup * (kNumGroups - 1);\n          return createBindGroupLayout(device, visibility, order, numInGroup);\n        });\n        await t.expectValidationError(\n          () => device.createPipelineLayout({ bindGroupLayouts }),\n          shouldError\n        );\n      }\n    );\n  });\n\ng.test('createPipeline,at_over')\n  .desc(\n    `\n  Test using createRenderPipeline(Async) and createComputePipeline(Async) at and over ${limit} limit\n  \n  Note: We also test order to make sure the implementation isn't just looking\n  at just the last entry.\n  `\n  )\n  .params(\n    kMaximumLimitBaseParams\n      .combine('async', [false, true] as const)\n      .combine('bindingCombination', ['fragment', 'compute'] as BindingCombination[])\n      .combine('order', kReorderOrderKeys)\n      .combine('bindGroupTest', kBindGroupTests)\n  )\n  .fn(async t => {\n    const { limitTest, testValueName, async, bindingCombination, order, bindGroupTest } = t.params;\n    const pipelineType = getPipelineTypeForBindingCombination(bindingCombination);\n\n    await t.testDeviceWithRequestedMaximumLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, actualLimit, shouldError }) => {\n        if (\n          bindingCombination === 'fragment' &&\n          testValue > device.limits.maxFragmentCombinedOutputResources\n        ) {\n          return;\n        }\n\n        const code = getPerStageWGSLForBindingCombinationStorageTextures(\n          bindingCombination,\n          order,\n          bindGroupTest,\n          (i, j) => `var u${j}_${i}: texture_storage_2d<rgba8unorm, write>`,\n          (i, j) => `textureStore(u${j}_${i}, vec2u(0), vec4f(1));`,\n          testValue\n        );\n        const module = device.createShaderModule({ code });\n\n        await t.testCreatePipeline(\n          pipelineType,\n          async,\n          module,\n          shouldError,\n          `actualLimit: ${actualLimit}, testValue: ${testValue}\\n:${code}`\n        );\n      },\n      kExtraLimits\n    );\n  });\n"],"mappings":"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"}