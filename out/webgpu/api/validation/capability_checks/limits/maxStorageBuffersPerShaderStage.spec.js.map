{"version":3,"file":"maxStorageBuffersPerShaderStage.spec.js","names":["range","reorder","kReorderOrderKeys","GPUConst","kLimitBaseParams","makeLimitTestGroup","kBindGroupTests","kBindingCombinations","getPipelineTypeForBindingCombination","getPipelineAsyncTypeForBindingCombination","getPerStageWGSLForBindingCombination","limit","g","description","createBindGroupLayout","device","visibility","type","order","numBindings","entries","i","binding","buffer","test","desc","params","combine","ShaderStage","VERTEX","FRAGMENT","COMPUTE","fn","t","limitTest","testValueName","testDeviceWithRequestedLimits","testValue","shouldError","expectValidationError","kNumGroups","bindGroupLayouts","minInGroup","Math","floor","numInGroup","createPipelineLayout","bindingCombination","bindGroupTest","pipelineType","actualLimit","code","j","module","createShaderModule","createPipeline","shouldRejectConditionally","createPipelineAsync"],"sources":["../../../../../../src/webgpu/api/validation/capability_checks/limits/maxStorageBuffersPerShaderStage.spec.ts"],"sourcesContent":["import {\n  range,\n  reorder,\n  kReorderOrderKeys,\n  ReorderOrder,\n} from '../../../../../common/util/util.js';\nimport { GPUConst } from '../../../../constants.js';\n\nimport {\n  kLimitBaseParams,\n  makeLimitTestGroup,\n  kBindGroupTests,\n  kBindingCombinations,\n  getPipelineTypeForBindingCombination,\n  getPipelineAsyncTypeForBindingCombination,\n  getPerStageWGSLForBindingCombination,\n} from './limit_utils.js';\n\nconst limit = 'maxStorageBuffersPerShaderStage';\nexport const { g, description } = makeLimitTestGroup(limit);\n\nfunction createBindGroupLayout(\n  device: GPUDevice,\n  visibility: number,\n  type: GPUBufferBindingType,\n  order: ReorderOrder,\n  numBindings: number\n) {\n  return device.createBindGroupLayout({\n    entries: reorder(\n      order,\n      range(numBindings, i => ({\n        binding: i,\n        visibility,\n        buffer: { type },\n      }))\n    ),\n  });\n}\n\ng.test('createBindGroupLayout,at_over')\n  .desc(\n    `\n  Test using at and over ${limit} limit in createBindGroupLayout\n  \n  Note: We also test order to make sure the implementation isn't just looking\n  at just the last entry.\n  `\n  )\n  .params(\n    kLimitBaseParams\n      .combine('visibility', [\n        GPUConst.ShaderStage.VERTEX,\n        GPUConst.ShaderStage.FRAGMENT,\n        GPUConst.ShaderStage.VERTEX | GPUConst.ShaderStage.FRAGMENT,\n        GPUConst.ShaderStage.COMPUTE,\n        GPUConst.ShaderStage.VERTEX | GPUConst.ShaderStage.COMPUTE,\n        GPUConst.ShaderStage.FRAGMENT | GPUConst.ShaderStage.COMPUTE,\n        GPUConst.ShaderStage.VERTEX | GPUConst.ShaderStage.FRAGMENT | GPUConst.ShaderStage.COMPUTE,\n      ])\n      .combine('type', ['storage', 'read-only-storage'] as GPUBufferBindingType[])\n      .combine('order', kReorderOrderKeys)\n  )\n  .fn(async t => {\n    const { limitTest, testValueName, visibility, order, type } = t.params;\n\n    if (visibility & GPUConst.ShaderStage.VERTEX && type === 'storage') {\n      // vertex stage does not support storage buffers\n      return;\n    }\n\n    await t.testDeviceWithRequestedLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, shouldError }) => {\n        await t.expectValidationError(() => {\n          createBindGroupLayout(device, visibility, type, order, testValue);\n        }, shouldError);\n      }\n    );\n  });\n\ng.test('createPipelineLayout,at_over')\n  .desc(\n    `\n  Test using at and over ${limit} limit in createPipelineLayout\n  \n  Note: We also test order to make sure the implementation isn't just looking\n  at just the last entry.\n  `\n  )\n  .params(\n    kLimitBaseParams\n      .combine('visibility', [\n        GPUConst.ShaderStage.VERTEX,\n        GPUConst.ShaderStage.FRAGMENT,\n        GPUConst.ShaderStage.VERTEX | GPUConst.ShaderStage.FRAGMENT,\n        GPUConst.ShaderStage.COMPUTE,\n        GPUConst.ShaderStage.VERTEX | GPUConst.ShaderStage.COMPUTE,\n        GPUConst.ShaderStage.FRAGMENT | GPUConst.ShaderStage.COMPUTE,\n        GPUConst.ShaderStage.VERTEX | GPUConst.ShaderStage.FRAGMENT | GPUConst.ShaderStage.COMPUTE,\n      ])\n      .combine('type', ['storage', 'read-only-storage'] as GPUBufferBindingType[])\n      .combine('order', kReorderOrderKeys)\n  )\n  .fn(async t => {\n    const { limitTest, testValueName, visibility, order, type } = t.params;\n\n    if (visibility & GPUConst.ShaderStage.VERTEX && type === 'storage') {\n      // vertex stage does not support storage buffers\n      return;\n    }\n\n    await t.testDeviceWithRequestedLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, shouldError }) => {\n        const kNumGroups = 3;\n        const bindGroupLayouts = range(kNumGroups, i => {\n          const minInGroup = Math.floor(testValue / kNumGroups);\n          const numInGroup = i ? minInGroup : testValue - minInGroup * (kNumGroups - 1);\n          return createBindGroupLayout(device, visibility, type, order, numInGroup);\n        });\n        await t.expectValidationError(\n          () => device.createPipelineLayout({ bindGroupLayouts }),\n          shouldError\n        );\n      }\n    );\n  });\n\ng.test('createPipeline,at_over')\n  .desc(\n    `\n  Test using createRenderPipeline and createComputePipeline at and over ${limit} limit\n  \n  Note: We also test order to make sure the implementation isn't just looking\n  at just the last entry.\n  `\n  )\n  .params(\n    kLimitBaseParams\n      .combine('bindingCombination', kBindingCombinations)\n      .combine('order', kReorderOrderKeys)\n      .combine('bindGroupTest', kBindGroupTests)\n  )\n  .fn(async t => {\n    const { limitTest, testValueName, bindingCombination, order, bindGroupTest } = t.params;\n    const pipelineType = getPipelineTypeForBindingCombination(bindingCombination);\n\n    await t.testDeviceWithRequestedLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, actualLimit, shouldError }) => {\n        const code = getPerStageWGSLForBindingCombination(\n          bindingCombination,\n          order,\n          bindGroupTest,\n          (i, j) => `var<storage> u${j}_${i}: f32`,\n          (i, j) => `_ = u${j}_${i};`,\n          testValue\n        );\n        const module = device.createShaderModule({ code });\n\n        await t.expectValidationError(\n          () => {\n            t.createPipeline(pipelineType, module);\n          },\n          shouldError,\n          `actualLimit: ${actualLimit}, testValue: ${testValue}\\n:${code}`\n        );\n      }\n    );\n  });\n\ng.test('createPipelineAsync,at_over')\n  .desc(\n    `\n  Test using createRenderPipelineAsync and createComputePipelineAsync at and over ${limit} limit\n  \n  Note: We also test order to make sure the implementation isn't just looking\n  at just the last entry.\n  `\n  )\n  .params(\n    kLimitBaseParams\n      .combine('bindingCombination', kBindingCombinations)\n      .combine('order', kReorderOrderKeys)\n      .combine('bindGroupTest', kBindGroupTests)\n  )\n  .fn(async t => {\n    const { limitTest, testValueName, bindingCombination, order, bindGroupTest } = t.params;\n    const pipelineType = getPipelineAsyncTypeForBindingCombination(bindingCombination);\n\n    await t.testDeviceWithRequestedLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, actualLimit, shouldError }) => {\n        const code = getPerStageWGSLForBindingCombination(\n          bindingCombination,\n          order,\n          bindGroupTest,\n          (i, j) => `var<storage> u${j}_${i}: f32`,\n          (i, j) => `_ = u${j}_${i};`,\n          testValue\n        );\n        const module = device.createShaderModule({ code });\n\n        await t.shouldRejectConditionally(\n          'GPUPipelineError',\n          t.createPipelineAsync(pipelineType, module),\n          shouldError,\n          `actualLimit: ${actualLimit}, testValue: ${testValue}\\n:${code}`\n        );\n      }\n    );\n  });\n"],"mappings":"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"}