{"version":3,"sources":["../../../../../../src/webgpu/api/validation/encoding/cmds/compute_pass.spec.ts"],"names":["description","makeTestGroup","DefaultLimits","kResourceStates","ValidationTest","F","createComputePipeline","state","createNoOpComputePipeline","createErrorComputePipeline","createIndirectBuffer","data","descriptor","size","byteLength","usage","GPUBufferUsage","INDIRECT","COPY_DST","device","pushErrorScope","buffer","createBuffer","popErrorScope","queue","writeBuffer","destroy","g","test","desc","params","u","beginSubcases","combine","fn","t","pipeline","encoder","validateFinishAndSubmitGivenState","createEncoder","setPipeline","paramsSubcasesOnly","unimplemented","kMaxDispatch","maxComputeWorkgroupsPerDimension","dispatchType","largeDimIndex","smallDimValue","largeDimValue","workSizes","validateFinishAndSubmit","x","y","z","dispatch","dispatchIndirect","Uint32Array","shouldError","kBufferData","fill","BYTES_PER_ELEMENT","offset","finishShouldError"],"mappings":"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","sourcesContent":["export const description = `\nAPI validation test for compute pass\n\nDoes **not** test usage scopes (resource_usages/) or programmable pass stuff (programmable_pass).\n`;\n\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\nimport { DefaultLimits } from '../../../../constants.js';\nimport { kResourceStates, ResourceState } from '../../../../gpu_test.js';\nimport { ValidationTest } from '../../validation_test.js';\n\nclass F extends ValidationTest {\n  createComputePipeline(state: 'valid' | 'invalid'): GPUComputePipeline {\n    if (state === 'valid') {\n      return this.createNoOpComputePipeline();\n    }\n\n    return this.createErrorComputePipeline();\n  }\n\n  createIndirectBuffer(state: ResourceState, data: Uint32Array): GPUBuffer {\n    const descriptor: GPUBufferDescriptor = {\n      size: data.byteLength,\n      usage: GPUBufferUsage.INDIRECT | GPUBufferUsage.COPY_DST,\n    };\n\n    if (state === 'invalid') {\n      descriptor.usage = 0xffff; // Invalid GPUBufferUsage\n    }\n\n    this.device.pushErrorScope('validation');\n    const buffer = this.device.createBuffer(descriptor);\n    this.device.popErrorScope();\n\n    if (state === 'valid') {\n      this.queue.writeBuffer(buffer, 0, data);\n    }\n\n    if (state === 'destroyed') {\n      buffer.destroy();\n    }\n\n    return buffer;\n  }\n}\n\nexport const g = makeTestGroup(F);\n\ng.test('set_pipeline')\n  .desc(\n    `\nsetPipeline should generate an error iff using an 'invalid' pipeline.\n`\n  )\n  .params(u => u.beginSubcases().combine('state', ['valid', 'invalid'] as const))\n  .fn(t => {\n    const { state } = t.params;\n    const pipeline = t.createComputePipeline(state);\n\n    const { encoder, validateFinishAndSubmitGivenState } = t.createEncoder('compute pass');\n    encoder.setPipeline(pipeline);\n    validateFinishAndSubmitGivenState(state);\n  });\n\ng.test('pipeline,device_mismatch')\n  .desc('Tests setPipeline cannot be called with a compute pipeline created from another device')\n  .paramsSubcasesOnly(u => u.combine('mismatched', [true, false]))\n  .unimplemented();\n\nconst kMaxDispatch = DefaultLimits.maxComputeWorkgroupsPerDimension;\ng.test('dispatch_sizes')\n  .desc(\n    `Test 'direct' and 'indirect' dispatch with various sizes.\n\n  Only direct dispatches can produce validation errors.\n  Workgroup sizes:\n    - valid: { zero, one, just under limit }\n    - invalid: { just over limit, way over limit }\n\n  TODO: Verify that the invalid cases don't execute any invocations at all.\n`\n  )\n  .params(u =>\n    u\n      .combine('dispatchType', ['direct', 'indirect'] as const)\n      .combine('largeDimValue', [0, 1, kMaxDispatch, kMaxDispatch + 1, 0x7fff_ffff, 0xffff_ffff])\n      .beginSubcases()\n      .combine('largeDimIndex', [0, 1, 2] as const)\n      .combine('smallDimValue', [0, 1])\n  )\n  .fn(t => {\n    const { dispatchType, largeDimIndex, smallDimValue, largeDimValue } = t.params;\n\n    const pipeline = t.createNoOpComputePipeline();\n\n    const workSizes = [smallDimValue, smallDimValue, smallDimValue];\n    workSizes[largeDimIndex] = largeDimValue;\n\n    const { encoder, validateFinishAndSubmit } = t.createEncoder('compute pass');\n    encoder.setPipeline(pipeline);\n    if (dispatchType === 'direct') {\n      const [x, y, z] = workSizes;\n      encoder.dispatch(x, y, z);\n    } else if (dispatchType === 'indirect') {\n      encoder.dispatchIndirect(t.createIndirectBuffer('valid', new Uint32Array(workSizes)), 0);\n    }\n\n    const shouldError =\n      dispatchType === 'direct' &&\n      (workSizes[0] > kMaxDispatch || workSizes[1] > kMaxDispatch || workSizes[2] > kMaxDispatch);\n\n    validateFinishAndSubmit(!shouldError, true);\n  });\n\nconst kBufferData = new Uint32Array(6).fill(1);\ng.test('indirect_dispatch_buffer')\n  .desc(\n    `\nTest dispatchIndirect validation by submitting various dispatches with a no-op pipeline and an\nindirectBuffer with 6 elements.\n- indirectBuffer: {'valid', 'invalid', 'destroyed'}\n- indirectOffset:\n  - valid, within the buffer: {beginning, middle, end} of the buffer\n  - invalid, non-multiple of 4\n  - invalid, the last element is outside the buffer\n`\n  )\n  .paramsSubcasesOnly(u =>\n    u //\n      .combine('state', kResourceStates)\n      .combine('offset', [\n        // valid (for 'valid' buffers)\n        0,\n        Uint32Array.BYTES_PER_ELEMENT,\n        kBufferData.byteLength - 3 * Uint32Array.BYTES_PER_ELEMENT,\n        // invalid, non-multiple of 4 offset\n        1,\n        // invalid, last element outside buffer\n        kBufferData.byteLength - 2 * Uint32Array.BYTES_PER_ELEMENT,\n      ])\n  )\n  .fn(t => {\n    const { state, offset } = t.params;\n    const pipeline = t.createNoOpComputePipeline();\n    const buffer = t.createIndirectBuffer(state, kBufferData);\n\n    const { encoder, validateFinishAndSubmit } = t.createEncoder('compute pass');\n    encoder.setPipeline(pipeline);\n    encoder.dispatchIndirect(buffer, offset);\n\n    const finishShouldError =\n      state === 'invalid' ||\n      offset % 4 !== 0 ||\n      offset + 3 * Uint32Array.BYTES_PER_ELEMENT > kBufferData.byteLength;\n    validateFinishAndSubmit(!finishShouldError, state !== 'destroyed');\n  });\n\ng.test('indirect_dispatch_buffer,device_mismatch')\n  .desc(\n    'Tests dispatchIndirect cannot be called with an indirect buffer created from another device'\n  )\n  .paramsSubcasesOnly(u => u.combine('mismatched', [true, false]))\n  .unimplemented();\n"],"file":"compute_pass.spec.js"}