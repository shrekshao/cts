{"version":3,"sources":["../../../../../../src/webgpu/api/validation/encoding/cmds/compute_pass.spec.ts"],"names":["description","params","poptions","makeTestGroup","ValidationTest","F","createComputePipeline","state","createNoOpComputePipeline","createErrorComputePipeline","createIndirectBuffer","data","descriptor","size","byteLength","usage","GPUBufferUsage","INDIRECT","COPY_DST","device","pushErrorScope","buffer","createBuffer","popErrorScope","queue","writeBuffer","destroy","g","test","desc","fn","t","pipeline","encoder","finish","createEncoder","setPipeline","expectValidationError","combine","x","y","z","workSizes","dispatchType","dispatch","dispatchIndirect","Uint32Array","submit","kBufferData","fill","BYTES_PER_ELEMENT","offset"],"mappings":"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","sourcesContent":["export const description = `\nAPI validation test for compute pass\n`;\n\nimport { params, poptions } from '../../../../../common/framework/params_builder.js';\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\n\nimport { ValidationTest } from './../../validation_test.js';\n\nclass F extends ValidationTest {\n  createComputePipeline(state: 'valid' | 'invalid'): GPUComputePipeline {\n    if (state === 'valid') {\n      return this.createNoOpComputePipeline();\n    }\n\n    return this.createErrorComputePipeline();\n  }\n\n  createIndirectBuffer(state: 'valid' | 'invalid' | 'destroyed', data: Uint32Array): GPUBuffer {\n    const descriptor: GPUBufferDescriptor = {\n      size: data.byteLength,\n      usage: GPUBufferUsage.INDIRECT | GPUBufferUsage.COPY_DST,\n    };\n\n    if (state === 'invalid') {\n      descriptor.usage = 0xffff; // Invalid GPUBufferUsage\n    }\n\n    this.device.pushErrorScope('validation');\n    const buffer = this.device.createBuffer(descriptor);\n    this.device.popErrorScope();\n\n    if (state === 'valid') {\n      this.queue.writeBuffer(buffer, 0, data);\n    }\n\n    if (state === 'destroyed') {\n      buffer.destroy();\n    }\n\n    return buffer;\n  }\n}\n\nexport const g = makeTestGroup(F);\n\ng.test('set_pipeline')\n  .desc(\n    `\nsetPipeline should generate an error iff using an 'invalid' pipeline.\n`\n  )\n  .params(poptions('state', ['valid', 'invalid'] as const))\n  .fn(t => {\n    const pipeline = t.createComputePipeline(t.params.state);\n    const { encoder, finish } = t.createEncoder('compute pass');\n    encoder.setPipeline(pipeline);\n    t.expectValidationError(() => {\n      finish();\n    }, t.params.state === 'invalid');\n  });\n\ng.test('dispatch_sizes')\n  .desc(\n    `\nTest 'direct' and 'indirect' dispatch with various sizes.\n  - workgroup sizes:\n    - valid, {[0, 0, 0], [1, 1, 1]}\n    - invalid,  <fill number here>\n`\n  )\n  .params(\n    params()\n      .combine(poptions('dispatchType', ['direct', 'indirect'] as const))\n      .combine(\n        poptions('workSizes', [\n          [0, 0, 0],\n          [1, 1, 1],\n          // TODO: Add tests for workSizes right under and above upper limit once the limit has\n          //  been decided.\n        ] as const)\n      )\n  )\n  .fn(t => {\n    const pipeline = t.createNoOpComputePipeline();\n    const [x, y, z] = t.params.workSizes;\n    const { encoder, finish } = t.createEncoder('compute pass');\n    encoder.setPipeline(pipeline);\n    if (t.params.dispatchType === 'direct') {\n      encoder.dispatch(x, y, z);\n    } else if (t.params.dispatchType === 'indirect') {\n      encoder.dispatchIndirect(t.createIndirectBuffer('valid', new Uint32Array([x, y, z])), 0);\n    }\n    t.queue.submit([finish()]);\n  });\n\nconst kBufferData = new Uint32Array(6).fill(1);\ng.test('indirect_dispatch_buffer')\n  .desc(\n    `\nTest dispatchIndirect validation by submitting various dispatches with a no-op pipeline and an\nindirectBuffer with 6 elements.\n- indirectBuffer: {'valid', 'invalid', 'destroyed'}\n- indirectOffset:\n  - valid, within the buffer: {beginning, middle, end} of the buffer\n  - invalid, non-multiple of 4\n  - invalid, the last element is outside the buffer\n`\n  )\n  .params(\n    params()\n      .combine(poptions('state', ['valid', 'invalid', 'destroyed'] as const))\n      .combine(\n        poptions('offset', [\n          0, // valid for 'valid' buffers\n          Uint32Array.BYTES_PER_ELEMENT, // valid for 'valid' buffers\n          kBufferData.byteLength - 3 * Uint32Array.BYTES_PER_ELEMENT, // valid for 'valid' buffers\n          1, // invalid, non-multiple of 4 offset\n          // invalid, last element outside buffer\n          kBufferData.byteLength - Uint32Array.BYTES_PER_ELEMENT,\n        ])\n      )\n  )\n  .fn(t => {\n    const { state, offset } = t.params;\n    const pipeline = t.createNoOpComputePipeline();\n    const buffer = t.createIndirectBuffer(state, kBufferData);\n    const { encoder, finish } = t.createEncoder('compute pass');\n    encoder.setPipeline(pipeline);\n    t.expectValidationError(() => {\n      encoder.dispatchIndirect(buffer, offset);\n      t.queue.submit([finish()]);\n    }, state !== 'valid' || offset % 4 !== 0 || offset + 3 * Uint32Array.BYTES_PER_ELEMENT > kBufferData.byteLength);\n  });\n"],"file":"compute_pass.spec.js"}