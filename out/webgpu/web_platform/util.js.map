{"version":3,"file":"util.js","names":["SkipTestCase","getResourcePath","makeTable","timeout","ErrorWithExtra","raceWithRejectOnTimeout","kVideoInfo","undefined","startPlayingAndWaitForVideo","video","callback","Promise","resolve","reject","callbackAndResolve","ex","error","message","addEventListener","event","requestVideoFrameCallback","timeWatcher","currentTime","requestAnimationFrame","loop","muted","preload","play","catch","waitForNextTask","promise","callbackHelper","waitForNextFrame","getVideoFrameFromVideoElement","test","captureStream","skip","videoTrack","getVideoTracks","trackProcessor","MediaStreamTrackProcessor","track","transformer","TransformStream","transform","videoFrame","controller","stop","flush","terminate","trackGenerator","MediaStreamTrackGenerator","kind","readable","pipeThrough","pipeTo","writable","getVideoElement","t","videoName","videoElement","document","createElement","videoInfo","canPlayType","mimeType","videoUrl","src","timeoutMessage","promiseWithoutTimeout"],"sources":["../../../src/webgpu/web_platform/util.ts"],"sourcesContent":["import { Fixture, SkipTestCase } from '../../common/framework/fixture.js';\nimport { getResourcePath } from '../../common/framework/resources.js';\nimport { makeTable } from '../../common/util/data_tables.js';\nimport { timeout } from '../../common/util/timeout.js';\nimport { ErrorWithExtra, raceWithRejectOnTimeout } from '../../common/util/util.js';\nimport { GPUTest } from '../gpu_test.js';\n\ndeclare global {\n  interface HTMLMediaElement {\n    // Add captureStream() support for HTMLMediaElement from\n    // https://w3c.github.io/mediacapture-fromelement/#dom-htmlmediaelement-capturestream\n    captureStream(): MediaStream;\n  }\n}\n\nexport const kVideoInfo = /* prettier-ignore */ makeTable(\n  ['mimeType'] as const,\n  [undefined] as const, {\n// All video names\n'four-colors-vp8-bt601.webm'  : ['video/webm; codecs=vp8'],\n'four-colors-theora-bt601.ogv': ['video/ogg; codecs=theora'],\n'four-colors-h264-bt601.mp4'  : ['video/mp4; codecs=avc1.4d400c'],\n'four-colors-vp9-bt601.webm'  : ['video/webm; codecs=vp9'],\n'four-colors-vp9-bt709.webm'  : ['video/webm; codecs=vp9'],\n'four-colors-vp9-bt2020.webm' : ['video/webm; codecs=vp9'],\n'four-colors-h264-bt601-rotate-90.mp4'  : ['video/mp4; codecs=avc1.4d400c'],\n'four-colors-h264-bt601-rotate-180.mp4'  : ['video/mp4; codecs=avc1.4d400c'],\n'four-colors-h264-bt601-rotate-270.mp4'  : ['video/mp4; codecs=avc1.4d400c']\n} as const);\nexport type VideoName = keyof typeof kVideoInfo;\n\n/**\n * Starts playing a video and waits for it to be consumable.\n * Returns a promise which resolves after `callback` (which may be async) completes.\n *\n * @param video An HTML5 Video element.\n * @param callback Function to call when video is ready.\n *\n * Adapted from https://github.com/KhronosGroup/WebGL/blob/main/sdk/tests/js/webgl-test-utils.js\n */\nexport function startPlayingAndWaitForVideo(\n  video: HTMLVideoElement,\n  callback: () => unknown | Promise<unknown>\n): Promise<void> {\n  return raceWithRejectOnTimeout(\n    new Promise((resolve, reject) => {\n      const callbackAndResolve = () =>\n        void (async () => {\n          try {\n            await callback();\n            resolve();\n          } catch (ex) {\n            reject();\n          }\n        })();\n      if (video.error) {\n        reject(\n          new ErrorWithExtra('Video.error: ' + video.error.message, () => ({ error: video.error }))\n        );\n        return;\n      }\n\n      video.addEventListener(\n        'error',\n        event => reject(new ErrorWithExtra('Video received \"error\" event', () => ({ event }))),\n        true\n      );\n\n      if ('requestVideoFrameCallback' in video) {\n        video.requestVideoFrameCallback(() => {\n          callbackAndResolve();\n        });\n      } else {\n        // If requestVideoFrameCallback isn't available, check each frame if the video has advanced.\n        const timeWatcher = () => {\n          if (video.currentTime > 0) {\n            callbackAndResolve();\n          } else {\n            requestAnimationFrame(timeWatcher);\n          }\n        };\n        timeWatcher();\n      }\n\n      video.loop = true;\n      video.muted = true;\n      video.preload = 'auto';\n      video.play().catch(reject);\n    }),\n    2000,\n    'Video never became ready'\n  );\n}\n\n/**\n * Fire a `callback` when the script animation reaches a new frame.\n * Returns a promise which resolves after `callback` (which may be async) completes.\n */\nexport function waitForNextTask(callback: () => unknown | Promise<unknown>): Promise<void> {\n  const { promise, callbackAndResolve } = callbackHelper(callback, 'wait for next task timed out');\n  timeout(() => {\n    callbackAndResolve();\n  }, 0);\n\n  return promise;\n}\n\n/**\n * Fire a `callback` when the video reaches a new frame.\n * Returns a promise which resolves after `callback` (which may be async) completes.\n *\n * MAINTENANCE_TODO: Find a way to implement this for browsers without requestVideoFrameCallback as\n * well, similar to the timeWatcher path in startPlayingAndWaitForVideo. If that path is proven to\n * work well, we can consider getting rid of the requestVideoFrameCallback path.\n */\nexport function waitForNextFrame(\n  video: HTMLVideoElement,\n  callback: () => unknown | Promise<unknown>\n): Promise<void> {\n  const { promise, callbackAndResolve } = callbackHelper(callback, 'waitForNextFrame timed out');\n\n  if ('requestVideoFrameCallback' in video) {\n    video.requestVideoFrameCallback(() => {\n      callbackAndResolve();\n    });\n  } else {\n    throw new SkipTestCase('waitForNextFrame currently requires requestVideoFrameCallback');\n  }\n\n  return promise;\n}\n\nexport async function getVideoFrameFromVideoElement(\n  test: Fixture,\n  video: HTMLVideoElement\n): Promise<VideoFrame> {\n  if (video.captureStream === undefined) {\n    test.skip('HTMLVideoElement.captureStream is not supported');\n  }\n\n  return raceWithRejectOnTimeout(\n    new Promise<VideoFrame>((resolve, reject) => {\n      const videoTrack: MediaStreamVideoTrack = video.captureStream().getVideoTracks()[0];\n      const trackProcessor: MediaStreamTrackProcessor<VideoFrame> = new MediaStreamTrackProcessor({\n        track: videoTrack,\n      });\n      const transformer: TransformStream = new TransformStream({\n        transform(videoFrame, controller) {\n          videoTrack.stop();\n          resolve(videoFrame);\n        },\n        flush(controller) {\n          controller.terminate();\n        },\n      });\n      const trackGenerator: MediaStreamTrackGenerator<VideoFrame> = new MediaStreamTrackGenerator({\n        kind: 'video',\n      });\n      trackProcessor.readable\n        .pipeThrough(transformer)\n        .pipeTo(trackGenerator.writable)\n        .catch(() => {});\n    }),\n    2000,\n    'Video never became ready'\n  );\n}\n\n/**\n * Create HTMLVideoElement based on VideoName. Check whether video is playable in current\n * browser environment.\n * Returns a HTMLVideoElement.\n *\n * @param t: GPUTest that requires getting HTMLVideoElement\n * @param videoName: Required video name\n *\n */\nexport function getVideoElement(t: GPUTest, videoName: VideoName): HTMLVideoElement {\n  const videoElement = document.createElement('video');\n  const videoInfo = kVideoInfo[videoName];\n\n  if (videoElement.canPlayType(videoInfo.mimeType) === '') {\n    t.skip('Video codec is not supported');\n  }\n\n  const videoUrl = getResourcePath(videoName);\n  videoElement.src = videoUrl;\n\n  return videoElement;\n}\n\n/**\n * Helper for doing something inside of a (possibly async) callback (directly, not in a following\n * microtask), and returning a promise when the callback is done.\n * MAINTENANCE_TODO: Use this in startPlayingAndWaitForVideo (and make sure it works).\n */\nfunction callbackHelper(\n  callback: () => unknown | Promise<unknown>,\n  timeoutMessage: string\n): { promise: Promise<void>; callbackAndResolve: () => void } {\n  let callbackAndResolve: () => void;\n\n  const promiseWithoutTimeout = new Promise<void>((resolve, reject) => {\n    callbackAndResolve = () =>\n      void (async () => {\n        try {\n          await callback(); // catches both exceptions and rejections\n          resolve();\n        } catch (ex) {\n          reject(ex);\n        }\n      })();\n  });\n  const promise = raceWithRejectOnTimeout(promiseWithoutTimeout, 2000, timeoutMessage);\n  return { promise, callbackAndResolve: callbackAndResolve! };\n}\n"],"mappings":"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"}