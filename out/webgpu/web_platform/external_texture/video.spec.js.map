{"version":3,"file":"video.spec.js","names":["description","getResourcePath","makeTestGroup","makeTable","GPUTest","TextureTestMixin","startPlayingAndWaitForVideo","getVideoColorSpaceInit","getVideoFrameFromVideoElement","waitForNextFrame","kHeight","kWidth","kFormat","kVideoInfo","undefined","kVideoExpectations","videoName","_redExpectation","Uint8Array","_greenExpectation","g","createExternalTextureSamplingTestPipeline","t","pipeline","device","createRenderPipeline","layout","vertex","module","createShaderModule","code","entryPoint","fragment","targets","format","primitive","topology","createExternalTextureSamplingTestBindGroup","source","linearSampler","createSampler","externalTexture","importExternalTexture","bindGroup","createBindGroup","getBindGroupLayout","entries","binding","resource","getVideoElementAndInfo","sourceType","VideoFrame","skip","videoElement","document","createElement","videoInfo","canPlayType","mimeType","videoUrl","src","test","desc","params","u","combine","combineWithParams","fn","colorSpace","colorAttachment","createTexture","size","width","height","depthOrArrayLayers","usage","GPUTextureUsage","COPY_SRC","RENDER_ATTACHMENT","commandEncoder","createCommandEncoder","passEncoder","beginRenderPass","colorAttachments","view","createView","clearValue","r","b","a","loadOp","storeOp","setPipeline","setBindGroup","draw","end","queue","submit","finish","expectSinglePixelComparisonsAreOkInTexture","texture","coord","x","y","exp","close","passDescriptor","bindGroupLayout","createBindGroupLayout","visibility","GPUShaderStage","FRAGMENT","useExternalTexture","commandBuffer","expectGPUError","expect","expired","outputTexture","STORAGE_BINDING","createComputePipeline","compute","bg","encoder","pass","beginComputePass","dispatchWorkgroups"],"sources":["../../../../src/webgpu/web_platform/external_texture/video.spec.ts"],"sourcesContent":["export const description = `\nTests for external textures from HTMLVideoElement (and other video-type sources?).\n\n- videos with various encodings/formats (webm vp8, webm vp9, ogg theora, mp4), color spaces\n  (bt.601, bt.709, bt.2020)\n- TODO: enhance with more cases with crop, rotation, etc.\n\nTODO: consider whether external_texture and copyToTexture video tests should be in the same file\n`;\n\nimport { getResourcePath } from '../../../common/framework/resources.js';\nimport { makeTestGroup } from '../../../common/framework/test_group.js';\nimport { makeTable, valueof } from '../../../common/util/data_tables.js';\nimport { GPUTest, TextureTestMixin } from '../../gpu_test.js';\nimport {\n  startPlayingAndWaitForVideo,\n  getVideoColorSpaceInit,\n  getVideoFrameFromVideoElement,\n  waitForNextFrame,\n} from '../../web_platform/util.js';\n\nconst kHeight = 16;\nconst kWidth = 16;\nconst kFormat = 'rgba8unorm';\n\nconst kVideoInfo = /* prettier-ignore */ makeTable(\n                                ['colorSpace',                       'mimeType'] as const,\n                                [   undefined,                        undefined] as const, {\n  // All video names\n  'red-green.webmvp8.webm'    : [    'REC601',         'video/webm; codecs=vp8'],\n  'red-green.theora.ogv'      : [    'REC601',       'video/ogg; codecs=theora'],\n  'red-green.mp4'             : [    'REC601',  'video/mp4; codecs=avc1.4d400c'],\n  'red-green.bt601.vp9.webm'  : [    'REC601',         'video/webm; codecs=vp9'],\n  'red-green.bt709.vp9.webm'  : [    'REC709',         'video/webm; codecs=vp9'],\n  'red-green.bt2020.vp9.webm' : [   'REC2020',         'video/webm; codecs=vp9']\n} as const);\ntype VideoName = keyof typeof kVideoInfo;\ntype VideoInfo = valueof<typeof kVideoInfo>;\n\nconst kVideoExpectations = [\n  {\n    videoName: 'red-green.webmvp8.webm',\n    _redExpectation: new Uint8Array([0xf8, 0x24, 0x00, 0xff]),\n    _greenExpectation: new Uint8Array([0x3f, 0xfb, 0x00, 0xff]),\n  },\n  {\n    videoName: 'red-green.theora.ogv',\n    _redExpectation: new Uint8Array([0xf8, 0x24, 0x00, 0xff]),\n    _greenExpectation: new Uint8Array([0x3f, 0xfb, 0x00, 0xff]),\n  },\n  {\n    videoName: 'red-green.mp4',\n    _redExpectation: new Uint8Array([0xf8, 0x24, 0x00, 0xff]),\n    _greenExpectation: new Uint8Array([0x3f, 0xfb, 0x00, 0xff]),\n  },\n  {\n    videoName: 'red-green.bt601.vp9.webm',\n    _redExpectation: new Uint8Array([0xf8, 0x24, 0x00, 0xff]),\n    _greenExpectation: new Uint8Array([0x3f, 0xfb, 0x00, 0xff]),\n  },\n  {\n    videoName: 'red-green.bt709.vp9.webm',\n    _redExpectation: new Uint8Array([0xff, 0x00, 0x00, 0xff]),\n    _greenExpectation: new Uint8Array([0x00, 0xff, 0x00, 0xff]),\n  },\n  {\n    videoName: 'red-green.bt2020.vp9.webm',\n    _redExpectation: new Uint8Array([0xff, 0x00, 0x00, 0xff]),\n    _greenExpectation: new Uint8Array([0x00, 0xff, 0x00, 0xff]),\n  },\n] as const;\n\nexport const g = makeTestGroup(TextureTestMixin(GPUTest));\n\nfunction createExternalTextureSamplingTestPipeline(t: GPUTest): GPURenderPipeline {\n  const pipeline = t.device.createRenderPipeline({\n    layout: 'auto',\n    vertex: {\n      module: t.device.createShaderModule({\n        code: `\n        @vertex fn main(@builtin(vertex_index) VertexIndex : u32) -> @builtin(position) vec4<f32> {\n            var pos = array<vec4<f32>, 6>(\n              vec4<f32>( 1.0,  1.0, 0.0, 1.0),\n              vec4<f32>( 1.0, -1.0, 0.0, 1.0),\n              vec4<f32>(-1.0, -1.0, 0.0, 1.0),\n              vec4<f32>( 1.0,  1.0, 0.0, 1.0),\n              vec4<f32>(-1.0, -1.0, 0.0, 1.0),\n              vec4<f32>(-1.0,  1.0, 0.0, 1.0)\n            );\n            return pos[VertexIndex];\n        }\n        `,\n      }),\n      entryPoint: 'main',\n    },\n    fragment: {\n      module: t.device.createShaderModule({\n        code: `\n        @group(0) @binding(0) var s : sampler;\n        @group(0) @binding(1) var t : texture_external;\n\n        @fragment fn main(@builtin(position) FragCoord : vec4<f32>)\n                                 -> @location(0) vec4<f32> {\n            return textureSampleBaseClampToEdge(t, s, FragCoord.xy / vec2<f32>(16.0, 16.0));\n        }\n        `,\n      }),\n      entryPoint: 'main',\n      targets: [\n        {\n          format: kFormat,\n        },\n      ],\n    },\n    primitive: { topology: 'triangle-list' },\n  });\n\n  return pipeline;\n}\n\nfunction createExternalTextureSamplingTestBindGroup(\n  t: GPUTest,\n  source: HTMLVideoElement | VideoFrame,\n  pipeline: GPURenderPipeline\n): GPUBindGroup {\n  const linearSampler = t.device.createSampler();\n\n  const externalTexture = t.device.importExternalTexture({\n    /* eslint-disable-next-line @typescript-eslint/no-explicit-any */\n    source: source as any,\n  });\n\n  const bindGroup = t.device.createBindGroup({\n    layout: pipeline.getBindGroupLayout(0),\n    entries: [\n      {\n        binding: 0,\n        resource: linearSampler,\n      },\n      {\n        binding: 1,\n        resource: externalTexture,\n      },\n    ],\n  });\n\n  return bindGroup;\n}\n\nfunction getVideoElementAndInfo(\n  t: GPUTest,\n  sourceType: 'VideoElement' | 'VideoFrame',\n  videoName: VideoName\n): { videoElement: HTMLVideoElement; videoInfo: VideoInfo } {\n  if (sourceType === 'VideoFrame' && typeof VideoFrame === 'undefined') {\n    t.skip('WebCodec is not supported');\n  }\n\n  const videoElement = document.createElement('video');\n  const videoInfo = kVideoInfo[videoName];\n\n  if (videoElement.canPlayType(videoInfo.mimeType) === '') {\n    t.skip('Video codec is not supported');\n  }\n\n  const videoUrl = getResourcePath(videoName);\n  videoElement.src = videoUrl;\n\n  return { videoElement, videoInfo };\n}\n\ng.test('importExternalTexture,sample')\n  .desc(\n    `\nTests that we can import an HTMLVideoElement/VideoFrame into a GPUExternalTexture, sample from it\nfor several combinations of video format and color space.\n`\n  )\n  .params(u =>\n    u //\n      .combine('sourceType', ['VideoElement', 'VideoFrame'] as const)\n      .combineWithParams(kVideoExpectations)\n  )\n  .fn(async t => {\n    const sourceType = t.params.sourceType;\n    const { videoElement, videoInfo } = getVideoElementAndInfo(t, sourceType, t.params.videoName);\n\n    await startPlayingAndWaitForVideo(videoElement, async () => {\n      const source =\n        sourceType === 'VideoFrame'\n          ? await getVideoFrameFromVideoElement(\n              t,\n              videoElement,\n              getVideoColorSpaceInit(videoInfo.colorSpace)\n            )\n          : videoElement;\n\n      const colorAttachment = t.device.createTexture({\n        format: kFormat,\n        size: { width: kWidth, height: kHeight, depthOrArrayLayers: 1 },\n        usage: GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n      });\n\n      const pipeline = createExternalTextureSamplingTestPipeline(t);\n      const bindGroup = createExternalTextureSamplingTestBindGroup(t, source, pipeline);\n\n      const commandEncoder = t.device.createCommandEncoder();\n      const passEncoder = commandEncoder.beginRenderPass({\n        colorAttachments: [\n          {\n            view: colorAttachment.createView(),\n            clearValue: { r: 0.0, g: 0.0, b: 0.0, a: 1.0 },\n            loadOp: 'clear',\n            storeOp: 'store',\n          },\n        ],\n      });\n      passEncoder.setPipeline(pipeline);\n      passEncoder.setBindGroup(0, bindGroup);\n      passEncoder.draw(6);\n      passEncoder.end();\n      t.device.queue.submit([commandEncoder.finish()]);\n\n      // For validation, we sample a few pixels away from the edges to avoid compression\n      // artifacts.\n      t.expectSinglePixelComparisonsAreOkInTexture({ texture: colorAttachment }, [\n        // Top left corner should be red.\n        { coord: { x: 5, y: 5 }, exp: t.params._redExpectation },\n        // Bottom right corner should be green.\n        { coord: { x: kWidth - 5, y: kHeight - 5 }, exp: t.params._greenExpectation },\n      ]);\n\n      if (sourceType === 'VideoFrame') (source as VideoFrame).close();\n    });\n  });\n\ng.test('importExternalTexture,expired')\n  .desc(\n    `\nTests that GPUExternalTexture.expired is false when HTMLVideoElement is not updated\nor VideoFrame(webcodec) is alive. And it will be changed to true when imported\nHTMLVideoElement is updated or imported VideoFrame is closed. Using expired\nGPUExternalTexture results in an error.\n\nTODO: Make this test work without requestVideoFrameCallback support (in waitForNextFrame).\n`\n  )\n  .params(u =>\n    u //\n      .combine('sourceType', ['VideoElement', 'VideoFrame'] as const)\n  )\n  .fn(async t => {\n    const sourceType = t.params.sourceType;\n    const { videoElement } = getVideoElementAndInfo(t, sourceType, 'red-green.webmvp8.webm');\n\n    if (!('requestVideoFrameCallback' in videoElement)) {\n      t.skip('HTMLVideoElement.requestVideoFrameCallback is not supported');\n    }\n\n    const colorAttachment = t.device.createTexture({\n      format: kFormat,\n      size: { width: kWidth, height: kHeight, depthOrArrayLayers: 1 },\n      usage: GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n    const passDescriptor = {\n      colorAttachments: [\n        {\n          view: colorAttachment.createView(),\n          clearValue: [0, 0, 0, 1],\n          loadOp: 'clear',\n          storeOp: 'store',\n        },\n      ],\n    } as const;\n\n    const bindGroupLayout = t.device.createBindGroupLayout({\n      entries: [{ binding: 0, visibility: GPUShaderStage.FRAGMENT, externalTexture: {} }],\n    });\n\n    let bindGroup: GPUBindGroup;\n    const useExternalTexture = () => {\n      const commandEncoder = t.device.createCommandEncoder();\n      const passEncoder = commandEncoder.beginRenderPass(passDescriptor);\n      passEncoder.setBindGroup(0, bindGroup);\n      passEncoder.end();\n      return commandEncoder.finish();\n    };\n\n    let externalTexture: GPUExternalTexture;\n    await startPlayingAndWaitForVideo(videoElement, async () => {\n      const source =\n        sourceType === 'VideoFrame'\n          ? await getVideoFrameFromVideoElement(t, videoElement)\n          : videoElement;\n      externalTexture = t.device.importExternalTexture({\n        /* eslint-disable-next-line @typescript-eslint/no-explicit-any */\n        source: source as any,\n      });\n      // Set `bindGroup` here, which will then be used in microtask1 and microtask3.\n      bindGroup = t.device.createBindGroup({\n        layout: bindGroupLayout,\n        entries: [{ binding: 0, resource: externalTexture }],\n      });\n\n      const commandBuffer = useExternalTexture();\n      t.expectGPUError('validation', () => t.device.queue.submit([commandBuffer]), false);\n      t.expect(!externalTexture.expired);\n\n      if (sourceType === 'VideoFrame') {\n        (source as VideoFrame).close();\n        const commandBuffer = useExternalTexture();\n        t.expectGPUError('validation', () => t.device.queue.submit([commandBuffer]), true);\n        t.expect(externalTexture.expired);\n      }\n    });\n\n    if (sourceType === 'VideoElement') {\n      // Update new video frame.\n      await waitForNextFrame(videoElement, () => {\n        // VideoFrame is updated. GPUExternalTexture imported from HTMLVideoElement should be expired.\n        // Using the GPUExternalTexture should result in an error.\n        const commandBuffer = useExternalTexture();\n        t.expectGPUError('validation', () => t.device.queue.submit([commandBuffer]), true);\n        t.expect(externalTexture.expired);\n      });\n    }\n  });\n\ng.test('importExternalTexture,compute')\n  .desc(\n    `\nTests that we can import an HTMLVideoElement/VideoFrame into a GPUExternalTexture and use it in a\ncompute shader, for several combinations of video format and color space.\n`\n  )\n  .params(u =>\n    u //\n      .combine('sourceType', ['VideoElement', 'VideoFrame'] as const)\n      .combineWithParams(kVideoExpectations)\n  )\n  .fn(async t => {\n    const sourceType = t.params.sourceType;\n    const { videoElement, videoInfo } = getVideoElementAndInfo(t, sourceType, t.params.videoName);\n\n    await startPlayingAndWaitForVideo(videoElement, async () => {\n      const source =\n        sourceType === 'VideoFrame'\n          ? await getVideoFrameFromVideoElement(\n              t,\n              videoElement,\n              getVideoColorSpaceInit(videoInfo.colorSpace)\n            )\n          : videoElement;\n      const externalTexture = t.device.importExternalTexture({\n        /* eslint-disable-next-line @typescript-eslint/no-explicit-any */\n        source: source as any,\n      });\n\n      const outputTexture = t.device.createTexture({\n        format: 'rgba8unorm',\n        size: [2, 1, 1],\n        usage: GPUTextureUsage.COPY_SRC | GPUTextureUsage.STORAGE_BINDING,\n      });\n\n      const pipeline = t.device.createComputePipeline({\n        layout: 'auto',\n        compute: {\n          // Shader will load a pixel near the upper left and lower right corners, which are then\n          // stored in storage texture.\n          module: t.device.createShaderModule({\n            code: `\n              @group(0) @binding(0) var t : texture_external;\n              @group(0) @binding(1) var outImage : texture_storage_2d<rgba8unorm, write>;\n\n              @compute @workgroup_size(1) fn main() {\n                var red : vec4<f32> = textureLoad(t, vec2<i32>(10,10));\n                textureStore(outImage, vec2<i32>(0, 0), red);\n                var green : vec4<f32> = textureLoad(t, vec2<i32>(70,118));\n                textureStore(outImage, vec2<i32>(1, 0), green);\n                return;\n              }\n            `,\n          }),\n          entryPoint: 'main',\n        },\n      });\n\n      const bg = t.device.createBindGroup({\n        entries: [\n          { binding: 0, resource: externalTexture },\n          { binding: 1, resource: outputTexture.createView() },\n        ],\n        layout: pipeline.getBindGroupLayout(0),\n      });\n\n      const encoder = t.device.createCommandEncoder();\n      const pass = encoder.beginComputePass();\n      pass.setPipeline(pipeline);\n      pass.setBindGroup(0, bg);\n      pass.dispatchWorkgroups(1);\n      pass.end();\n      t.device.queue.submit([encoder.finish()]);\n\n      t.expectSinglePixelComparisonsAreOkInTexture({ texture: outputTexture }, [\n        // Top left corner should be red.\n        { coord: { x: 0, y: 0 }, exp: t.params._redExpectation },\n        // Bottom right corner should be green.\n        { coord: { x: 1, y: 0 }, exp: t.params._greenExpectation },\n      ]);\n\n      if (sourceType === 'VideoFrame') (source as VideoFrame).close();\n    });\n  });\n"],"mappings":"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"}