{"version":3,"sources":["../../../../src/webgpu/web_platform/external_texture/video.spec.ts"],"names":["description","getResourcePath","makeTestGroup","GPUTest","startPlayingAndWaitForVideo","kHeight","kWidth","kFormat","kVideoExpectations","videoSource","_redExpectation","Uint8Array","_greenExpectation","g","createExternalTextureSamplingTestPipeline","t","pipeline","device","createRenderPipeline","layout","vertex","module","createShaderModule","code","entryPoint","fragment","targets","format","primitive","topology","createExternalTextureSamplingTestBindGroup","video","linearSampler","createSampler","externalTextureDescriptor","source","externalTexture","importExternalTexture","bindGroup","createBindGroup","getBindGroupLayout","entries","binding","resource","test","desc","params","u","combineWithParams","fn","videoUrl","document","createElement","src","colorAttachment","createTexture","size","width","height","depthOrArrayLayers","usage","GPUTextureUsage","COPY_SRC","RENDER_ATTACHMENT","commandEncoder","createCommandEncoder","passEncoder","beginRenderPass","colorAttachments","view","createView","clearValue","r","b","a","loadOp","storeOp","setPipeline","setBindGroup","draw","end","queue","submit","finish","expectSinglePixelIn2DTexture","x","y","exp","passDescriptor","bindGroupLayout","createBindGroupLayout","visibility","GPUShaderStage","FRAGMENT","useExternalTexture","microtask1","Promise","resolve","then","commandBuffer","expectGPUError","expect","expired","microtask3","outputTexture","STORAGE_BINDING","createComputePipeline","compute","bg","encoder","pass","beginComputePass","dispatchWorkgroups"],"mappings":"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","sourcesContent":["export const description = `\nTests for external textures from HTMLVideoElement (and other video-type sources?).\n\n- videos with various encodings, color spaces, metadata\n\nTODO: consider whether external_texture and copyToTexture video tests should be in the same file\n`;\n\nimport { getResourcePath } from '../../../common/framework/resources.js';\nimport { makeTestGroup } from '../../../common/framework/test_group.js';\nimport { GPUTest } from '../../gpu_test.js';\nimport { startPlayingAndWaitForVideo } from '../../web_platform/util.js';\n\nconst kHeight = 16;\nconst kWidth = 16;\nconst kFormat = 'rgba8unorm';\n\nconst kVideoExpectations = [\n  {\n    videoSource: 'red-green.webmvp8.webm',\n    _redExpectation: new Uint8Array([0xd9, 0x00, 0x00, 0xff]),\n    _greenExpectation: new Uint8Array([0x01, 0xef, 0x00, 0xff]),\n  },\n  {\n    videoSource: 'red-green.theora.ogv',\n    _redExpectation: new Uint8Array([0xd9, 0x00, 0x00, 0xff]),\n    _greenExpectation: new Uint8Array([0x01, 0xef, 0x00, 0xff]),\n  },\n  {\n    videoSource: 'red-green.mp4',\n    _redExpectation: new Uint8Array([0xd9, 0x00, 0x00, 0xff]),\n    _greenExpectation: new Uint8Array([0x01, 0xef, 0x00, 0xff]),\n  },\n  {\n    videoSource: 'red-green.bt601.vp9.webm',\n    _redExpectation: new Uint8Array([0xd9, 0x00, 0x00, 0xff]),\n    _greenExpectation: new Uint8Array([0x01, 0xef, 0x00, 0xff]),\n  },\n  {\n    videoSource: 'red-green.bt709.vp9.webm',\n    _redExpectation: new Uint8Array([0xff, 0x00, 0x00, 0xff]),\n    _greenExpectation: new Uint8Array([0x00, 0xff, 0x00, 0xff]),\n  },\n  {\n    videoSource: 'red-green.bt2020.vp9.webm',\n    _redExpectation: new Uint8Array([0xff, 0x00, 0x00, 0xff]),\n    _greenExpectation: new Uint8Array([0x00, 0xff, 0x00, 0xff]),\n  },\n] as const;\n\nexport const g = makeTestGroup(GPUTest);\n\nfunction createExternalTextureSamplingTestPipeline(t: GPUTest): GPURenderPipeline {\n  const pipeline = t.device.createRenderPipeline({\n    layout: 'auto',\n    vertex: {\n      module: t.device.createShaderModule({\n        code: `\n        @stage(vertex) fn main(@builtin(vertex_index) VertexIndex : u32) -> @builtin(position) vec4<f32> {\n            var pos = array<vec4<f32>, 6>(\n              vec4<f32>( 1.0,  1.0, 0.0, 1.0),\n              vec4<f32>( 1.0, -1.0, 0.0, 1.0),\n              vec4<f32>(-1.0, -1.0, 0.0, 1.0),\n              vec4<f32>( 1.0,  1.0, 0.0, 1.0),\n              vec4<f32>(-1.0, -1.0, 0.0, 1.0),\n              vec4<f32>(-1.0,  1.0, 0.0, 1.0)\n            );\n            return pos[VertexIndex];\n        }\n        `,\n      }),\n      entryPoint: 'main',\n    },\n    fragment: {\n      module: t.device.createShaderModule({\n        code: `\n        @group(0) @binding(0) var s : sampler;\n        @group(0) @binding(1) var t : texture_external;\n\n        @stage(fragment) fn main(@builtin(position) FragCoord : vec4<f32>)\n                                 -> @location(0) vec4<f32> {\n            return textureSampleLevel(t, s, FragCoord.xy / vec2<f32>(16.0, 16.0));\n        }\n        `,\n      }),\n      entryPoint: 'main',\n      targets: [\n        {\n          format: kFormat,\n        },\n      ],\n    },\n    primitive: { topology: 'triangle-list' },\n  });\n\n  return pipeline;\n}\n\nfunction createExternalTextureSamplingTestBindGroup(\n  t: GPUTest,\n  video: HTMLVideoElement,\n  pipeline: GPURenderPipeline\n): GPUBindGroup {\n  const linearSampler = t.device.createSampler();\n\n  const externalTextureDescriptor = { source: video };\n  const externalTexture = t.device.importExternalTexture(externalTextureDescriptor);\n\n  const bindGroup = t.device.createBindGroup({\n    layout: pipeline.getBindGroupLayout(0),\n    entries: [\n      {\n        binding: 0,\n        resource: linearSampler,\n      },\n      {\n        binding: 1,\n        resource: externalTexture,\n      },\n    ],\n  });\n\n  return bindGroup;\n}\n\ng.test('importExternalTexture,sample')\n  .desc(\n    `\nTests that we can import an HTMLVideoElement into a GPUExternalTexture, sample from it for all\nsupported video formats {vp8, vp9, ogg, mp4} and common source colorspaces {bt.601, bt.709, bt.2020}.\n`\n  )\n  .params(u =>\n    u //\n      .combineWithParams(kVideoExpectations)\n  )\n  .fn(async t => {\n    const videoUrl = getResourcePath(t.params.videoSource);\n    const video = document.createElement('video');\n    video.src = videoUrl;\n\n    await startPlayingAndWaitForVideo(video, () => {\n      const colorAttachment = t.device.createTexture({\n        format: kFormat,\n        size: { width: kWidth, height: kHeight, depthOrArrayLayers: 1 },\n        usage: GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n      });\n\n      const pipeline = createExternalTextureSamplingTestPipeline(t);\n\n      const bindGroup = createExternalTextureSamplingTestBindGroup(t, video, pipeline);\n\n      const commandEncoder = t.device.createCommandEncoder();\n      const passEncoder = commandEncoder.beginRenderPass({\n        colorAttachments: [\n          {\n            view: colorAttachment.createView(),\n            clearValue: { r: 0.0, g: 0.0, b: 0.0, a: 1.0 },\n            loadOp: 'clear',\n            storeOp: 'store',\n          },\n        ],\n      });\n      passEncoder.setPipeline(pipeline);\n      passEncoder.setBindGroup(0, bindGroup);\n      passEncoder.draw(6);\n      passEncoder.end();\n      t.device.queue.submit([commandEncoder.finish()]);\n\n      // Top left corner should be red. Sample a few pixels away from the edges to avoid compression\n      // artifacts.\n      t.expectSinglePixelIn2DTexture(\n        colorAttachment,\n        kFormat,\n        { x: 5, y: 5 },\n        {\n          exp: t.params._redExpectation,\n        }\n      );\n\n      // Bottom right corner should be green. Sample a few pixels away from the edges to avoid\n      // compression artifacts.\n      t.expectSinglePixelIn2DTexture(\n        colorAttachment,\n        kFormat,\n        { x: kWidth - 5, y: kHeight - 5 },\n        {\n          exp: t.params._greenExpectation,\n        }\n      );\n    });\n  });\n\ng.test('importExternalTexture,expired')\n  .desc(\n    `\nTests that GPUExternalTexture.expired is false when video frame is not updated\nfrom imported HTMLVideoElement and will be changed to true when video frame is\nupdated. Using expired GPUExternalTexture results in an error.\n`\n  )\n  .fn(async t => {\n    const videoUrl = getResourcePath('red-green.webmvp8.webm');\n    const video = document.createElement('video');\n    video.src = videoUrl;\n\n    const colorAttachment = t.device.createTexture({\n      format: kFormat,\n      size: { width: kWidth, height: kHeight, depthOrArrayLayers: 1 },\n      usage: GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n    const passDescriptor = {\n      colorAttachments: [\n        {\n          view: colorAttachment.createView(),\n          clearValue: [0, 0, 0, 1],\n          loadOp: 'clear',\n          storeOp: 'store',\n        },\n      ],\n    } as const;\n\n    const bindGroupLayout = t.device.createBindGroupLayout({\n      entries: [{ binding: 0, visibility: GPUShaderStage.FRAGMENT, externalTexture: {} }],\n    });\n\n    let bindGroup: GPUBindGroup;\n    const useExternalTexture = () => {\n      const commandEncoder = t.device.createCommandEncoder();\n      const passEncoder = commandEncoder.beginRenderPass(passDescriptor);\n      passEncoder.setBindGroup(0, bindGroup);\n      passEncoder.end();\n      return commandEncoder.finish();\n    };\n\n    let externalTexture: GPUExternalTexture;\n    await startPlayingAndWaitForVideo(video, async () => {\n      // 1. Enqueue a microtask which uses the GPUExternalTexture. This should happen immediately\n      // after the current microtask.\n      const microtask1 = Promise.resolve().then(() => {\n        const commandBuffer = useExternalTexture();\n        t.expectGPUError('validation', () => t.device.queue.submit([commandBuffer]), false);\n        t.expect(!externalTexture.expired);\n      });\n\n      // 2. importExternalTexture which should stay active if video frame is not updated.\n      externalTexture = t.device.importExternalTexture({ source: video });\n      // Set `bindGroup` here, which will then be used in microtask1 and microtask3.\n      bindGroup = t.device.createBindGroup({\n        layout: bindGroupLayout,\n        entries: [{ binding: 0, resource: externalTexture }],\n      });\n\n      // 3. Enqueue a microtask which uses the GPUExternalTexture. The GPUExternalTexture\n      // should still keep alive.\n      const microtask3 = Promise.resolve().then(() => {\n        const commandBuffer = useExternalTexture();\n        t.expectGPUError('validation', () => t.device.queue.submit([commandBuffer]), false);\n        t.expect(!externalTexture.expired);\n      });\n\n      // Now make sure the test doesn't end before all of those microtasks complete.\n      await microtask1;\n      await microtask3;\n    });\n\n    // Update new video frame.\n    await startPlayingAndWaitForVideo(video, async () => {\n      // 4. VideoFrame is updated. GPUExternalTexture should be expired. Using the\n      // GPUExternalTexture should result in an error.\n      const commandBuffer = useExternalTexture();\n      t.expectGPUError('validation', () => t.device.queue.submit([commandBuffer]), true);\n      t.expect(externalTexture.expired);\n    });\n  });\n\ng.test('importExternalTexture,compute')\n  .desc(\n    `\nTests that we can import an HTMLVideoElement into a GPUExternalTexture and use it in a compute shader.\n`\n  )\n  .params(u =>\n    u //\n      .combineWithParams(kVideoExpectations)\n  )\n  .fn(async t => {\n    const videoUrl = getResourcePath(t.params.videoSource);\n    const video = document.createElement('video');\n    video.src = videoUrl;\n\n    await startPlayingAndWaitForVideo(video, () => {\n      const externalTextureDescriptor = { source: video };\n      const externalTexture = t.device.importExternalTexture(externalTextureDescriptor);\n\n      const outputTexture = t.device.createTexture({\n        format: 'rgba8unorm',\n        size: [2, 1, 1],\n        usage: GPUTextureUsage.COPY_SRC | GPUTextureUsage.STORAGE_BINDING,\n      });\n\n      const pipeline = t.device.createComputePipeline({\n        layout: 'auto',\n        compute: {\n          // Shader will load a pixel near the upper left and lower right corners, which are then\n          // stored in storage texture.\n          module: t.device.createShaderModule({\n            code: `\n              @group(0) @binding(0) var t : texture_external;\n              @group(0) @binding(1) var outImage : texture_storage_2d<rgba8unorm, write>;\n\n              @stage(compute) @workgroup_size(1) fn main() {\n                var red : vec4<f32> = textureLoad(t, vec2<i32>(10,10));\n                textureStore(outImage, vec2<i32>(0, 0), red);\n                var green : vec4<f32> = textureLoad(t, vec2<i32>(70,118));\n                textureStore(outImage, vec2<i32>(1, 0), green);\n                return;\n              }\n            `,\n          }),\n          entryPoint: 'main',\n        },\n      });\n\n      const bg = t.device.createBindGroup({\n        entries: [\n          { binding: 0, resource: externalTexture },\n          { binding: 1, resource: outputTexture.createView() },\n        ],\n        layout: pipeline.getBindGroupLayout(0),\n      });\n\n      const encoder = t.device.createCommandEncoder();\n      const pass = encoder.beginComputePass();\n      pass.setPipeline(pipeline);\n      pass.setBindGroup(0, bg);\n      pass.dispatchWorkgroups(1);\n      pass.end();\n      t.device.queue.submit([encoder.finish()]);\n\n      // Pixel loaded from top left corner should be red.\n      t.expectSinglePixelIn2DTexture(\n        outputTexture,\n        kFormat,\n        { x: 0, y: 0 },\n        {\n          exp: t.params._redExpectation,\n        }\n      );\n\n      // Pixel loaded from Bottom right corner should be green.\n      t.expectSinglePixelIn2DTexture(\n        outputTexture,\n        kFormat,\n        { x: 1, y: 0 },\n        {\n          exp: t.params._greenExpectation,\n        }\n      );\n    });\n  });\n"],"file":"video.spec.js"}