{"version":3,"sources":["../../../../src/webgpu/web_platform/copyToTexture/canvas.spec.ts"],"names":["description","makeTestGroup","unreachable","assert","kTextureFormatInfo","kValidTextureFormatsForCopyIB2T","CopyToTextureUtils","kTexelRepresentationInfo","formatForExpectedPixels","format","F","createCanvas","canvasType","width","height","canvas","document","createElement","skip","OffscreenCanvas","init2DCanvasContent","paintOpaqueRects","canvasContext","getContext","rectWidth","Math","floor","rectHeight","alphaValue","ctx","fillStyle","fillRect","initGLCanvasContent","contextName","premultiplied","gl","premultipliedAlpha","colorValue","enable","SCISSOR_TEST","scissor","clearColor","clear","COLOR_BUFFER_BIT","getExpectedPixels","context","contextType","srcPremultiplied","dstPremultiplied","bytesPerPixel","bytesPerBlock","expectedPixels","Uint8ClampedArray","sourcePixels","getImageData","data","readPixels","RGBA","UNSIGNED_BYTE","rep","divide","rgba","i","j","pixelPos","R","G","B","A","pixelData","Uint8Array","pack","encode","set","g","test","desc","params","u","combine","beginSubcases","fn","t","dstColorFormat","dst","device","createTexture","size","depthOrArrayLayers","usage","GPUTextureUsage","COPY_DST","COPY_SRC","RENDER_ATTACHMENT","dstBytesPerPixel","doTestAndCheckResult","source","origin","x","y","texture","colorSpace"],"mappings":"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","sourcesContent":["export const description = `\ncopyToTexture with HTMLCanvasElement and OffscreenCanvas sources.\n\nTODO: consider whether external_texture and copyToTexture video tests should be in the same file\n`;\n\nimport { makeTestGroup } from '../../../common/framework/test_group.js';\nimport { unreachable, assert } from '../../../common/util/util.js';\nimport {\n  RegularTextureFormat,\n  kTextureFormatInfo,\n  kValidTextureFormatsForCopyIB2T,\n} from '../../capability_info.js';\nimport { CopyToTextureUtils } from '../../util/copyToTexture.js';\nimport { kTexelRepresentationInfo } from '../../util/texture/texel_data.js';\n\n/**\n * If the destination format specifies a transfer function,\n * copyExternalImageToTexture (like B2T/T2T copies) should ignore it.\n */\nfunction formatForExpectedPixels(format: RegularTextureFormat): RegularTextureFormat {\n  return format === 'rgba8unorm-srgb'\n    ? 'rgba8unorm'\n    : format === 'bgra8unorm-srgb'\n    ? 'bgra8unorm'\n    : format;\n}\n\nclass F extends CopyToTextureUtils {\n  createCanvas(\n    canvasType: 'onscreen' | 'offscreen',\n    width: number,\n    height: number\n  ): HTMLCanvasElement | OffscreenCanvas | null {\n    let canvas: HTMLCanvasElement | OffscreenCanvas | null = null;\n    if (canvasType === 'onscreen') {\n      if (typeof document !== 'undefined') {\n        canvas = document.createElement('canvas');\n        canvas.width = width;\n        canvas.height = height;\n      } else {\n        this.skip('Cannot create HTMLCanvasElement');\n      }\n    } else if (canvasType === 'offscreen') {\n      if (typeof OffscreenCanvas === 'undefined') {\n        this.skip('OffscreenCanvas is not supported');\n      }\n      canvas = new OffscreenCanvas(width, height);\n    } else {\n      unreachable();\n    }\n\n    return canvas;\n  }\n\n  // TODO: Cache the generated canvas to avoid duplicated initialization.\n  init2DCanvasContent({\n    canvasType,\n    width,\n    height,\n    paintOpaqueRects,\n  }: {\n    canvasType: 'onscreen' | 'offscreen';\n    width: number;\n    height: number;\n    paintOpaqueRects: boolean;\n  }): {\n    canvas: HTMLCanvasElement | OffscreenCanvas;\n    canvasContext: CanvasRenderingContext2D | OffscreenCanvasRenderingContext2D;\n  } {\n    const canvas = this.createCanvas(canvasType, width, height);\n    if (canvas === null) {\n      this.skip('Cannot create canvas');\n    }\n\n    let canvasContext = null;\n    canvasContext = canvas.getContext('2d') as\n      | CanvasRenderingContext2D\n      | OffscreenCanvasRenderingContext2D\n      | null;\n\n    if (canvasContext === null) {\n      this.skip(canvasType + ' canvas 2d context not available');\n    }\n\n    const rectWidth = Math.floor(width / 2);\n    const rectHeight = Math.floor(height / 2);\n\n    // The rgb10a2unorm dst texture will have tiny errors when we compare actual and expectation.\n    // This is due to the convert from 8-bit to 10-bit combined with alpha value ops. So for\n    // rgb10a2unorm dst textures, we'll set alphaValue to 1.0 to test.\n    const alphaValue = paintOpaqueRects ? 1.0 : 0.6;\n    const ctx = canvasContext as CanvasRenderingContext2D | OffscreenCanvasRenderingContext2D;\n    // Red\n    ctx.fillStyle = `rgba(255, 0, 0, ${alphaValue})`;\n    ctx.fillRect(0, 0, rectWidth, rectHeight);\n    // Lime\n    ctx.fillStyle = `rgba(0, 255, 0, ${alphaValue})`;\n    ctx.fillRect(rectWidth, 0, width - rectWidth, rectHeight);\n    // Blue\n    ctx.fillStyle = `rgba(0, 0, 255, ${alphaValue})`;\n    ctx.fillRect(0, rectHeight, rectWidth, height - rectHeight);\n    // White\n    ctx.fillStyle = `rgba(255, 255, 255, ${alphaValue})`;\n    ctx.fillRect(rectWidth, rectHeight, width - rectWidth, height - rectHeight);\n\n    return { canvas, canvasContext };\n  }\n\n  // TODO: Cache the generated canvas to avoid duplicated initialization.\n  initGLCanvasContent({\n    canvasType,\n    contextName,\n    width,\n    height,\n    premultiplied,\n    paintOpaqueRects,\n  }: {\n    canvasType: 'onscreen' | 'offscreen';\n    contextName: 'webgl' | 'webgl2';\n    width: number;\n    height: number;\n    premultiplied: boolean;\n    paintOpaqueRects: boolean;\n  }): {\n    canvas: HTMLCanvasElement | OffscreenCanvas;\n    canvasContext: WebGLRenderingContext | WebGL2RenderingContext;\n  } {\n    const canvas = this.createCanvas(canvasType, width, height);\n    if (canvas === null) {\n      this.skip('Cannot create canvas');\n    }\n\n    let gl = null;\n    gl = canvas.getContext(contextName, { premultipliedAlpha: premultiplied }) as\n      | WebGLRenderingContext\n      | WebGL2RenderingContext\n      | null;\n\n    if (gl === null) {\n      this.skip(canvasType + ' canvas ' + contextName + ' context not available');\n    }\n\n    const rectWidth = Math.floor(width / 2);\n    const rectHeight = Math.floor(height / 2);\n\n    const alphaValue = paintOpaqueRects ? 1.0 : 0.6;\n    const colorValue = premultiplied ? alphaValue : 1.0;\n\n    // For webgl/webgl2 context canvas, if the context created with premultipliedAlpha attributes,\n    // it means that the value in drawing buffer is premultiplied or not. So we should set\n    // premultipliedAlpha value for premultipliedAlpha true gl context and unpremultipliedAlpha value\n    // for the premulitpliedAlpha false gl context.\n    gl.enable(gl.SCISSOR_TEST);\n    gl.scissor(0, 0, rectWidth, rectHeight);\n    gl.clearColor(colorValue, 0.0, 0.0, alphaValue);\n    gl.clear(gl.COLOR_BUFFER_BIT);\n\n    gl.scissor(rectWidth, 0, width - rectWidth, rectHeight);\n    gl.clearColor(0.0, colorValue, 0.0, alphaValue);\n    gl.clear(gl.COLOR_BUFFER_BIT);\n\n    gl.scissor(0, rectHeight, rectWidth, height - rectHeight);\n    gl.clearColor(0.0, 0.0, colorValue, alphaValue);\n    gl.clear(gl.COLOR_BUFFER_BIT);\n\n    gl.scissor(rectWidth, rectHeight, width - rectWidth, height - rectHeight);\n    gl.clearColor(colorValue, colorValue, colorValue, alphaValue);\n    gl.clear(gl.COLOR_BUFFER_BIT);\n\n    return { canvas, canvasContext: gl };\n  }\n\n  getExpectedPixels({\n    context,\n    width,\n    height,\n    format,\n    contextType,\n    srcPremultiplied,\n    dstPremultiplied,\n  }: {\n    context:\n      | CanvasRenderingContext2D\n      | OffscreenCanvasRenderingContext2D\n      | WebGLRenderingContext\n      | WebGL2RenderingContext;\n    width: number;\n    height: number;\n    format: RegularTextureFormat;\n    contextType: '2d' | 'gl';\n    srcPremultiplied: boolean;\n    dstPremultiplied: boolean;\n  }): Uint8ClampedArray {\n    const bytesPerPixel = kTextureFormatInfo[format].bytesPerBlock;\n\n    const expectedPixels = new Uint8ClampedArray(bytesPerPixel * width * height);\n    let sourcePixels;\n    if (contextType === '2d') {\n      const ctx = context as CanvasRenderingContext2D | OffscreenCanvasRenderingContext2D;\n      sourcePixels = ctx.getImageData(0, 0, width, height).data;\n    } else if (contextType === 'gl') {\n      sourcePixels = new Uint8ClampedArray(width * height * 4);\n      const gl = context as WebGLRenderingContext | WebGL2RenderingContext;\n      gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, sourcePixels);\n    } else {\n      unreachable();\n    }\n\n    // Generate expectedPixels\n    // Use getImageData and readPixels to get canvas contents.\n    const rep = kTexelRepresentationInfo[format];\n    const divide = 255.0;\n    let rgba: { R: number; G: number; B: number; A: number };\n    for (let i = 0; i < height; ++i) {\n      for (let j = 0; j < width; ++j) {\n        const pixelPos = i * width + j;\n\n        rgba = {\n          R: sourcePixels[pixelPos * 4] / divide,\n          G: sourcePixels[pixelPos * 4 + 1] / divide,\n          B: sourcePixels[pixelPos * 4 + 2] / divide,\n          A: sourcePixels[pixelPos * 4 + 3] / divide,\n        };\n\n        if (!srcPremultiplied && dstPremultiplied) {\n          rgba.R *= rgba.A;\n          rgba.G *= rgba.A;\n          rgba.B *= rgba.A;\n        }\n\n        if (srcPremultiplied && !dstPremultiplied) {\n          assert(rgba.A !== 0.0);\n          rgba.R /= rgba.A;\n          rgba.G /= rgba.A;\n          rgba.B /= rgba.A;\n        }\n\n        const pixelData = new Uint8Array(rep.pack(rep.encode(rgba)));\n        expectedPixels.set(pixelData, pixelPos * bytesPerPixel);\n      }\n    }\n\n    return expectedPixels;\n  }\n}\n\nexport const g = makeTestGroup(F);\n\ng.test('copy_contents_from_2d_context_canvas')\n  .desc(\n    `\n  Test HTMLCanvasElement and OffscreenCanvas with 2d context\n  can be copied to WebGPU texture correctly.\n\n  It creates HTMLCanvasElement/OffscreenCanvas with '2d'.\n  Use fillRect(2d context) to render red rect for top-left,\n  green rect for top-right, blue rect for bottom-left and white for bottom-right.\n\n  Then call copyExternalImageToTexture() to do a full copy to the 0 mipLevel\n  of dst texture, and read the contents out to compare with the canvas contents.\n\n  The tests covers:\n  - Valid canvas type\n  - Valid 2d context type\n  - TODO: color space tests need to be added\n  - TODO: Add error tolerance for rgb10a2unorm dst texture format\n\n  And the expected results are all passed.\n  `\n  )\n  .params(u =>\n    u\n      .combine('canvasType', ['onscreen', 'offscreen'] as const)\n      .combine('dstColorFormat', kValidTextureFormatsForCopyIB2T)\n      .combine('dstPremultiplied', [true, false])\n      .beginSubcases()\n      .combine('width', [1, 2, 4, 15, 255, 256])\n      .combine('height', [1, 2, 4, 15, 255, 256])\n  )\n  .fn(async t => {\n    const { width, height, canvasType, dstColorFormat, dstPremultiplied } = t.params;\n\n    // When dst texture format is rgb10a2unorm, the generated expected value of the result\n    // may have tiny errors compared to the actual result when the channel value is\n    // not 1.0 or 0.0.\n    // For example, we init the pixel with r channel to 0.6. And the denormalized value for\n    // 10-bit channel is 613.8, which needs to call \"round\" or other function to get an integer.\n    // It is possible that gpu adopt different \"round\" as our cpu implementation(we use Math.round())\n    // and it will generate tiny errors.\n    // So the cases with rgb10a2unorm dst texture format are handled specially by painting opaque rects\n    // to ensure they will have stable result after alphaOps(should keep the same value).\n    const { canvas, canvasContext } = t.init2DCanvasContent({\n      canvasType,\n      width,\n      height,\n      paintOpaqueRects: dstColorFormat === 'rgb10a2unorm',\n    });\n\n    const dst = t.device.createTexture({\n      size: {\n        width,\n        height,\n        depthOrArrayLayers: 1,\n      },\n      format: dstColorFormat,\n      usage:\n        GPUTextureUsage.COPY_DST | GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    // Construct expected value for different dst color format\n    const dstBytesPerPixel = kTextureFormatInfo[dstColorFormat].bytesPerBlock;\n    const format: RegularTextureFormat = formatForExpectedPixels(dstColorFormat);\n\n    // For 2d canvas, get expected pixels with getImageData(), which returns unpremultiplied\n    // values.\n    const expectedPixels = t.getExpectedPixels({\n      context: canvasContext,\n      width,\n      height,\n      format,\n      contextType: '2d',\n      srcPremultiplied: false,\n      dstPremultiplied,\n    });\n\n    t.doTestAndCheckResult(\n      { source: canvas, origin: { x: 0, y: 0 } },\n      {\n        texture: dst,\n        origin: { x: 0, y: 0 },\n        colorSpace: 'srgb',\n        premultipliedAlpha: dstPremultiplied,\n      },\n      { width: canvas.width, height: canvas.height, depthOrArrayLayers: 1 },\n      dstBytesPerPixel,\n      expectedPixels\n    );\n  });\n\ng.test('copy_contents_from_gl_context_canvas')\n  .desc(\n    `\n  Test HTMLCanvasElement and OffscreenCanvas with webgl/webgl2 context\n  can be copied to WebGPU texture correctly.\n\n  It creates HTMLCanvasElement/OffscreenCanvas with webgl'/'webgl2'.\n  Use stencil + clear to render red rect for top-left, green rect\n  for top-right, blue rect for bottom-left and white for bottom-right.\n  And do premultiply alpha in advance if the webgl/webgl2 context is created\n  with premultipliedAlpha : true.\n  \n  Then call copyExternalImageToTexture() to do a full copy to the 0 mipLevel\n  of dst texture, and read the contents out to compare with the canvas contents.\n\n  The tests covers:\n  - Valid canvas type\n  - Valid webgl/webgl2 context type\n  - TODO: color space tests need to be added\n  - TODO: Add error tolerance for rgb10a2unorm dst texture format\n\n  And the expected results are all passed.\n  `\n  )\n  .params(u =>\n    u\n      .combine('canvasType', ['onscreen', 'offscreen'] as const)\n      .combine('contextName', ['webgl', 'webgl2'] as const)\n      .combine('dstColorFormat', kValidTextureFormatsForCopyIB2T)\n      .combine('srcPremultiplied', [true, false])\n      .combine('dstPremultiplied', [true, false])\n      .beginSubcases()\n      .combine('width', [1, 2, 4, 15, 255, 256])\n      .combine('height', [1, 2, 4, 15, 255, 256])\n  )\n  .fn(async t => {\n    const {\n      width,\n      height,\n      canvasType,\n      contextName,\n      dstColorFormat,\n      srcPremultiplied,\n      dstPremultiplied,\n    } = t.params;\n\n    // When dst texture format is rgb10a2unorm, the generated expected value of the result\n    // may have tiny errors compared to the actual result when the channel value is\n    // not 1.0 or 0.0.\n    // For example, we init the pixel with r channel to 0.6. And the denormalized value for\n    // 10-bit channel is 613.8, which needs to call \"round\" or other function to get an integer.\n    // It is possible that gpu adopt different \"round\" as our cpu implementation(we use Math.round())\n    // and it will generate tiny errors.\n    // So the cases with rgb10a2unorm dst texture format are handled specially by by painting opaque rects\n    // to ensure they will have stable result after alphaOps(should keep the same value).\n    const { canvas, canvasContext } = t.initGLCanvasContent({\n      canvasType,\n      contextName,\n      width,\n      height,\n      premultiplied: srcPremultiplied,\n      paintOpaqueRects: dstColorFormat === 'rgb10a2unorm',\n    });\n\n    const dst = t.device.createTexture({\n      size: {\n        width,\n        height,\n        depthOrArrayLayers: 1,\n      },\n      format: dstColorFormat,\n      usage:\n        GPUTextureUsage.COPY_DST | GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    // Construct expected value for different dst color format\n    const dstBytesPerPixel = kTextureFormatInfo[dstColorFormat].bytesPerBlock;\n    const format: RegularTextureFormat = formatForExpectedPixels(dstColorFormat);\n    const expectedPixels = t.getExpectedPixels({\n      context: canvasContext,\n      width,\n      height,\n      format,\n      contextType: 'gl',\n      srcPremultiplied,\n      dstPremultiplied,\n    });\n\n    t.doTestAndCheckResult(\n      { source: canvas, origin: { x: 0, y: 0 } },\n      {\n        texture: dst,\n        origin: { x: 0, y: 0 },\n        colorSpace: 'srgb',\n        premultipliedAlpha: dstPremultiplied,\n      },\n      { width: canvas.width, height: canvas.height, depthOrArrayLayers: 1 },\n      dstBytesPerPixel,\n      expectedPixels\n    );\n  });\n"],"file":"canvas.spec.js"}