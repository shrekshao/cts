{"version":3,"sources":["../../../../src/webgpu/web_platform/copyToTexture/canvas.spec.ts"],"names":["description","getResourcePath","makeTestGroup","unreachable","kTextureFormatInfo","kValidTextureFormatsForCopyE2T","CopyToTextureUtils","allCanvasTypes","createCanvas","F","init2DCanvasContentWithColorSpace","width","height","paintOpaqueRects","colorSpace","canvas","canvasContext","getContext","skip","getContextAttributes","SOURCE_PIXEL_BYTES","imagePixels","Uint8ClampedArray","rectWidth","Math","floor","rectHeight","alphaValue","pixelStartPos","i","j","imageData","ImageData","ctx","putImageData","init2DCanvasContent","canvasType","paint2DCanvas","fillStyle","fillRect","initGLCanvasContent","contextName","premultiplied","gl","premultipliedAlpha","trackForCleanup","colorValue","enable","SCISSOR_TEST","scissor","clearColor","clear","COLOR_BUFFER_BIT","getInitGPUCanvasData","initialData","maxRectHeightIndex","pixelIndex","length","index","initGPUCanvasContent","device","gpuContext","alphaMode","configure","format","usage","GPUTextureUsage","COPY_DST","COPY_SRC","compositingAlphaMode","canvasTexture","getCurrentTexture","queue","writeTexture","texture","bytesPerRow","rowsPerImage","depthOrArrayLayers","getSourceCanvas2DContent","context","getImageData","data","getSourceCanvasGLContent","bytesPerPixel","sourcePixels","readPixels","RGBA","UNSIGNED_BYTE","doFlipY","calculateSourceContentOnCPU","rgbaPixels","pixelPos","r","getTestImageURLByColorSpace","g","test","desc","params","u","combine","beginSubcases","fn","t","dstColorFormat","dstPremultiplied","srcDoFlipYDuringCopy","dst","createTexture","size","RENDER_ATTACHMENT","dstBytesPerPixel","bytesPerBlock","baseFormat","undefined","expectedPixels","getExpectedPixels","doTestAndCheckResult","source","origin","x","y","flipY","srcPremultiplied","srcAndDstInSameGPUDevice","selectMismatchedDeviceOrSkipTestCase","mismatchedDevice","srcColorSpace","dstColorSpace"],"mappings":";AAAA;AACA,GADA,OAAO,MAAMA,WAAW,GAAI;AAC5B;AACA;AACA;AACA,CAJO,CAMP,SAASC,eAAT,QAAgC,wCAAhC;AACA,SAASC,aAAT,QAA8B,yCAA9B;AACA,SAASC,WAAT,QAA4B,8BAA5B;AACA;;AAEEC,kBAFF;AAGEC,8BAHF;AAIO,0BAJP;AAKA,SAASC,kBAAT,QAAmC,+BAAnC;AACA,SAAsBC,cAAtB,EAAsCC,YAAtC,QAA0D,+BAA1D;;AAEA,MAAMC,CAAN,SAAgBH,kBAAhB,CAAmC;AACjCI,EAAAA,iCAAiC,CAAC;AAChCC,IAAAA,KADgC;AAEhCC,IAAAA,MAFgC;AAGhCC,IAAAA,gBAHgC;AAIhCC,IAAAA,UAJgC,EAAD;;;;;;;;;AAa/B;AACA,UAAMC,MAAM,GAAGP,YAAY,CAAC,IAAD,EAAO,UAAP,EAAmBG,KAAnB,EAA0BC,MAA1B,CAA3B;;AAEA,QAAII,aAAa,GAAG,IAApB;AACAA,IAAAA,aAAa,GAAGD,MAAM,CAACE,UAAP,CAAkB,IAAlB,EAAwB,EAAEH,UAAF,EAAxB,CAAhB;;AAEA,QAAIE,aAAa,KAAK,IAAtB,EAA4B;AAC1B,WAAKE,IAAL,CAAU,0CAAV;AACD;;AAED;AACE,WAAOF,aAAa,CAACG,oBAArB,KAA8C,WAA9C;AACA,WAAOH,aAAa,CAACG,oBAAd,GAAqCL,UAA5C,KAA2D,WAF7D;AAGE;AACA,WAAKI,IAAL,CAAU,yDAAV;AACD;;AAED,UAAME,kBAAkB,GAAG,CAA3B;AACA,UAAMC,WAAW,GAAG,IAAIC,iBAAJ,CAAsBF,kBAAkB,GAAGT,KAArB,GAA6BC,MAAnD,CAApB;;AAEA,UAAMW,SAAS,GAAGC,IAAI,CAACC,KAAL,CAAWd,KAAK,GAAG,CAAnB,CAAlB;AACA,UAAMe,UAAU,GAAGF,IAAI,CAACC,KAAL,CAAWb,MAAM,GAAG,CAApB,CAAnB;;AAEA,UAAMe,UAAU,GAAGd,gBAAgB,GAAG,GAAH,GAAS,GAA5C;;AAEA,QAAIe,aAAa,GAAG,CAApB;AACA;AACA,SAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGH,UAApB,EAAgC,EAAEG,CAAlC,EAAqC;AACnC,WAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGP,SAApB,EAA+B,EAAEO,CAAjC,EAAoC;AAClCF,QAAAA,aAAa,GAAG,CAACC,CAAC,GAAGlB,KAAJ,GAAYmB,CAAb,IAAkBV,kBAAlC;AACAC,QAAAA,WAAW,CAACO,aAAD,CAAX,GAA6B,GAA7B;AACAP,QAAAA,WAAW,CAACO,aAAa,GAAG,CAAjB,CAAX,GAAiC,CAAjC;AACAP,QAAAA,WAAW,CAACO,aAAa,GAAG,CAAjB,CAAX,GAAiC,CAAjC;AACAP,QAAAA,WAAW,CAACO,aAAa,GAAG,CAAjB,CAAX,GAAiCD,UAAjC;AACD;AACF;;AAED;AACA,SAAK,IAAIE,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGH,UAApB,EAAgC,EAAEG,CAAlC,EAAqC;AACnC,WAAK,IAAIC,CAAC,GAAGP,SAAb,EAAwBO,CAAC,GAAGnB,KAA5B,EAAmC,EAAEmB,CAArC,EAAwC;AACtCF,QAAAA,aAAa,GAAG,CAACC,CAAC,GAAGlB,KAAJ,GAAYmB,CAAb,IAAkBV,kBAAlC;AACAC,QAAAA,WAAW,CAACO,aAAD,CAAX,GAA6B,CAA7B;AACAP,QAAAA,WAAW,CAACO,aAAa,GAAG,CAAjB,CAAX,GAAiC,GAAjC;AACAP,QAAAA,WAAW,CAACO,aAAa,GAAG,CAAjB,CAAX,GAAiC,CAAjC;AACAP,QAAAA,WAAW,CAACO,aAAa,GAAG,CAAjB,CAAX,GAAiCD,UAAjC;AACD;AACF;;AAED;AACA,SAAK,IAAIE,CAAC,GAAGH,UAAb,EAAyBG,CAAC,GAAGjB,MAA7B,EAAqC,EAAEiB,CAAvC,EAA0C;AACxC,WAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGP,SAApB,EAA+B,EAAEO,CAAjC,EAAoC;AAClCF,QAAAA,aAAa,GAAG,CAACC,CAAC,GAAGlB,KAAJ,GAAYmB,CAAb,IAAkBV,kBAAlC;AACAC,QAAAA,WAAW,CAACO,aAAD,CAAX,GAA6B,CAA7B;AACAP,QAAAA,WAAW,CAACO,aAAa,GAAG,CAAjB,CAAX,GAAiC,CAAjC;AACAP,QAAAA,WAAW,CAACO,aAAa,GAAG,CAAjB,CAAX,GAAiC,GAAjC;AACAP,QAAAA,WAAW,CAACO,aAAa,GAAG,CAAjB,CAAX,GAAiCD,UAAjC;AACD;AACF;;AAED;AACA,SAAK,IAAIE,CAAC,GAAGH,UAAb,EAAyBG,CAAC,GAAGjB,MAA7B,EAAqC,EAAEiB,CAAvC,EAA0C;AACxC,WAAK,IAAIC,CAAC,GAAGP,SAAb,EAAwBO,CAAC,GAAGnB,KAA5B,EAAmC,EAAEmB,CAArC,EAAwC;AACtCF,QAAAA,aAAa,GAAG,CAACC,CAAC,GAAGlB,KAAJ,GAAYmB,CAAb,IAAkBV,kBAAlC;AACAC,QAAAA,WAAW,CAACO,aAAD,CAAX,GAA6B,GAA7B;AACAP,QAAAA,WAAW,CAACO,aAAa,GAAG,CAAjB,CAAX,GAAiC,CAAjC;AACAP,QAAAA,WAAW,CAACO,aAAa,GAAG,CAAjB,CAAX,GAAiC,GAAjC;AACAP,QAAAA,WAAW,CAACO,aAAa,GAAG,CAAjB,CAAX,GAAiCD,UAAjC;AACD;AACF;;AAED,UAAMI,SAAS,GAAG,IAAIC,SAAJ,CAAcX,WAAd,EAA2BV,KAA3B,EAAkCC,MAAlC,EAA0C,EAAEE,UAAF,EAA1C,CAAlB;AACA;;AAEA,QAAI,OAAQiB,SAAD,CAAmBjB,UAA1B,KAAyC,WAA7C,EAA0D;AACxD,WAAKI,IAAL,CAAU,iDAAV;AACD;;AAED,UAAMe,GAAG,GAAGjB,aAAZ;AACAiB,IAAAA,GAAG,CAACC,YAAJ,CAAiBH,SAAjB,EAA4B,CAA5B,EAA+B,CAA/B;;AAEA,WAAO,EAAEhB,MAAF,EAAUC,aAAV,EAAP;AACD;;AAED;AACAmB,EAAAA,mBAAmB,CAAC;AAClBC,IAAAA,UADkB;AAElBzB,IAAAA,KAFkB;AAGlBC,IAAAA,MAHkB;AAIlBC,IAAAA,gBAJkB,EAAD;;;;;;;;;AAajB;AACA,UAAME,MAAM,GAAGP,YAAY,CAAC,IAAD,EAAO4B,UAAP,EAAmBzB,KAAnB,EAA0BC,MAA1B,CAA3B;;AAEA,QAAII,aAAa,GAAG,IAApB;AACAA,IAAAA,aAAa,GAAGD,MAAM,CAACE,UAAP,CAAkB,IAAlB,CAAhB;;;;;AAKA,QAAID,aAAa,KAAK,IAAtB,EAA4B;AAC1B,WAAKE,IAAL,CAAUkB,UAAU,GAAG,kCAAvB;AACD;;AAED;AACA;AACA;AACA,UAAMT,UAAU,GAAGd,gBAAgB,GAAG,GAAH,GAAS,GAA5C;AACA,UAAMoB,GAAG,GAAGjB,aAAZ;AACA,SAAKqB,aAAL,CAAmBJ,GAAnB,EAAwBtB,KAAxB,EAA+BC,MAA/B,EAAuCe,UAAvC;;AAEA,WAAO,EAAEZ,MAAF,EAAUC,aAAV,EAAP;AACD;;AAEDqB,EAAAA,aAAa;AACXJ,EAAAA,GADW;AAEXtB,EAAAA,KAFW;AAGXC,EAAAA,MAHW;AAIXe,EAAAA,UAJW;AAKX;AACA,UAAMJ,SAAS,GAAGC,IAAI,CAACC,KAAL,CAAWd,KAAK,GAAG,CAAnB,CAAlB;AACA,UAAMe,UAAU,GAAGF,IAAI,CAACC,KAAL,CAAWb,MAAM,GAAG,CAApB,CAAnB;;AAEA;AACAqB,IAAAA,GAAG,CAACK,SAAJ,GAAiB,mBAAkBX,UAAW,GAA9C;AACAM,IAAAA,GAAG,CAACM,QAAJ,CAAa,CAAb,EAAgB,CAAhB,EAAmBhB,SAAnB,EAA8BG,UAA9B;AACA;AACAO,IAAAA,GAAG,CAACK,SAAJ,GAAiB,mBAAkBX,UAAW,GAA9C;AACAM,IAAAA,GAAG,CAACM,QAAJ,CAAahB,SAAb,EAAwB,CAAxB,EAA2BZ,KAAK,GAAGY,SAAnC,EAA8CG,UAA9C;AACA;AACAO,IAAAA,GAAG,CAACK,SAAJ,GAAiB,mBAAkBX,UAAW,GAA9C;AACAM,IAAAA,GAAG,CAACM,QAAJ,CAAa,CAAb,EAAgBb,UAAhB,EAA4BH,SAA5B,EAAuCX,MAAM,GAAGc,UAAhD;AACA;AACAO,IAAAA,GAAG,CAACK,SAAJ,GAAiB,qBAAoBX,UAAW,GAAhD;AACAM,IAAAA,GAAG,CAACM,QAAJ,CAAahB,SAAb,EAAwBG,UAAxB,EAAoCf,KAAK,GAAGY,SAA5C,EAAuDX,MAAM,GAAGc,UAAhE;AACD;;AAED;AACAc,EAAAA,mBAAmB,CAAC;AAClBJ,IAAAA,UADkB;AAElBK,IAAAA,WAFkB;AAGlB9B,IAAAA,KAHkB;AAIlBC,IAAAA,MAJkB;AAKlB8B,IAAAA,aALkB;AAMlB7B,IAAAA,gBANkB,EAAD;;;;;;;;;;;AAiBjB;AACA,UAAME,MAAM,GAAGP,YAAY,CAAC,IAAD,EAAO4B,UAAP,EAAmBzB,KAAnB,EAA0BC,MAA1B,CAA3B;;AAEA;AACA;AACA,UAAM+B,EAAE,GAAI5B,MAAD,CAA8BE,UAA9B,CAAyCwB,WAAzC,EAAsD;AAC/DG,MAAAA,kBAAkB,EAAEF,aAD2C,EAAtD,CAAX;;;AAIA,QAAIC,EAAE,KAAK,IAAX,EAAiB;AACf,WAAKzB,IAAL,CAAUkB,UAAU,GAAG,UAAb,GAA0BK,WAA1B,GAAwC,wBAAlD;AACD;AACD,SAAKI,eAAL,CAAqBF,EAArB;;AAEA,UAAMpB,SAAS,GAAGC,IAAI,CAACC,KAAL,CAAWd,KAAK,GAAG,CAAnB,CAAlB;AACA,UAAMe,UAAU,GAAGF,IAAI,CAACC,KAAL,CAAWb,MAAM,GAAG,CAApB,CAAnB;;AAEA,UAAMe,UAAU,GAAGd,gBAAgB,GAAG,GAAH,GAAS,GAA5C;AACA,UAAMiC,UAAU,GAAGJ,aAAa,GAAGf,UAAH,GAAgB,GAAhD;;AAEA;AACA;AACA;AACA;AACAgB,IAAAA,EAAE,CAACI,MAAH,CAAUJ,EAAE,CAACK,YAAb;AACAL,IAAAA,EAAE,CAACM,OAAH,CAAW,CAAX,EAAc,CAAd,EAAiB1B,SAAjB,EAA4BG,UAA5B;AACAiB,IAAAA,EAAE,CAACO,UAAH,CAAcJ,UAAd,EAA0B,GAA1B,EAA+B,GAA/B,EAAoCnB,UAApC;AACAgB,IAAAA,EAAE,CAACQ,KAAH,CAASR,EAAE,CAACS,gBAAZ;;AAEAT,IAAAA,EAAE,CAACM,OAAH,CAAW1B,SAAX,EAAsB,CAAtB,EAAyBZ,KAAK,GAAGY,SAAjC,EAA4CG,UAA5C;AACAiB,IAAAA,EAAE,CAACO,UAAH,CAAc,GAAd,EAAmBJ,UAAnB,EAA+B,GAA/B,EAAoCnB,UAApC;AACAgB,IAAAA,EAAE,CAACQ,KAAH,CAASR,EAAE,CAACS,gBAAZ;;AAEAT,IAAAA,EAAE,CAACM,OAAH,CAAW,CAAX,EAAcvB,UAAd,EAA0BH,SAA1B,EAAqCX,MAAM,GAAGc,UAA9C;AACAiB,IAAAA,EAAE,CAACO,UAAH,CAAc,GAAd,EAAmB,GAAnB,EAAwBJ,UAAxB,EAAoCnB,UAApC;AACAgB,IAAAA,EAAE,CAACQ,KAAH,CAASR,EAAE,CAACS,gBAAZ;;AAEAT,IAAAA,EAAE,CAACM,OAAH,CAAW1B,SAAX,EAAsBG,UAAtB,EAAkCf,KAAK,GAAGY,SAA1C,EAAqDX,MAAM,GAAGc,UAA9D;AACAiB,IAAAA,EAAE,CAACO,UAAH,CAAcJ,UAAd,EAA0BA,UAA1B,EAAsCA,UAAtC,EAAkDnB,UAAlD;AACAgB,IAAAA,EAAE,CAACQ,KAAH,CAASR,EAAE,CAACS,gBAAZ;;AAEA,WAAO,EAAErC,MAAF,EAAUC,aAAa,EAAE2B,EAAzB,EAAP;AACD;;AAEDU,EAAAA,oBAAoB;AAClB1C,EAAAA,KADkB;AAElBC,EAAAA,MAFkB;AAGlB8B,EAAAA,aAHkB;AAIlB7B,EAAAA,gBAJkB;AAKC;AACnB,UAAMU,SAAS,GAAGC,IAAI,CAACC,KAAL,CAAWd,KAAK,GAAG,CAAnB,CAAlB;AACA,UAAMe,UAAU,GAAGF,IAAI,CAACC,KAAL,CAAWb,MAAM,GAAG,CAApB,CAAnB;;AAEA,UAAMe,UAAU,GAAGd,gBAAgB,GAAG,GAAH,GAAS,GAA5C;AACA,UAAMiC,UAAU,GAAGJ,aAAa,GAAGf,UAAH,GAAgB,GAAhD;;AAEA;AACA,UAAM2B,WAAW,GAAG,IAAIhC,iBAAJ,CAAsB,IAAIX,KAAJ,GAAYC,MAAlC,CAApB;AACA,UAAM2C,kBAAkB,GAAG5C,KAAK,GAAGe,UAAnC;AACA,SAAK,IAAI8B,UAAU,GAAG,CAAtB,EAAyBA,UAAU,GAAGF,WAAW,CAACG,MAAZ,GAAqB,CAA3D,EAA8D,EAAED,UAAhE,EAA4E;AAC1E,YAAME,KAAK,GAAGF,UAAU,GAAG,CAA3B;;AAEA;AACA,UAAIA,UAAU,GAAGD,kBAAjB,EAAqC;AACnC;AACA,YAAIC,UAAU,GAAG7C,KAAb,GAAqBY,SAAzB,EAAoC;AAClC;AACA+B,UAAAA,WAAW,CAACI,KAAD,CAAX,GAAqBZ,UAArB;AACAQ,UAAAA,WAAW,CAACI,KAAK,GAAG,CAAT,CAAX,GAAyB,CAAzB;AACAJ,UAAAA,WAAW,CAACI,KAAK,GAAG,CAAT,CAAX,GAAyB,CAAzB;AACAJ,UAAAA,WAAW,CAACI,KAAK,GAAG,CAAT,CAAX,GAAyB/B,UAAzB;AACD,SAND,MAMO;AACL;AACA2B,UAAAA,WAAW,CAACI,KAAD,CAAX,GAAqB,CAArB;AACAJ,UAAAA,WAAW,CAACI,KAAK,GAAG,CAAT,CAAX,GAAyBZ,UAAzB;AACAQ,UAAAA,WAAW,CAACI,KAAK,GAAG,CAAT,CAAX,GAAyB,CAAzB;AACAJ,UAAAA,WAAW,CAACI,KAAK,GAAG,CAAT,CAAX,GAAyB/B,UAAzB;AACD;AACF,OAfD,MAeO;AACL;AACA;AACA,YAAI6B,UAAU,GAAG7C,KAAb,GAAqBY,SAAzB,EAAoC;AAClC+B,UAAAA,WAAW,CAACI,KAAD,CAAX,GAAqB,CAArB;AACAJ,UAAAA,WAAW,CAACI,KAAK,GAAG,CAAT,CAAX,GAAyB,CAAzB;AACAJ,UAAAA,WAAW,CAACI,KAAK,GAAG,CAAT,CAAX,GAAyBZ,UAAzB;AACAQ,UAAAA,WAAW,CAACI,KAAK,GAAG,CAAT,CAAX,GAAyB/B,UAAzB;AACD,SALD,MAKO;AACL;AACA2B,UAAAA,WAAW,CAACI,KAAD,CAAX,GAAqBZ,UAArB;AACAQ,UAAAA,WAAW,CAACI,KAAK,GAAG,CAAT,CAAX,GAAyBZ,UAAzB;AACAQ,UAAAA,WAAW,CAACI,KAAK,GAAG,CAAT,CAAX,GAAyBZ,UAAzB;AACAQ,UAAAA,WAAW,CAACI,KAAK,GAAG,CAAT,CAAX,GAAyB/B,UAAzB;AACD;AACF;AACF;AACD,WAAO2B,WAAP;AACD;;AAEDK,EAAAA,oBAAoB,CAAC;AACnBC,IAAAA,MADmB;AAEnBxB,IAAAA,UAFmB;AAGnBzB,IAAAA,KAHmB;AAInBC,IAAAA,MAJmB;AAKnB8B,IAAAA,aALmB;AAMnB7B,IAAAA,gBANmB,EAAD;;;;;;;;;;AAgBlB;AACA,UAAME,MAAM,GAAGP,YAAY,CAAC,IAAD,EAAO4B,UAAP,EAAmBzB,KAAnB,EAA0BC,MAA1B,CAA3B;;AAEA,UAAMiD,UAAU,GAAG9C,MAAM,CAACE,UAAP,CAAkB,QAAlB,CAAnB;;AAEA,QAAI4C,UAAU,KAAK,IAAnB,EAAyB;AACvB,WAAK3C,IAAL,CAAUkB,UAAU,GAAG,sCAAvB;AACD;;AAED,UAAM0B,SAAS,GAAGpB,aAAa,GAAG,eAAH,GAAqB,QAApD;;AAEAmB,IAAAA,UAAU,CAACE,SAAX,CAAqB;AACnBH,MAAAA,MADmB;AAEnBI,MAAAA,MAAM,EAAE,YAFW;AAGnBC,MAAAA,KAAK,EAAEC,eAAe,CAACC,QAAhB,GAA2BD,eAAe,CAACE,QAH/B;AAInBC,MAAAA,oBAAoB,EAAEP,SAJH,EAArB;;;AAOA;AACA,UAAMR,WAAW,GAAG,KAAKD,oBAAL,CAA0B1C,KAA1B,EAAiCC,MAAjC,EAAyC8B,aAAzC,EAAwD7B,gBAAxD,CAApB;AACA,UAAMyD,aAAa,GAAGT,UAAU,CAACU,iBAAX,EAAtB;AACAX,IAAAA,MAAM,CAACY,KAAP,CAAaC,YAAb;AACE,MAAEC,OAAO,EAAEJ,aAAX,EADF;AAEEhB,IAAAA,WAFF;AAGE;AACEqB,MAAAA,WAAW,EAAEhE,KAAK,GAAG,CADvB;AAEEiE,MAAAA,YAAY,EAAEhE,MAFhB,EAHF;;AAOE;AACED,MAAAA,KADF;AAEEC,MAAAA,MAFF;AAGEiE,MAAAA,kBAAkB,EAAE,CAHtB,EAPF;;;;AAcA,WAAO,EAAE9D,MAAF,EAAP;AACD;;AAED+D,EAAAA,wBAAwB;AACtBC,EAAAA,OADsB;AAEtBpE,EAAAA,KAFsB;AAGtBC,EAAAA,MAHsB;AAIH;AACnB;AACA,WAAOmE,OAAO,CAACC,YAAR,CAAqB,CAArB,EAAwB,CAAxB,EAA2BrE,KAA3B,EAAkCC,MAAlC,EAA0CqE,IAAjD;AACD;;AAEDC,EAAAA,wBAAwB;AACtBvC,EAAAA,EADsB;AAEtBhC,EAAAA,KAFsB;AAGtBC,EAAAA,MAHsB;AAIH;AACnB,UAAMuE,aAAa,GAAG,CAAtB;;AAEA,UAAMC,YAAY,GAAG,IAAI9D,iBAAJ,CAAsBX,KAAK,GAAGC,MAAR,GAAiBuE,aAAvC,CAArB;AACAxC,IAAAA,EAAE,CAAC0C,UAAH,CAAc,CAAd,EAAiB,CAAjB,EAAoB1E,KAApB,EAA2BC,MAA3B,EAAmC+B,EAAE,CAAC2C,IAAtC,EAA4C3C,EAAE,CAAC4C,aAA/C,EAA8DH,YAA9D;;AAEA,WAAO,KAAKI,OAAL,CAAaJ,YAAb,EAA2BzE,KAA3B,EAAkCC,MAAlC,EAA0CuE,aAA1C,CAAP;AACD;;AAEDM,EAAAA,2BAA2B;AACzB9E,EAAAA,KADyB;AAEzBC,EAAAA,MAFyB;AAGzBgC,EAAAA,kBAHyB;AAIzB/B,EAAAA,gBAJyB;AAKN;AACnB,UAAMsE,aAAa,GAAG,CAAtB;;AAEA,UAAMO,UAAU,GAAG,KAAKrC,oBAAL;AACjB1C,IAAAA,KADiB;AAEjBC,IAAAA,MAFiB;AAGjBgC,IAAAA,kBAHiB;AAIjB/B,IAAAA,gBAJiB,CAAnB;;;AAOA;AACA;AACA;AACA;AACA,SAAK,IAAIgB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGjB,MAApB,EAA4B,EAAEiB,CAA9B,EAAiC;AAC/B,WAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGnB,KAApB,EAA2B,EAAEmB,CAA7B,EAAgC;AAC9B,cAAM6D,QAAQ,GAAG9D,CAAC,GAAGlB,KAAJ,GAAYmB,CAA7B;AACA,cAAM8D,CAAC,GAAGF,UAAU,CAACC,QAAQ,GAAGR,aAAX,GAA2B,CAA5B,CAApB;AACA,YAAI,CAACvC,kBAAL,EAAyB;AACvB8C,UAAAA,UAAU,CAACC,QAAQ,GAAGR,aAAX,GAA2B,CAA5B,CAAV,GAA2C,GAA3C;AACD;;AAEDO,QAAAA,UAAU,CAACC,QAAQ,GAAGR,aAAX,GAA2B,CAA5B,CAAV,GAA2CO,UAAU,CAACC,QAAQ,GAAGR,aAAZ,CAArD;AACAO,QAAAA,UAAU,CAACC,QAAQ,GAAGR,aAAZ,CAAV,GAAuCS,CAAvC;AACD;AACF;;AAED,WAAOF,UAAP;AACD;;AAEDG,EAAAA,2BAA2B,CAAC/E,UAAD,EAA4C;AACrE,YAAQA,UAAR;AACE,WAAK,MAAL;AACE,eAAOb,eAAe,CAAC,sBAAD,CAAtB;AACF,WAAK,YAAL;AACE,eAAOA,eAAe,CAAC,oBAAD,CAAtB;AACF;AACEE,QAAAA,WAAW,GANf;;AAQD,GAzYgC;;;AA4YnC,OAAO,MAAM2F,CAAC,GAAG5F,aAAa,CAACO,CAAD,CAAvB;;AAEPqF,CAAC,CAACC,IAAF,CAAO,sCAAP;AACGC,IADH;AAEK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GA7BA;;AA+BGC,MA/BH,CA+BU,CAAAC,CAAC;AACPA,CAAC;AACEC,OADH,CACW,YADX,EACyB5F,cADzB;AAEG4F,OAFH,CAEW,gBAFX,EAE6B9F,8BAF7B;AAGG8F,OAHH,CAGW,kBAHX,EAG+B,CAAC,IAAD,EAAO,KAAP,CAH/B;AAIGA,OAJH,CAIW,sBAJX,EAImC,CAAC,IAAD,EAAO,KAAP,CAJnC;AAKGC,aALH;AAMGD,OANH,CAMW,OANX,EAMoB,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,EAAV,EAAc,GAAd,EAAmB,GAAnB,CANpB;AAOGA,OAPH,CAOW,QAPX,EAOqB,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,EAAV,EAAc,GAAd,EAAmB,GAAnB,CAPrB,CAhCJ;;AAyCGE,EAzCH,CAyCM,OAAMC,CAAN,KAAW;AACb,QAAM;AACJ3F,IAAAA,KADI;AAEJC,IAAAA,MAFI;AAGJwB,IAAAA,UAHI;AAIJmE,IAAAA,cAJI;AAKJC,IAAAA,gBALI;AAMJC,IAAAA,oBANI;AAOFH,EAAAA,CAAC,CAACL,MAPN;;AASA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAM,EAAElF,MAAF,EAAUC,aAAV,KAA4BsF,CAAC,CAACnE,mBAAF,CAAsB;AACtDC,IAAAA,UADsD;AAEtDzB,IAAAA,KAFsD;AAGtDC,IAAAA,MAHsD;AAItDC,IAAAA,gBAAgB,EAAE0F,cAAc,KAAK,cAJiB,EAAtB,CAAlC;;;AAOA,QAAMG,GAAG,GAAGJ,CAAC,CAAC1C,MAAF,CAAS+C,aAAT,CAAuB;AACjCC,IAAAA,IAAI,EAAE;AACJjG,MAAAA,KADI;AAEJC,MAAAA,MAFI;AAGJiE,MAAAA,kBAAkB,EAAE,CAHhB,EAD2B;;AAMjCb,IAAAA,MAAM,EAAEuC,cANyB;AAOjCtC,IAAAA,KAAK;AACHC,IAAAA,eAAe,CAACC,QAAhB,GAA2BD,eAAe,CAACE,QAA3C,GAAsDF,eAAe,CAAC2C,iBARvC,EAAvB,CAAZ;;;AAWA;AACA,QAAMC,gBAAgB,GAAG1G,kBAAkB,CAACmG,cAAD,CAAlB,CAAmCQ,aAA5D;AACA,QAAM/C,MAA4B;AAChC5D,EAAAA,kBAAkB,CAACmG,cAAD,CAAlB,CAAmCS,UAAnC,KAAkDC,SAAlD;AACI7G,EAAAA,kBAAkB,CAACmG,cAAD,CAAlB,CAAmCS,UADvC;AAEIT,EAAAA,cAHN;;AAKA;AACA;AACA,QAAMnB,YAAY,GAAGkB,CAAC,CAACxB,wBAAF,CAA2B9D,aAA3B,EAA0CL,KAA1C,EAAiDC,MAAjD,CAArB;AACA,QAAMsG,cAAc,GAAGZ,CAAC,CAACa,iBAAF;AACrB/B,EAAAA,YADqB;AAErBzE,EAAAA,KAFqB;AAGrBC,EAAAA,MAHqB;AAIrBoD,EAAAA,MAJqB;AAKrB,OALqB;AAMrBwC,EAAAA,gBANqB;AAOrBC,EAAAA,oBAPqB,CAAvB;;;AAUAH,EAAAA,CAAC,CAACc,oBAAF;AACE,IAAEC,MAAM,EAAEtG,MAAV,EAAkBuG,MAAM,EAAE,EAAEC,CAAC,EAAE,CAAL,EAAQC,CAAC,EAAE,CAAX,EAA1B,EAA0CC,KAAK,EAAEhB,oBAAjD,EADF;AAEE;AACE/B,IAAAA,OAAO,EAAEgC,GADX;AAEEY,IAAAA,MAAM,EAAE,EAAEC,CAAC,EAAE,CAAL,EAAQC,CAAC,EAAE,CAAX,EAFV;AAGE1G,IAAAA,UAAU,EAAE,MAHd;AAIE8B,IAAAA,kBAAkB,EAAE4D,gBAJtB,EAFF;;AAQE,IAAE7F,KAAK,EAAEI,MAAM,CAACJ,KAAhB,EAAuBC,MAAM,EAAEG,MAAM,CAACH,MAAtC,EAA8CiE,kBAAkB,EAAE,CAAlE,EARF;AASEiC,EAAAA,gBATF;AAUEI,EAAAA,cAVF;AAWEX,EAAAA,cAXF;;AAaD,CA/GH;;AAiHAT,CAAC,CAACC,IAAF,CAAO,sCAAP;AACGC,IADH;AAEK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAhCA;;AAkCGC,MAlCH,CAkCU,CAAAC,CAAC;AACPA,CAAC;AACEC,OADH,CACW,YADX,EACyB5F,cADzB;AAEG4F,OAFH,CAEW,aAFX,EAE0B,CAAC,OAAD,EAAU,QAAV,CAF1B;AAGGA,OAHH,CAGW,gBAHX,EAG6B9F,8BAH7B;AAIG8F,OAJH,CAIW,kBAJX,EAI+B,CAAC,IAAD,EAAO,KAAP,CAJ/B;AAKGA,OALH,CAKW,kBALX,EAK+B,CAAC,IAAD,EAAO,KAAP,CAL/B;AAMGA,OANH,CAMW,sBANX,EAMmC,CAAC,IAAD,EAAO,KAAP,CANnC;AAOGC,aAPH;AAQGD,OARH,CAQW,OARX,EAQoB,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,EAAV,EAAc,GAAd,EAAmB,GAAnB,CARpB;AASGA,OATH,CASW,QATX,EASqB,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,EAAV,EAAc,GAAd,EAAmB,GAAnB,CATrB,CAnCJ;;AA8CGE,EA9CH,CA8CM,OAAMC,CAAN,KAAW;AACb,QAAM;AACJ3F,IAAAA,KADI;AAEJC,IAAAA,MAFI;AAGJwB,IAAAA,UAHI;AAIJK,IAAAA,WAJI;AAKJ8D,IAAAA,cALI;AAMJmB,IAAAA,gBANI;AAOJlB,IAAAA,gBAPI;AAQJC,IAAAA,oBARI;AASFH,EAAAA,CAAC,CAACL,MATN;;AAWA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAM,EAAElF,MAAF,EAAUC,aAAV,KAA4BsF,CAAC,CAAC9D,mBAAF,CAAsB;AACtDJ,IAAAA,UADsD;AAEtDK,IAAAA,WAFsD;AAGtD9B,IAAAA,KAHsD;AAItDC,IAAAA,MAJsD;AAKtD8B,IAAAA,aAAa,EAAEgF,gBALuC;AAMtD7G,IAAAA,gBAAgB,EAAE0F,cAAc,KAAK,cANiB,EAAtB,CAAlC;;;AASA,QAAMG,GAAG,GAAGJ,CAAC,CAAC1C,MAAF,CAAS+C,aAAT,CAAuB;AACjCC,IAAAA,IAAI,EAAE;AACJjG,MAAAA,KADI;AAEJC,MAAAA,MAFI;AAGJiE,MAAAA,kBAAkB,EAAE,CAHhB,EAD2B;;AAMjCb,IAAAA,MAAM,EAAEuC,cANyB;AAOjCtC,IAAAA,KAAK;AACHC,IAAAA,eAAe,CAACC,QAAhB,GAA2BD,eAAe,CAACE,QAA3C,GAAsDF,eAAe,CAAC2C,iBARvC,EAAvB,CAAZ;;;AAWA;AACA,QAAMC,gBAAgB,GAAG1G,kBAAkB,CAACmG,cAAD,CAAlB,CAAmCQ,aAA5D;AACA,QAAM/C,MAA4B;AAChC5D,EAAAA,kBAAkB,CAACmG,cAAD,CAAlB,CAAmCS,UAAnC,KAAkDC,SAAlD;AACI7G,EAAAA,kBAAkB,CAACmG,cAAD,CAAlB,CAAmCS,UADvC;AAEIT,EAAAA,cAHN;AAIA,QAAMnB,YAAY,GAAGkB,CAAC,CAACpB,wBAAF,CAA2BlE,aAA3B,EAA0CL,KAA1C,EAAiDC,MAAjD,CAArB;AACA,QAAMsG,cAAc,GAAGZ,CAAC,CAACa,iBAAF;AACrB/B,EAAAA,YADqB;AAErBzE,EAAAA,KAFqB;AAGrBC,EAAAA,MAHqB;AAIrBoD,EAAAA,MAJqB;AAKrB0D,EAAAA,gBALqB;AAMrBlB,EAAAA,gBANqB;AAOrBC,EAAAA,oBAPqB,CAAvB;;;AAUAH,EAAAA,CAAC,CAACc,oBAAF;AACE,IAAEC,MAAM,EAAEtG,MAAV,EAAkBuG,MAAM,EAAE,EAAEC,CAAC,EAAE,CAAL,EAAQC,CAAC,EAAE,CAAX,EAA1B,EAA0CC,KAAK,EAAEhB,oBAAjD,EADF;AAEE;AACE/B,IAAAA,OAAO,EAAEgC,GADX;AAEEY,IAAAA,MAAM,EAAE,EAAEC,CAAC,EAAE,CAAL,EAAQC,CAAC,EAAE,CAAX,EAFV;AAGE1G,IAAAA,UAAU,EAAE,MAHd;AAIE8B,IAAAA,kBAAkB,EAAE4D,gBAJtB,EAFF;;AAQE,IAAE7F,KAAK,EAAEI,MAAM,CAACJ,KAAhB,EAAuBC,MAAM,EAAEG,MAAM,CAACH,MAAtC,EAA8CiE,kBAAkB,EAAE,CAAlE,EARF;AASEiC,EAAAA,gBATF;AAUEI,EAAAA,cAVF;AAWEX,EAAAA,cAXF;;AAaD,CArHH;;AAuHAT,CAAC,CAACC,IAAF,CAAO,uCAAP;AACGC,IADH;AAEK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAlCA;;AAoCGC,MApCH,CAoCU,CAAAC,CAAC;AACPA,CAAC;AACEC,OADH,CACW,YADX,EACyB5F,cADzB;AAEG4F,OAFH,CAEW,0BAFX,EAEuC,CAAC,IAAD,EAAO,KAAP,CAFvC;AAGGA,OAHH,CAGW,gBAHX,EAG6B9F,8BAH7B;AAIG8F,OAJH,CAIW,kBAJX,EAI+B,CAAC,IAAD,CAJ/B;AAKGA,OALH,CAKW,kBALX,EAK+B,CAAC,IAAD,EAAO,KAAP,CAL/B;AAMGA,OANH,CAMW,sBANX,EAMmC,CAAC,IAAD,EAAO,KAAP,CANnC;AAOGC,aAPH;AAQGD,OARH,CAQW,OARX,EAQoB,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,EAAV,EAAc,GAAd,EAAmB,GAAnB,CARpB;AASGA,OATH,CASW,QATX,EASqB,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,EAAV,EAAc,GAAd,EAAmB,GAAnB,CATrB,CArCJ;;AAgDGE,EAhDH,CAgDM,OAAMC,CAAN,KAAW;AACb,QAAM;AACJ3F,IAAAA,KADI;AAEJC,IAAAA,MAFI;AAGJwB,IAAAA,UAHI;AAIJuF,IAAAA,wBAJI;AAKJpB,IAAAA,cALI;AAMJmB,IAAAA,gBANI;AAOJlB,IAAAA,gBAPI;AAQJC,IAAAA,oBARI;AASFH,EAAAA,CAAC,CAACL,MATN;;AAWA,MAAIrC,MAAJ;;AAEA,MAAI,CAAC+D,wBAAL,EAA+B;AAC7B,UAAMrB,CAAC,CAACsB,oCAAF,CAAuCX,SAAvC,CAAN;AACArD,IAAAA,MAAM,GAAG0C,CAAC,CAACuB,gBAAX;AACD,GAHD,MAGO;AACLjE,IAAAA,MAAM,GAAG0C,CAAC,CAAC1C,MAAX;AACD;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAM,EAAE7C,MAAF,KAAauF,CAAC,CAAC3C,oBAAF,CAAuB;AACxCC,IAAAA,MADwC;AAExCxB,IAAAA,UAFwC;AAGxCzB,IAAAA,KAHwC;AAIxCC,IAAAA,MAJwC;AAKxC8B,IAAAA,aAAa,EAAEgF,gBALyB;AAMxC7G,IAAAA,gBAAgB,EAAE0F,cAAc,KAAK,cANG,EAAvB,CAAnB;;;AASA,QAAMG,GAAG,GAAGJ,CAAC,CAAC1C,MAAF,CAAS+C,aAAT,CAAuB;AACjCC,IAAAA,IAAI,EAAE;AACJjG,MAAAA,KADI;AAEJC,MAAAA,MAFI;AAGJiE,MAAAA,kBAAkB,EAAE,CAHhB,EAD2B;;AAMjCb,IAAAA,MAAM,EAAEuC,cANyB;AAOjCtC,IAAAA,KAAK;AACHC,IAAAA,eAAe,CAACC,QAAhB,GAA2BD,eAAe,CAACE,QAA3C,GAAsDF,eAAe,CAAC2C,iBARvC,EAAvB,CAAZ;;;AAWA;AACA,QAAMC,gBAAgB,GAAG1G,kBAAkB,CAACmG,cAAD,CAAlB,CAAmCQ,aAA5D;AACA,QAAM/C,MAAM,GAAG5D,kBAAkB,CAACmG,cAAD,CAAlB,CAAmCS,UAAnC,IAAiDT,cAAhE;AACA,QAAMnB,YAAY,GAAGkB,CAAC,CAACb,2BAAF;AACnB9E,EAAAA,KADmB;AAEnBC,EAAAA,MAFmB;AAGnB8G,EAAAA,gBAHmB;AAInBnB,EAAAA,cAAc,KAAK,cAJA,CAArB;;AAMA,QAAMW,cAAc,GAAGZ,CAAC,CAACa,iBAAF;AACrB/B,EAAAA,YADqB;AAErBzE,EAAAA,KAFqB;AAGrBC,EAAAA,MAHqB;AAIrBoD,EAAAA,MAJqB;AAKrB0D,EAAAA,gBALqB;AAMrBlB,EAAAA,gBANqB;AAOrBC,EAAAA,oBAPqB,CAAvB;;;AAUAH,EAAAA,CAAC,CAACc,oBAAF;AACE,IAAEC,MAAM,EAAEtG,MAAV,EAAkBuG,MAAM,EAAE,EAAEC,CAAC,EAAE,CAAL,EAAQC,CAAC,EAAE,CAAX,EAA1B,EAA0CC,KAAK,EAAEhB,oBAAjD,EADF;AAEE;AACE/B,IAAAA,OAAO,EAAEgC,GADX;AAEEY,IAAAA,MAAM,EAAE,EAAEC,CAAC,EAAE,CAAL,EAAQC,CAAC,EAAE,CAAX,EAFV;AAGE1G,IAAAA,UAAU,EAAE,MAHd;AAIE8B,IAAAA,kBAAkB,EAAE4D,gBAJtB,EAFF;;AAQE,IAAE7F,KAAK,EAAEI,MAAM,CAACJ,KAAhB,EAAuBC,MAAM,EAAEG,MAAM,CAACH,MAAtC,EAA8CiE,kBAAkB,EAAE,CAAlE,EARF;AASEiC,EAAAA,gBATF;AAUEI,EAAAA,cAVF;AAWEX,EAAAA,cAXF;;AAaD,CAlIH;;AAoIAT,CAAC,CAACC,IAAF,CAAO,wBAAP;AACGC,IADH;AAEK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GA/BA;;AAiCGC,MAjCH,CAiCU,CAAAC,CAAC;AACPA,CAAC;AACEC,OADH,CACW,eADX,EAC4B,CAAC,MAAD,EAAS,YAAT,CAD5B;AAEGA,OAFH,CAEW,eAFX,EAE4B,CAAC,MAAD,CAF5B;AAGGA,OAHH,CAGW,gBAHX,EAG6B9F,8BAH7B;AAIG8F,OAJH,CAIW,kBAJX,EAI+B,CAAC,IAAD,EAAO,KAAP,CAJ/B;AAKGA,OALH,CAKW,sBALX,EAKmC,CAAC,IAAD,EAAO,KAAP,CALnC;AAMGC,aANH;AAOGD,OAPH,CAOW,OAPX,EAOoB,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,EAAV,EAAc,GAAd,EAAmB,GAAnB,CAPpB;AAQGA,OARH,CAQW,QARX,EAQqB,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,EAAV,EAAc,GAAd,EAAmB,GAAnB,CARrB,CAlCJ;;AA4CGE,EA5CH,CA4CM,OAAMC,CAAN,KAAW;AACb,QAAM;AACJ3F,IAAAA,KADI;AAEJC,IAAAA,MAFI;AAGJkH,IAAAA,aAHI;AAIJC,IAAAA,aAJI;AAKJxB,IAAAA,cALI;AAMJC,IAAAA,gBANI;AAOJC,IAAAA,oBAPI;AAQFH,EAAAA,CAAC,CAACL,MARN;AASA,QAAM,EAAElF,MAAF,EAAUC,aAAV,KAA4BsF,CAAC,CAAC5F,iCAAF,CAAoC;AACpEC,IAAAA,KADoE;AAEpEC,IAAAA,MAFoE;AAGpEC,IAAAA,gBAAgB,EAAE,IAHkD;AAIpEC,IAAAA,UAAU,EAAEgH,aAJwD,EAApC,CAAlC;;;AAOA,QAAMpB,GAAG,GAAGJ,CAAC,CAAC1C,MAAF,CAAS+C,aAAT,CAAuB;AACjCC,IAAAA,IAAI,EAAE;AACJjG,MAAAA,KADI;AAEJC,MAAAA,MAFI;AAGJiE,MAAAA,kBAAkB,EAAE,CAHhB,EAD2B;;AAMjCb,IAAAA,MAAM,EAAEuC,cANyB;AAOjCtC,IAAAA,KAAK;AACHC,IAAAA,eAAe,CAACC,QAAhB,GAA2BD,eAAe,CAACE,QAA3C,GAAsDF,eAAe,CAAC2C,iBARvC,EAAvB,CAAZ;;;AAWA,QAAMzB,YAAY,GAAGkB,CAAC,CAACxB,wBAAF,CAA2B9D,aAA3B,EAA0CL,KAA1C,EAAiDC,MAAjD,CAArB;;AAEA,QAAMkG,gBAAgB,GAAG1G,kBAAkB,CAACmG,cAAD,CAAlB,CAAmCQ,aAA5D;;AAEA,QAAMG,cAAc,GAAGZ,CAAC,CAACa,iBAAF;AACrB/B,EAAAA,YADqB;AAErBzE,EAAAA,KAFqB;AAGrBC,EAAAA,MAHqB;AAIrB2F,EAAAA,cAJqB;AAKrB,OALqB;AAMrBC,EAAAA,gBANqB;AAOrBC,EAAAA,oBAPqB;AAQrBqB,EAAAA,aARqB;AASrBC,EAAAA,aATqB,CAAvB;;;AAYAzB,EAAAA,CAAC,CAACc,oBAAF;AACE,IAAEC,MAAM,EAAEtG,MAAV,EAAkBuG,MAAM,EAAE,EAAEC,CAAC,EAAE,CAAL,EAAQC,CAAC,EAAE,CAAX,EAA1B,EAA0CC,KAAK,EAAEhB,oBAAjD,EADF;AAEE;AACE/B,IAAAA,OAAO,EAAEgC,GADX;AAEEY,IAAAA,MAAM,EAAE,EAAEC,CAAC,EAAE,CAAL,EAAQC,CAAC,EAAE,CAAX,EAFV;AAGE1G,IAAAA,UAAU,EAAEiH,aAHd;AAIEnF,IAAAA,kBAAkB,EAAE4D,gBAJtB,EAFF;;AAQE,IAAE7F,KAAK,EAAEI,MAAM,CAACJ,KAAhB,EAAuBC,MAAM,EAAEG,MAAM,CAACH,MAAtC,EAA8CiE,kBAAkB,EAAE,CAAlE,EARF;AASEiC,EAAAA,gBATF;AAUEI,EAAAA,cAVF;AAWEX,EAAAA,cAXF;;AAaD,CArGH","sourcesContent":["export const description = `\ncopyToTexture with HTMLCanvasElement and OffscreenCanvas sources.\n\nTODO: Add tests for flipY\n`;\n\nimport { getResourcePath } from '../../../common/framework/resources.js';\nimport { makeTestGroup } from '../../../common/framework/test_group.js';\nimport { unreachable } from '../../../common/util/util.js';\nimport {\n  RegularTextureFormat,\n  kTextureFormatInfo,\n  kValidTextureFormatsForCopyE2T,\n} from '../../capability_info.js';\nimport { CopyToTextureUtils } from '../../util/copy_to_texture.js';\nimport { canvasTypes, allCanvasTypes, createCanvas } from '../../util/create_elements.js';\n\nclass F extends CopyToTextureUtils {\n  init2DCanvasContentWithColorSpace({\n    width,\n    height,\n    paintOpaqueRects,\n    colorSpace,\n  }: {\n    width: number;\n    height: number;\n    paintOpaqueRects: boolean;\n    colorSpace: 'srgb' | 'display-p3';\n  }): {\n    canvas: HTMLCanvasElement | OffscreenCanvas;\n    canvasContext: CanvasRenderingContext2D | OffscreenCanvasRenderingContext2D;\n  } {\n    const canvas = createCanvas(this, 'onscreen', width, height);\n\n    let canvasContext = null;\n    canvasContext = canvas.getContext('2d', { colorSpace }) as CanvasRenderingContext2D | null;\n\n    if (canvasContext === null) {\n      this.skip('onscreen canvas 2d context not available');\n    }\n\n    if (\n      typeof canvasContext.getContextAttributes === 'undefined' ||\n      typeof canvasContext.getContextAttributes().colorSpace === 'undefined'\n    ) {\n      this.skip('color space attr is not supported for canvas 2d context');\n    }\n\n    const SOURCE_PIXEL_BYTES = 4;\n    const imagePixels = new Uint8ClampedArray(SOURCE_PIXEL_BYTES * width * height);\n\n    const rectWidth = Math.floor(width / 2);\n    const rectHeight = Math.floor(height / 2);\n\n    const alphaValue = paintOpaqueRects ? 255 : 153;\n\n    let pixelStartPos = 0;\n    // Red;\n    for (let i = 0; i < rectHeight; ++i) {\n      for (let j = 0; j < rectWidth; ++j) {\n        pixelStartPos = (i * width + j) * SOURCE_PIXEL_BYTES;\n        imagePixels[pixelStartPos] = 255;\n        imagePixels[pixelStartPos + 1] = 0;\n        imagePixels[pixelStartPos + 2] = 0;\n        imagePixels[pixelStartPos + 3] = alphaValue;\n      }\n    }\n\n    // Lime;\n    for (let i = 0; i < rectHeight; ++i) {\n      for (let j = rectWidth; j < width; ++j) {\n        pixelStartPos = (i * width + j) * SOURCE_PIXEL_BYTES;\n        imagePixels[pixelStartPos] = 0;\n        imagePixels[pixelStartPos + 1] = 255;\n        imagePixels[pixelStartPos + 2] = 0;\n        imagePixels[pixelStartPos + 3] = alphaValue;\n      }\n    }\n\n    // Blue\n    for (let i = rectHeight; i < height; ++i) {\n      for (let j = 0; j < rectWidth; ++j) {\n        pixelStartPos = (i * width + j) * SOURCE_PIXEL_BYTES;\n        imagePixels[pixelStartPos] = 0;\n        imagePixels[pixelStartPos + 1] = 0;\n        imagePixels[pixelStartPos + 2] = 255;\n        imagePixels[pixelStartPos + 3] = alphaValue;\n      }\n    }\n\n    // Fuchsia\n    for (let i = rectHeight; i < height; ++i) {\n      for (let j = rectWidth; j < width; ++j) {\n        pixelStartPos = (i * width + j) * SOURCE_PIXEL_BYTES;\n        imagePixels[pixelStartPos] = 255;\n        imagePixels[pixelStartPos + 1] = 0;\n        imagePixels[pixelStartPos + 2] = 255;\n        imagePixels[pixelStartPos + 3] = alphaValue;\n      }\n    }\n\n    const imageData = new ImageData(imagePixels, width, height, { colorSpace });\n    // MAINTENANCE_TODO: Remove as any when tsc support imageData.colorSpace\n    /* eslint-disable-next-line @typescript-eslint/no-explicit-any */\n    if (typeof (imageData as any).colorSpace === 'undefined') {\n      this.skip('color space attr is not supported for ImageData');\n    }\n\n    const ctx = canvasContext as CanvasRenderingContext2D | OffscreenCanvasRenderingContext2D;\n    ctx.putImageData(imageData, 0, 0);\n\n    return { canvas, canvasContext };\n  }\n\n  // MAINTENANCE_TODO: Cache the generated canvas to avoid duplicated initialization.\n  init2DCanvasContent({\n    canvasType,\n    width,\n    height,\n    paintOpaqueRects,\n  }: {\n    canvasType: canvasTypes;\n    width: number;\n    height: number;\n    paintOpaqueRects: boolean;\n  }): {\n    canvas: HTMLCanvasElement | OffscreenCanvas;\n    canvasContext: CanvasRenderingContext2D | OffscreenCanvasRenderingContext2D;\n  } {\n    const canvas = createCanvas(this, canvasType, width, height);\n\n    let canvasContext = null;\n    canvasContext = canvas.getContext('2d') as\n      | CanvasRenderingContext2D\n      | OffscreenCanvasRenderingContext2D\n      | null;\n\n    if (canvasContext === null) {\n      this.skip(canvasType + ' canvas 2d context not available');\n    }\n\n    // The rgb10a2unorm dst texture will have tiny errors when we compare actual and expectation.\n    // This is due to the convert from 8-bit to 10-bit combined with alpha value ops. So for\n    // rgb10a2unorm dst textures, we'll set alphaValue to 1.0 to test.\n    const alphaValue = paintOpaqueRects ? 1.0 : 0.6;\n    const ctx = canvasContext as CanvasRenderingContext2D | OffscreenCanvasRenderingContext2D;\n    this.paint2DCanvas(ctx, width, height, alphaValue);\n\n    return { canvas, canvasContext };\n  }\n\n  paint2DCanvas(\n    ctx: CanvasRenderingContext2D | OffscreenCanvasRenderingContext2D,\n    width: number,\n    height: number,\n    alphaValue: number\n  ) {\n    const rectWidth = Math.floor(width / 2);\n    const rectHeight = Math.floor(height / 2);\n\n    // Red\n    ctx.fillStyle = `rgba(255, 0, 0, ${alphaValue})`;\n    ctx.fillRect(0, 0, rectWidth, rectHeight);\n    // Lime\n    ctx.fillStyle = `rgba(0, 255, 0, ${alphaValue})`;\n    ctx.fillRect(rectWidth, 0, width - rectWidth, rectHeight);\n    // Blue\n    ctx.fillStyle = `rgba(0, 0, 255, ${alphaValue})`;\n    ctx.fillRect(0, rectHeight, rectWidth, height - rectHeight);\n    // Fuchsia\n    ctx.fillStyle = `rgba(255, 0, 255, ${alphaValue})`;\n    ctx.fillRect(rectWidth, rectHeight, width - rectWidth, height - rectHeight);\n  }\n\n  // MAINTENANCE_TODO: Cache the generated canvas to avoid duplicated initialization.\n  initGLCanvasContent({\n    canvasType,\n    contextName,\n    width,\n    height,\n    premultiplied,\n    paintOpaqueRects,\n  }: {\n    canvasType: canvasTypes;\n    contextName: 'webgl' | 'webgl2';\n    width: number;\n    height: number;\n    premultiplied: boolean;\n    paintOpaqueRects: boolean;\n  }): {\n    canvas: HTMLCanvasElement | OffscreenCanvas;\n    canvasContext: WebGLRenderingContext | WebGL2RenderingContext;\n  } {\n    const canvas = createCanvas(this, canvasType, width, height);\n\n    // MAINTENANCE_TODO: Workaround for @types/offscreencanvas missing an overload of\n    // `OffscreenCanvas.getContext` that takes `string` or a union of context types.\n    const gl = (canvas as HTMLCanvasElement).getContext(contextName, {\n      premultipliedAlpha: premultiplied,\n    }) as WebGLRenderingContext | WebGL2RenderingContext | null;\n\n    if (gl === null) {\n      this.skip(canvasType + ' canvas ' + contextName + ' context not available');\n    }\n    this.trackForCleanup(gl);\n\n    const rectWidth = Math.floor(width / 2);\n    const rectHeight = Math.floor(height / 2);\n\n    const alphaValue = paintOpaqueRects ? 1.0 : 0.6;\n    const colorValue = premultiplied ? alphaValue : 1.0;\n\n    // For webgl/webgl2 context canvas, if the context created with premultipliedAlpha attributes,\n    // it means that the value in drawing buffer is premultiplied or not. So we should set\n    // premultipliedAlpha value for premultipliedAlpha true gl context and unpremultipliedAlpha value\n    // for the premultipliedAlpha false gl context.\n    gl.enable(gl.SCISSOR_TEST);\n    gl.scissor(0, 0, rectWidth, rectHeight);\n    gl.clearColor(colorValue, 0.0, 0.0, alphaValue);\n    gl.clear(gl.COLOR_BUFFER_BIT);\n\n    gl.scissor(rectWidth, 0, width - rectWidth, rectHeight);\n    gl.clearColor(0.0, colorValue, 0.0, alphaValue);\n    gl.clear(gl.COLOR_BUFFER_BIT);\n\n    gl.scissor(0, rectHeight, rectWidth, height - rectHeight);\n    gl.clearColor(0.0, 0.0, colorValue, alphaValue);\n    gl.clear(gl.COLOR_BUFFER_BIT);\n\n    gl.scissor(rectWidth, rectHeight, width - rectWidth, height - rectHeight);\n    gl.clearColor(colorValue, colorValue, colorValue, alphaValue);\n    gl.clear(gl.COLOR_BUFFER_BIT);\n\n    return { canvas, canvasContext: gl };\n  }\n\n  getInitGPUCanvasData(\n    width: number,\n    height: number,\n    premultiplied: boolean,\n    paintOpaqueRects: boolean\n  ): Uint8ClampedArray {\n    const rectWidth = Math.floor(width / 2);\n    const rectHeight = Math.floor(height / 2);\n\n    const alphaValue = paintOpaqueRects ? 255 : 153;\n    const colorValue = premultiplied ? alphaValue : 255;\n\n    // BGRA8Unorm texture\n    const initialData = new Uint8ClampedArray(4 * width * height);\n    const maxRectHeightIndex = width * rectHeight;\n    for (let pixelIndex = 0; pixelIndex < initialData.length / 4; ++pixelIndex) {\n      const index = pixelIndex * 4;\n\n      // Top-half two rectangles\n      if (pixelIndex < maxRectHeightIndex) {\n        // top-left side rectangle\n        if (pixelIndex % width < rectWidth) {\n          // top-left side rectangle\n          initialData[index] = colorValue;\n          initialData[index + 1] = 0;\n          initialData[index + 2] = 0;\n          initialData[index + 3] = alphaValue;\n        } else {\n          // top-right side rectangle\n          initialData[index] = 0;\n          initialData[index + 1] = colorValue;\n          initialData[index + 2] = 0;\n          initialData[index + 3] = alphaValue;\n        }\n      } else {\n        // Bottom-half two rectangles\n        // bottom-left side rectangle\n        if (pixelIndex % width < rectWidth) {\n          initialData[index] = 0;\n          initialData[index + 1] = 0;\n          initialData[index + 2] = colorValue;\n          initialData[index + 3] = alphaValue;\n        } else {\n          // bottom-right side rectangle\n          initialData[index] = colorValue;\n          initialData[index + 1] = colorValue;\n          initialData[index + 2] = colorValue;\n          initialData[index + 3] = alphaValue;\n        }\n      }\n    }\n    return initialData;\n  }\n\n  initGPUCanvasContent({\n    device,\n    canvasType,\n    width,\n    height,\n    premultiplied,\n    paintOpaqueRects,\n  }: {\n    device: GPUDevice;\n    canvasType: canvasTypes;\n    width: number;\n    height: number;\n    premultiplied: boolean;\n    paintOpaqueRects: boolean;\n  }): {\n    canvas: HTMLCanvasElement | OffscreenCanvas;\n  } {\n    const canvas = createCanvas(this, canvasType, width, height);\n\n    const gpuContext = canvas.getContext('webgpu') as GPUCanvasContext | null;\n\n    if (gpuContext === null) {\n      this.skip(canvasType + ' canvas webgpu context not available');\n    }\n\n    const alphaMode = premultiplied ? 'premultiplied' : 'opaque';\n\n    gpuContext.configure({\n      device,\n      format: 'bgra8unorm',\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.COPY_SRC,\n      compositingAlphaMode: alphaMode,\n    });\n\n    // BGRA8Unorm texture\n    const initialData = this.getInitGPUCanvasData(width, height, premultiplied, paintOpaqueRects);\n    const canvasTexture = gpuContext.getCurrentTexture();\n    device.queue.writeTexture(\n      { texture: canvasTexture },\n      initialData,\n      {\n        bytesPerRow: width * 4,\n        rowsPerImage: height,\n      },\n      {\n        width,\n        height,\n        depthOrArrayLayers: 1,\n      }\n    );\n\n    return { canvas };\n  }\n\n  getSourceCanvas2DContent(\n    context: CanvasRenderingContext2D | OffscreenCanvasRenderingContext2D,\n    width: number,\n    height: number\n  ): Uint8ClampedArray {\n    // Always read back the raw data from canvas\n    return context.getImageData(0, 0, width, height).data;\n  }\n\n  getSourceCanvasGLContent(\n    gl: WebGLRenderingContext | WebGL2RenderingContext,\n    width: number,\n    height: number\n  ): Uint8ClampedArray {\n    const bytesPerPixel = 4;\n\n    const sourcePixels = new Uint8ClampedArray(width * height * bytesPerPixel);\n    gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, sourcePixels);\n\n    return this.doFlipY(sourcePixels, width, height, bytesPerPixel);\n  }\n\n  calculateSourceContentOnCPU(\n    width: number,\n    height: number,\n    premultipliedAlpha: boolean,\n    paintOpaqueRects: boolean\n  ): Uint8ClampedArray {\n    const bytesPerPixel = 4;\n\n    const rgbaPixels = this.getInitGPUCanvasData(\n      width,\n      height,\n      premultipliedAlpha,\n      paintOpaqueRects\n    );\n\n    // The source canvas has bgra8unorm back resource. We\n    // swizzle the channels to align with 2d/webgl canvas and\n    // clear alpha to opaque when context compositingAlphaMode\n    // is set to opaque (follow webgpu spec).\n    for (let i = 0; i < height; ++i) {\n      for (let j = 0; j < width; ++j) {\n        const pixelPos = i * width + j;\n        const r = rgbaPixels[pixelPos * bytesPerPixel + 2];\n        if (!premultipliedAlpha) {\n          rgbaPixels[pixelPos * bytesPerPixel + 3] = 255;\n        }\n\n        rgbaPixels[pixelPos * bytesPerPixel + 2] = rgbaPixels[pixelPos * bytesPerPixel];\n        rgbaPixels[pixelPos * bytesPerPixel] = r;\n      }\n    }\n\n    return rgbaPixels;\n  }\n\n  getTestImageURLByColorSpace(colorSpace: 'srgb' | 'display-p3'): string {\n    switch (colorSpace) {\n      case 'srgb':\n        return getResourcePath('Webkit-logo-sRGB.png');\n      case 'display-p3':\n        return getResourcePath('Webkit-logo-P3.png');\n      default:\n        unreachable();\n    }\n  }\n}\n\nexport const g = makeTestGroup(F);\n\ng.test('copy_contents_from_2d_context_canvas')\n  .desc(\n    `\n  Test HTMLCanvasElement and OffscreenCanvas with 2d context\n  can be copied to WebGPU texture correctly.\n\n  It creates HTMLCanvasElement/OffscreenCanvas with '2d'.\n  Use fillRect(2d context) to render red rect for top-left,\n  green rect for top-right, blue rect for bottom-left and white for bottom-right.\n\n  Then call copyExternalImageToTexture() to do a full copy to the 0 mipLevel\n  of dst texture, and read the contents out to compare with the canvas contents.\n\n  Provide premultiplied input if 'premultipliedAlpha' in 'GPUImageCopyTextureTagged'\n  is set to 'true' and unpremultiplied input if it is set to 'false'.\n\n  If 'flipY' in 'GPUImageCopyExternalImage' is set to 'true', copy will ensure the result\n  is flipped.\n\n  The tests covers:\n  - Valid canvas type\n  - Valid 2d context type\n  - Valid dstColorFormat of copyExternalImageToTexture()\n  - Valid dest alphaMode\n  - Valid 'flipY' config in 'GPUImageCopyExternalImage' (named 'srcDoFlipYDuringCopy' in cases)\n  - TODO(#913): color space tests need to be added\n  - TODO: Add error tolerance for rgb10a2unorm dst texture format\n\n  And the expected results are all passed.\n  `\n  )\n  .params(u =>\n    u\n      .combine('canvasType', allCanvasTypes)\n      .combine('dstColorFormat', kValidTextureFormatsForCopyE2T)\n      .combine('dstPremultiplied', [true, false])\n      .combine('srcDoFlipYDuringCopy', [true, false])\n      .beginSubcases()\n      .combine('width', [1, 2, 4, 15, 255, 256])\n      .combine('height', [1, 2, 4, 15, 255, 256])\n  )\n  .fn(async t => {\n    const {\n      width,\n      height,\n      canvasType,\n      dstColorFormat,\n      dstPremultiplied,\n      srcDoFlipYDuringCopy,\n    } = t.params;\n\n    // When dst texture format is rgb10a2unorm, the generated expected value of the result\n    // may have tiny errors compared to the actual result when the channel value is\n    // not 1.0 or 0.0.\n    // For example, we init the pixel with r channel to 0.6. And the denormalized value for\n    // 10-bit channel is 613.8, which needs to call \"round\" or other function to get an integer.\n    // It is possible that gpu adopt different \"round\" as our cpu implementation(we use Math.round())\n    // and it will generate tiny errors.\n    // So the cases with rgb10a2unorm dst texture format are handled specially by painting opaque rects\n    // to ensure they will have stable result after alphaOps(should keep the same value).\n    const { canvas, canvasContext } = t.init2DCanvasContent({\n      canvasType,\n      width,\n      height,\n      paintOpaqueRects: dstColorFormat === 'rgb10a2unorm',\n    });\n\n    const dst = t.device.createTexture({\n      size: {\n        width,\n        height,\n        depthOrArrayLayers: 1,\n      },\n      format: dstColorFormat,\n      usage:\n        GPUTextureUsage.COPY_DST | GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    // Construct expected value for different dst color format\n    const dstBytesPerPixel = kTextureFormatInfo[dstColorFormat].bytesPerBlock;\n    const format: RegularTextureFormat =\n      kTextureFormatInfo[dstColorFormat].baseFormat !== undefined\n        ? kTextureFormatInfo[dstColorFormat].baseFormat!\n        : dstColorFormat;\n\n    // For 2d canvas, get expected pixels with getImageData(), which returns unpremultiplied\n    // values.\n    const sourcePixels = t.getSourceCanvas2DContent(canvasContext, width, height);\n    const expectedPixels = t.getExpectedPixels(\n      sourcePixels,\n      width,\n      height,\n      format,\n      false,\n      dstPremultiplied,\n      srcDoFlipYDuringCopy\n    );\n\n    t.doTestAndCheckResult(\n      { source: canvas, origin: { x: 0, y: 0 }, flipY: srcDoFlipYDuringCopy },\n      {\n        texture: dst,\n        origin: { x: 0, y: 0 },\n        colorSpace: 'srgb',\n        premultipliedAlpha: dstPremultiplied,\n      },\n      { width: canvas.width, height: canvas.height, depthOrArrayLayers: 1 },\n      dstBytesPerPixel,\n      expectedPixels,\n      dstColorFormat\n    );\n  });\n\ng.test('copy_contents_from_gl_context_canvas')\n  .desc(\n    `\n  Test HTMLCanvasElement and OffscreenCanvas with webgl/webgl2 context\n  can be copied to WebGPU texture correctly.\n\n  It creates HTMLCanvasElement/OffscreenCanvas with webgl'/'webgl2'.\n  Use scissor + clear to render red rect for top-left, green rect\n  for top-right, blue rect for bottom-left and white for bottom-right.\n  And do premultiply alpha in advance if the webgl/webgl2 context is created\n  with premultipliedAlpha : true.\n\n  Then call copyExternalImageToTexture() to do a full copy to the 0 mipLevel\n  of dst texture, and read the contents out to compare with the canvas contents.\n\n  Provide premultiplied input if 'premultipliedAlpha' in 'GPUImageCopyTextureTagged'\n  is set to 'true' and unpremultiplied input if it is set to 'false'.\n\n  If 'flipY' in 'GPUImageCopyExternalImage' is set to 'true', copy will ensure the result\n  is flipped.\n\n  The tests covers:\n  - Valid canvas type\n  - Valid webgl/webgl2 context type\n  - Valid dstColorFormat of copyExternalImageToTexture()\n  - Valid source image alphaMode\n  - Valid dest alphaMode\n  - Valid 'flipY' config in 'GPUImageCopyExternalImage'(named 'srcDoFlipYDuringCopy' in cases)\n  - TODO: color space tests need to be added\n  - TODO: Add error tolerance for rgb10a2unorm dst texture format\n\n  And the expected results are all passed.\n  `\n  )\n  .params(u =>\n    u\n      .combine('canvasType', allCanvasTypes)\n      .combine('contextName', ['webgl', 'webgl2'] as const)\n      .combine('dstColorFormat', kValidTextureFormatsForCopyE2T)\n      .combine('srcPremultiplied', [true, false])\n      .combine('dstPremultiplied', [true, false])\n      .combine('srcDoFlipYDuringCopy', [true, false])\n      .beginSubcases()\n      .combine('width', [1, 2, 4, 15, 255, 256])\n      .combine('height', [1, 2, 4, 15, 255, 256])\n  )\n  .fn(async t => {\n    const {\n      width,\n      height,\n      canvasType,\n      contextName,\n      dstColorFormat,\n      srcPremultiplied,\n      dstPremultiplied,\n      srcDoFlipYDuringCopy,\n    } = t.params;\n\n    // When dst texture format is rgb10a2unorm, the generated expected value of the result\n    // may have tiny errors compared to the actual result when the channel value is\n    // not 1.0 or 0.0.\n    // For example, we init the pixel with r channel to 0.6. And the denormalized value for\n    // 10-bit channel is 613.8, which needs to call \"round\" or other function to get an integer.\n    // It is possible that gpu adopt different \"round\" as our cpu implementation(we use Math.round())\n    // and it will generate tiny errors.\n    // So the cases with rgb10a2unorm dst texture format are handled specially by by painting opaque rects\n    // to ensure they will have stable result after alphaOps(should keep the same value).\n    const { canvas, canvasContext } = t.initGLCanvasContent({\n      canvasType,\n      contextName,\n      width,\n      height,\n      premultiplied: srcPremultiplied,\n      paintOpaqueRects: dstColorFormat === 'rgb10a2unorm',\n    });\n\n    const dst = t.device.createTexture({\n      size: {\n        width,\n        height,\n        depthOrArrayLayers: 1,\n      },\n      format: dstColorFormat,\n      usage:\n        GPUTextureUsage.COPY_DST | GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    // Construct expected value for different dst color format\n    const dstBytesPerPixel = kTextureFormatInfo[dstColorFormat].bytesPerBlock;\n    const format: RegularTextureFormat =\n      kTextureFormatInfo[dstColorFormat].baseFormat !== undefined\n        ? kTextureFormatInfo[dstColorFormat].baseFormat!\n        : dstColorFormat;\n    const sourcePixels = t.getSourceCanvasGLContent(canvasContext, width, height);\n    const expectedPixels = t.getExpectedPixels(\n      sourcePixels,\n      width,\n      height,\n      format,\n      srcPremultiplied,\n      dstPremultiplied,\n      srcDoFlipYDuringCopy\n    );\n\n    t.doTestAndCheckResult(\n      { source: canvas, origin: { x: 0, y: 0 }, flipY: srcDoFlipYDuringCopy },\n      {\n        texture: dst,\n        origin: { x: 0, y: 0 },\n        colorSpace: 'srgb',\n        premultipliedAlpha: dstPremultiplied,\n      },\n      { width: canvas.width, height: canvas.height, depthOrArrayLayers: 1 },\n      dstBytesPerPixel,\n      expectedPixels,\n      dstColorFormat\n    );\n  });\n\ng.test('copy_contents_from_gpu_context_canvas')\n  .desc(\n    `\n  Test HTMLCanvasElement and OffscreenCanvas with webgpu context\n  can be copied to WebGPU texture correctly.\n\n  It creates HTMLCanvasElement/OffscreenCanvas with 'webgpu'.\n  Use writeTexture to copy pixels to back buffer. The results are:\n  red rect for top-left, green rect for top-right, blue rect for bottom-left\n  and white for bottom-right.\n\n  And do premultiply alpha in advance if the webgpu context is created\n  with compositingAlphaMode=\"premultiplied\".\n\n  Then call copyExternalImageToTexture() to do a full copy to the 0 mipLevel\n  of dst texture, and read the contents out to compare with the canvas contents.\n\n  Provide premultiplied input if 'premultipliedAlpha' in 'GPUImageCopyTextureTagged'\n  is set to 'true' and unpremultiplied input if it is set to 'false'.\n\n  If 'flipY' in 'GPUImageCopyExternalImage' is set to 'true', copy will ensure the result\n  is flipped.\n\n  The tests covers:\n  - Valid canvas type\n  - Source WebGPU Canvas lives in the same GPUDevice or different GPUDevice as test\n  - Valid dstColorFormat of copyExternalImageToTexture()\n  - Valid source image alphaMode\n  - Valid dest alphaMode\n  - Valid 'flipY' config in 'GPUImageCopyExternalImage'(named 'srcDoFlipYDuringCopy' in cases)\n  - TODO: color space tests need to be added\n  - TODO: Add error tolerance for rgb10a2unorm dst texture format\n\n  And the expected results are all passed.\n  `\n  )\n  .params(u =>\n    u\n      .combine('canvasType', allCanvasTypes)\n      .combine('srcAndDstInSameGPUDevice', [true, false])\n      .combine('dstColorFormat', kValidTextureFormatsForCopyE2T)\n      .combine('srcPremultiplied', [true])\n      .combine('dstPremultiplied', [true, false])\n      .combine('srcDoFlipYDuringCopy', [true, false])\n      .beginSubcases()\n      .combine('width', [1, 2, 4, 15, 255, 256])\n      .combine('height', [1, 2, 4, 15, 255, 256])\n  )\n  .fn(async t => {\n    const {\n      width,\n      height,\n      canvasType,\n      srcAndDstInSameGPUDevice,\n      dstColorFormat,\n      srcPremultiplied,\n      dstPremultiplied,\n      srcDoFlipYDuringCopy,\n    } = t.params;\n\n    let device: GPUDevice;\n\n    if (!srcAndDstInSameGPUDevice) {\n      await t.selectMismatchedDeviceOrSkipTestCase(undefined);\n      device = t.mismatchedDevice;\n    } else {\n      device = t.device;\n    }\n\n    // When dst texture format is rgb10a2unorm, the generated expected value of the result\n    // may have tiny errors compared to the actual result when the channel value is\n    // not 1.0 or 0.0.\n    // For example, we init the pixel with r channel to 0.6. And the denormalized value for\n    // 10-bit channel is 613.8, which needs to call \"round\" or other function to get an integer.\n    // It is possible that gpu adopt different \"round\" as our cpu implementation(we use Math.round())\n    // and it will generate tiny errors.\n    // So the cases with rgb10a2unorm dst texture format are handled specially by by painting opaque rects\n    // to ensure they will have stable result after alphaOps(should keep the same value).\n    const { canvas } = t.initGPUCanvasContent({\n      device,\n      canvasType,\n      width,\n      height,\n      premultiplied: srcPremultiplied,\n      paintOpaqueRects: dstColorFormat === 'rgb10a2unorm',\n    });\n\n    const dst = t.device.createTexture({\n      size: {\n        width,\n        height,\n        depthOrArrayLayers: 1,\n      },\n      format: dstColorFormat,\n      usage:\n        GPUTextureUsage.COPY_DST | GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    // Construct expected value for different dst color format\n    const dstBytesPerPixel = kTextureFormatInfo[dstColorFormat].bytesPerBlock;\n    const format = kTextureFormatInfo[dstColorFormat].baseFormat ?? dstColorFormat;\n    const sourcePixels = t.calculateSourceContentOnCPU(\n      width,\n      height,\n      srcPremultiplied,\n      dstColorFormat === 'rgb10a2unorm'\n    );\n    const expectedPixels = t.getExpectedPixels(\n      sourcePixels,\n      width,\n      height,\n      format,\n      srcPremultiplied,\n      dstPremultiplied,\n      srcDoFlipYDuringCopy\n    );\n\n    t.doTestAndCheckResult(\n      { source: canvas, origin: { x: 0, y: 0 }, flipY: srcDoFlipYDuringCopy },\n      {\n        texture: dst,\n        origin: { x: 0, y: 0 },\n        colorSpace: 'srgb',\n        premultipliedAlpha: dstPremultiplied,\n      },\n      { width: canvas.width, height: canvas.height, depthOrArrayLayers: 1 },\n      dstBytesPerPixel,\n      expectedPixels,\n      dstColorFormat\n    );\n  });\n\ng.test('color_space_conversion')\n  .desc(\n    `\n    Test HTMLCanvasElement with 2d context can created with 'colorSpace' attribute.\n    Using CopyExternalImageToTexture to copy from such type of canvas needs\n    to do color space converting correctly.\n  \n    It creates HTMLCanvasElement/OffscreenCanvas with '2d' and 'colorSpace' attributes.\n    Use fillRect(2d context) to render red rect for top-left,\n    green rect for top-right, blue rect for bottom-left and white for bottom-right.\n  \n    Then call copyExternalImageToTexture() to do a full copy to the 0 mipLevel\n    of dst texture, and read the contents out to compare with the canvas contents.\n  \n    Provide premultiplied input if 'premultipliedAlpha' in 'GPUImageCopyTextureTagged'\n    is set to 'true' and unpremultiplied input if it is set to 'false'.\n  \n    If 'flipY' in 'GPUImageCopyExternalImage' is set to 'true', copy will ensure the result\n    is flipped.\n\n    If color space from source input and user defined dstTexture color space are different, the\n    result must convert the content to user defined color space\n  \n    The tests covers:\n    - Valid dstColorFormat of copyExternalImageToTexture()\n    - Valid dest alphaMode\n    - Valid 'flipY' config in 'GPUImageCopyExternalImage' (named 'srcDoFlipYDuringCopy' in cases)\n    - Valid 'colorSpace' config in 'dstColorSpace'\n    - TODO: Add error tolerance for rgb10a2unorm dst texture format\n  \n    And the expected results are all passed.\n  `\n  )\n  .params(u =>\n    u\n      .combine('srcColorSpace', ['srgb', 'display-p3'] as const)\n      .combine('dstColorSpace', ['srgb'] as const)\n      .combine('dstColorFormat', kValidTextureFormatsForCopyE2T)\n      .combine('dstPremultiplied', [true, false])\n      .combine('srcDoFlipYDuringCopy', [true, false])\n      .beginSubcases()\n      .combine('width', [1, 2, 4, 15, 255, 256])\n      .combine('height', [1, 2, 4, 15, 255, 256])\n  )\n  .fn(async t => {\n    const {\n      width,\n      height,\n      srcColorSpace,\n      dstColorSpace,\n      dstColorFormat,\n      dstPremultiplied,\n      srcDoFlipYDuringCopy,\n    } = t.params;\n    const { canvas, canvasContext } = t.init2DCanvasContentWithColorSpace({\n      width,\n      height,\n      paintOpaqueRects: true,\n      colorSpace: srcColorSpace,\n    });\n\n    const dst = t.device.createTexture({\n      size: {\n        width,\n        height,\n        depthOrArrayLayers: 1,\n      },\n      format: dstColorFormat,\n      usage:\n        GPUTextureUsage.COPY_DST | GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    const sourcePixels = t.getSourceCanvas2DContent(canvasContext, width, height);\n\n    const dstBytesPerPixel = kTextureFormatInfo[dstColorFormat].bytesPerBlock;\n\n    const expectedPixels = t.getExpectedPixels(\n      sourcePixels,\n      width,\n      height,\n      dstColorFormat,\n      false,\n      dstPremultiplied,\n      srcDoFlipYDuringCopy,\n      srcColorSpace,\n      dstColorSpace\n    );\n\n    t.doTestAndCheckResult(\n      { source: canvas, origin: { x: 0, y: 0 }, flipY: srcDoFlipYDuringCopy },\n      {\n        texture: dst,\n        origin: { x: 0, y: 0 },\n        colorSpace: dstColorSpace,\n        premultipliedAlpha: dstPremultiplied,\n      },\n      { width: canvas.width, height: canvas.height, depthOrArrayLayers: 1 },\n      dstBytesPerPixel,\n      expectedPixels,\n      dstColorFormat\n    );\n  });\n"],"file":"canvas.spec.js"}