{"version":3,"sources":["../../../../src/webgpu/web_platform/reftests/canvas_composite_alpha.html.ts"],"names":["assert","unreachable","runRefTest","run","format","compositingAlphaMode","writeCanvasMethod","t","ctx","cvs","getContext","a","toFixed","usage","GPUTextureUsage","RENDER_ATTACHMENT","COPY_DST","configure","device","pipeline","createRenderPipeline","vertex","module","createShaderModule","code","entryPoint","fragment","targets","blend","undefined","color","srcFactor","dstFactor","operation","alpha","primitive","topology","renderTarget","getCurrentTexture","createTexture","size","canvas","width","height","COPY_SRC","renderPassDescriptor","colorAttachments","view","createView","clearValue","r","g","b","loadOp","storeOp","commandEncoder","createCommandEncoder","passEncoder","beginRenderPass","setPipeline","draw","end","copyTextureToTexture","texture","queue","submit","finish"],"mappings":";AAAA;AACA,GADA,SAASA,MAAT,EAAiBC,WAAjB,QAAoC,8BAApC,CAEA,SAASC,UAAT,QAA2B,mBAA3B;;AAEA;;;;;AAKA,OAAO,SAASC,GAAT;AACLC,MADK;AAELC,oBAFK;AAGLC,iBAHK;AAIL;AACAJ,EAAAA,UAAU,CAAC,OAAMK,CAAN,KAAW;AACpB,UAAMC,GAAG,GAAGC,GAAG,CAACC,UAAJ,CAAe,QAAf,CAAZ;AACAV,IAAAA,MAAM,CAACQ,GAAG,KAAK,IAAT,EAAe,0CAAf,CAAN;;AAEA,YAAQJ,MAAR;AACE,WAAK,YAAL;AACA,WAAK,iBAAL;AACA,WAAK,YAAL;AACA,WAAK,iBAAL;AACA,WAAK,aAAL;AACE;AACF;AACEH,QAAAA,WAAW,GARf;;;AAWA;AACA,UAAMU,CAAC,GAAGN,oBAAoB,KAAK,QAAzB,GAAqC,GAAD,CAAMO,OAAN,CAAc,CAAd,CAApC,GAAwD,GAAD,CAAMA,OAAN,CAAc,CAAd,CAAjE;;AAEA,QAAIC,KAAK,GAAG,CAAZ;AACA,YAAQP,iBAAR;AACE,WAAK,MAAL;AACEO,QAAAA,KAAK,GAAGC,eAAe,CAACC,iBAAxB;AACA;AACF,WAAK,MAAL;AACEF,QAAAA,KAAK,GAAGC,eAAe,CAACE,QAAxB;AACA,cANJ;;AAQAR,IAAAA,GAAG,CAACS,SAAJ,CAAc;AACZC,MAAAA,MAAM,EAAEX,CAAC,CAACW,MADE;AAEZd,MAAAA,MAFY;AAGZS,MAAAA,KAHY;AAIZR,MAAAA,oBAJY,EAAd;;;AAOA,UAAMc,QAAQ,GAAGZ,CAAC,CAACW,MAAF,CAASE,oBAAT,CAA8B;AAC7CC,MAAAA,MAAM,EAAE;AACNC,QAAAA,MAAM,EAAEf,CAAC,CAACW,MAAF,CAASK,kBAAT,CAA4B;AAClCC,UAAAA,IAAI,EAAG;AACjB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+BAA+Bb,CAAE;AACjC,+BAA+BA,CAAE;AACjC,+BAA+BA,CAAE;AACjC,+BAA+BA,CAAE;AACjC;AACA;AACA;AACA;AACA;AACA;AACA,SAlC4C,EAA5B,CADF;;AAqCNc,QAAAA,UAAU,EAAE,MArCN,EADqC;;AAwC7CC,MAAAA,QAAQ,EAAE;AACRJ,QAAAA,MAAM,EAAEf,CAAC,CAACW,MAAF,CAASK,kBAAT,CAA4B;AAClCC,UAAAA,IAAI,EAAG;AACjB;AACA;AACA;AACA;AACA,SAN4C,EAA5B,CADA;;AASRC,QAAAA,UAAU,EAAE,MATJ;AAURE,QAAAA,OAAO,EAAE;AACP;AACEvB,UAAAA,MADF;AAEEwB,UAAAA,KAAK;AACHvB,UAAAA,oBAAoB,KAAK,QAAzB;AACIwB,UAAAA,SADJ;AAEI;AACE;AACA;AACA;AACAC,YAAAA,KAAK,EAAE;AACLC,cAAAA,SAAS,EAAE,WADN;AAELC,cAAAA,SAAS,EAAE,qBAFN;AAGLC,cAAAA,SAAS,EAAE,KAHN,EAJT;;AASEC,YAAAA,KAAK,EAAE;AACLH,cAAAA,SAAS,EAAE,KADN;AAELC,cAAAA,SAAS,EAAE,qBAFN;AAGLC,cAAAA,SAAS,EAAE,KAHN,EATT,EALR,EADO,CAVD,EAxCmC;;;;;;AA0E7CE,MAAAA,SAAS,EAAE;AACTC,QAAAA,QAAQ,EAAE,eADD,EA1EkC,EAA9B,CAAjB;;;;AA+EA,QAAIC,YAAJ;AACA,YAAQ/B,iBAAR;AACE,WAAK,MAAL;AACE+B,QAAAA,YAAY,GAAG7B,GAAG,CAAC8B,iBAAJ,EAAf;AACA;AACF,WAAK,MAAL;AACED,QAAAA,YAAY,GAAG9B,CAAC,CAACW,MAAF,CAASqB,aAAT,CAAuB;AACpCC,UAAAA,IAAI,EAAE,CAAChC,GAAG,CAACiC,MAAJ,CAAWC,KAAZ,EAAmBlC,GAAG,CAACiC,MAAJ,CAAWE,MAA9B,CAD8B;AAEpCvC,UAAAA,MAFoC;AAGpCS,UAAAA,KAAK,EAAEC,eAAe,CAACC,iBAAhB,GAAoCD,eAAe,CAAC8B,QAHvB,EAAvB,CAAf;;AAKA,cAVJ;;AAYA,UAAMC,oBAA6C,GAAG;AACpDC,MAAAA,gBAAgB,EAAE;AAChB;AACEC,QAAAA,IAAI,EAAEV,YAAY,CAACW,UAAb,EADR;AAEEC,QAAAA,UAAU,EAAE,EAAEC,CAAC,EAAE,GAAL,EAAUC,CAAC,EAAE,GAAb,EAAkBC,CAAC,EAAE,GAArB,EAA0BzC,CAAC,EAAE,GAA7B,EAFd;AAGE0C,QAAAA,MAAM,EAAE,OAHV;AAIEC,QAAAA,OAAO,EAAE,OAJX,EADgB,CADkC,EAAtD;;;;;AAWA,UAAMC,cAAc,GAAGhD,CAAC,CAACW,MAAF,CAASsC,oBAAT,EAAvB;AACA,UAAMC,WAAW,GAAGF,cAAc,CAACG,eAAf,CAA+Bb,oBAA/B,CAApB;AACAY,IAAAA,WAAW,CAACE,WAAZ,CAAwBxC,QAAxB;AACAsC,IAAAA,WAAW,CAACG,IAAZ,CAAiB,CAAjB,EAAoB,CAApB,EAAuB,CAAvB,EAA0B,CAA1B;AACAH,IAAAA,WAAW,CAACG,IAAZ,CAAiB,CAAjB,EAAoB,CAApB,EAAuB,CAAvB,EAA0B,CAA1B;AACAH,IAAAA,WAAW,CAACG,IAAZ,CAAiB,CAAjB,EAAoB,CAApB,EAAuB,EAAvB,EAA2B,CAA3B;AACAH,IAAAA,WAAW,CAACG,IAAZ,CAAiB,CAAjB,EAAoB,CAApB,EAAuB,EAAvB,EAA2B,CAA3B;AACAH,IAAAA,WAAW,CAACI,GAAZ;;AAEA,YAAQvD,iBAAR;AACE,WAAK,MAAL;AACE;AACF,WAAK,MAAL;AACEiD,QAAAA,cAAc,CAACO,oBAAf;AACE;AACEC,UAAAA,OAAO,EAAE1B,YADX,EADF;;AAIE;AACE0B,UAAAA,OAAO,EAAEvD,GAAG,CAAC8B,iBAAJ,EADX,EAJF;;AAOE,SAAC9B,GAAG,CAACiC,MAAJ,CAAWC,KAAZ,EAAmBlC,GAAG,CAACiC,MAAJ,CAAWE,MAA9B,CAPF;;AASA,cAbJ;;;AAgBApC,IAAAA,CAAC,CAACW,MAAF,CAAS8C,KAAT,CAAeC,MAAf,CAAsB,CAACV,cAAc,CAACW,MAAf,EAAD,CAAtB;AACD,GAnKS,CAAV;AAoKD","sourcesContent":["import { assert, unreachable } from '../../../common/util/util.js';\n\nimport { runRefTest } from './gpu_ref_test.js';\n\n// <canvas> element from html page\ndeclare const cvs: HTMLCanvasElement;\n\ntype WriteCanvasMethod = 'draw' | 'copy';\n\nexport function run(\n  format: GPUTextureFormat,\n  compositingAlphaMode: GPUCanvasCompositingAlphaMode,\n  writeCanvasMethod: WriteCanvasMethod\n) {\n  runRefTest(async t => {\n    const ctx = cvs.getContext('webgpu');\n    assert(ctx !== null, 'Failed to get WebGPU context from canvas');\n\n    switch (format) {\n      case 'bgra8unorm':\n      case 'bgra8unorm-srgb':\n      case 'rgba8unorm':\n      case 'rgba8unorm-srgb':\n      case 'rgba16float':\n        break;\n      default:\n        unreachable();\n    }\n\n    // This is mimic globalAlpha in 2d context blending behavior\n    const a = compositingAlphaMode === 'opaque' ? (1.0).toFixed(1) : (0.5).toFixed(1);\n\n    let usage = 0;\n    switch (writeCanvasMethod) {\n      case 'draw':\n        usage = GPUTextureUsage.RENDER_ATTACHMENT;\n        break;\n      case 'copy':\n        usage = GPUTextureUsage.COPY_DST;\n        break;\n    }\n    ctx.configure({\n      device: t.device,\n      format,\n      usage,\n      compositingAlphaMode,\n    });\n\n    const pipeline = t.device.createRenderPipeline({\n      vertex: {\n        module: t.device.createShaderModule({\n          code: `\nstruct VertexOutput {\n@builtin(position) Position : vec4<f32>;\n@location(0) fragColor : vec4<f32>;\n};\n\n@stage(vertex)\nfn main(@builtin(vertex_index) VertexIndex : u32) -> VertexOutput {\nvar pos = array<vec2<f32>, 6>(\n    vec2<f32>( 0.75,  0.75),\n    vec2<f32>( 0.75, -0.75),\n    vec2<f32>(-0.75, -0.75),\n    vec2<f32>( 0.75,  0.75),\n    vec2<f32>(-0.75, -0.75),\n    vec2<f32>(-0.75,  0.75));\n\nvar offset = array<vec2<f32>, 4>(\nvec2<f32>( -0.25,  0.25),\nvec2<f32>( 0.25, 0.25),\nvec2<f32>(-0.25, -0.25),\nvec2<f32>( 0.25,  -0.25));\n\nvar color = array<vec4<f32>, 4>(\n    vec4<f32>(0.4, 0.0, 0.0, ${a}),\n    vec4<f32>(0.0, 0.4, 0.0, ${a}),\n    vec4<f32>(0.0, 0.0, 0.4, ${a}),\n    vec4<f32>(0.4, 0.4, 0.0, ${a})); // 0.4 -> 0x66\n\nvar output : VertexOutput;\noutput.Position = vec4<f32>(pos[VertexIndex % 6u] + offset[VertexIndex / 6u], 0.0, 1.0);\noutput.fragColor = color[VertexIndex / 6u];\nreturn output;\n}\n        `,\n        }),\n        entryPoint: 'main',\n      },\n      fragment: {\n        module: t.device.createShaderModule({\n          code: `\n@stage(fragment)\nfn main(@location(0) fragColor: vec4<f32>) -> @location(0) vec4<f32> {\nreturn fragColor;\n}\n        `,\n        }),\n        entryPoint: 'main',\n        targets: [\n          {\n            format,\n            blend:\n              compositingAlphaMode === 'opaque'\n                ? undefined\n                : {\n                    // The blending behavior here is to mimic 2d context blending behavior\n                    // of drawing rects in order\n                    // https://drafts.fxtf.org/compositing/#porterduffcompositingoperators_srcover\n                    color: {\n                      srcFactor: 'src-alpha',\n                      dstFactor: 'one-minus-src-alpha',\n                      operation: 'add',\n                    },\n                    alpha: {\n                      srcFactor: 'one',\n                      dstFactor: 'one-minus-src-alpha',\n                      operation: 'add',\n                    },\n                  },\n          },\n        ],\n      },\n      primitive: {\n        topology: 'triangle-list',\n      },\n    });\n\n    let renderTarget: GPUTexture;\n    switch (writeCanvasMethod) {\n      case 'draw':\n        renderTarget = ctx.getCurrentTexture();\n        break;\n      case 'copy':\n        renderTarget = t.device.createTexture({\n          size: [ctx.canvas.width, ctx.canvas.height],\n          format,\n          usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n        });\n        break;\n    }\n    const renderPassDescriptor: GPURenderPassDescriptor = {\n      colorAttachments: [\n        {\n          view: renderTarget.createView(),\n          clearValue: { r: 0.0, g: 0.0, b: 0.0, a: 0.0 },\n          loadOp: 'clear',\n          storeOp: 'store',\n        },\n      ],\n    };\n\n    const commandEncoder = t.device.createCommandEncoder();\n    const passEncoder = commandEncoder.beginRenderPass(renderPassDescriptor);\n    passEncoder.setPipeline(pipeline);\n    passEncoder.draw(6, 1, 0, 0);\n    passEncoder.draw(6, 1, 6, 0);\n    passEncoder.draw(6, 1, 12, 0);\n    passEncoder.draw(6, 1, 18, 0);\n    passEncoder.end();\n\n    switch (writeCanvasMethod) {\n      case 'draw':\n        break;\n      case 'copy':\n        commandEncoder.copyTextureToTexture(\n          {\n            texture: renderTarget,\n          },\n          {\n            texture: ctx.getCurrentTexture(),\n          },\n          [ctx.canvas.width, ctx.canvas.height]\n        );\n        break;\n    }\n\n    t.device.queue.submit([commandEncoder.finish()]);\n  });\n}\n"],"file":"canvas_composite_alpha.html.js"}