{"version":3,"sources":["../../../../../src/webgpu/shader/execution/memory_model/barrier.spec.ts"],"names":["description","makeTestGroup","GPUTest","MemoryModelTester","buildTestShader","MemoryType","TestType","buildResultShader","ResultType","g","memoryModelTestParams","workgroupSize","testingWorkgroups","maxWorkgroups","shufflePct","barrierPct","memStressPct","memStressIterations","memStressStoreFirstPct","memStressStoreSecondPct","preStressPct","preStressIterations","preStressStoreFirstPct","preStressStoreSecondPct","scratchMemorySize","stressLineSize","stressTargetLines","stressStrategyBalancePct","permuteFirst","permuteSecond","memStride","aliasedMemory","numBehaviors","storageMemoryBarrierStoreLoadTestCode","workgroupMemoryBarrierStoreLoadTestCode","test","desc","paramsSimple","memType","NonAtomicStorageClass","_testCode","NonAtomicWorkgroupClass","fn","t","resultCode","testShader","params","IntraWorkgroup","resultShader","TwoBehavior","memModelTester","run","storageMemoryBarrierLoadStoreTestCode","workgroupMemoryBarrierLoadStoreTestCode","storageMemoryBarrierStoreStoreTestCode","workgroupMemoryBarrierStoreStoreTestCode"],"mappings":"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","sourcesContent":["export const description = `\nTests for non-atomic memory synchronization within a workgroup in the presence of a WebGPU barrier`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { GPUTest } from '../../../gpu_test.js';\n\nimport {\n  MemoryModelTestParams,\n  MemoryModelTester,\n  buildTestShader,\n  MemoryType,\n  TestType,\n  buildResultShader,\n  ResultType,\n} from './memory_model_setup.js';\n\nexport const g = makeTestGroup(GPUTest);\n\n// A reasonable parameter set, determined heuristically.\nconst memoryModelTestParams: MemoryModelTestParams = {\n  workgroupSize: 256,\n  testingWorkgroups: 512,\n  maxWorkgroups: 1024,\n  shufflePct: 100,\n  barrierPct: 100,\n  memStressPct: 100,\n  memStressIterations: 1024,\n  memStressStoreFirstPct: 50,\n  memStressStoreSecondPct: 50,\n  preStressPct: 100,\n  preStressIterations: 1024,\n  preStressStoreFirstPct: 50,\n  preStressStoreSecondPct: 50,\n  scratchMemorySize: 2048,\n  stressLineSize: 64,\n  stressTargetLines: 2,\n  stressStrategyBalancePct: 50,\n  permuteFirst: 109,\n  permuteSecond: 419,\n  memStride: 4,\n  aliasedMemory: false,\n  numBehaviors: 2,\n};\n\nconst storageMemoryBarrierStoreLoadTestCode = `\n  test_locations.value[x_0] = 1u;\n  workgroupBarrier();\n  let r0 = test_locations.value[x_1];\n  atomicStore(&results.value[shuffled_workgroup * workgroupXSize + id_1].r0, r0);\n`;\n\nconst workgroupMemoryBarrierStoreLoadTestCode = `\n  wg_test_locations[x_0] = 1u;\n  workgroupBarrier();\n  let r0 = wg_test_locations[x_1];\n  atomicStore(&results.value[shuffled_workgroup * workgroupXSize + id_1].r0, r0);\n`;\n\ng.test('workgroup_barrier_store_load')\n  .desc(\n    `Checks whether the workgroup barrier properly synchronizes a non-atomic write and read on\n    separate threads in the same workgroup. Within a workgroup, the barrier should force an invocation\n    after the barrier to read a write from an invocation before the barrier.\n    `\n  )\n  .paramsSimple([\n    { memType: MemoryType.NonAtomicStorageClass, _testCode: storageMemoryBarrierStoreLoadTestCode },\n    {\n      memType: MemoryType.NonAtomicWorkgroupClass,\n      _testCode: workgroupMemoryBarrierStoreLoadTestCode,\n    },\n  ])\n  .fn(async t => {\n    const resultCode = `\n      if (r0 == 1u) {\n        atomicAdd(&test_results.seq, 1u);\n      } else if (r0 == 0u) {\n        atomicAdd(&test_results.weak, 1u);\n      }\n    `;\n    const testShader = buildTestShader(\n      t.params._testCode,\n      t.params.memType,\n      TestType.IntraWorkgroup\n    );\n    const resultShader = buildResultShader(\n      resultCode,\n      TestType.IntraWorkgroup,\n      ResultType.TwoBehavior\n    );\n    const memModelTester = new MemoryModelTester(\n      t,\n      memoryModelTestParams,\n      testShader,\n      resultShader\n    );\n    await memModelTester.run(15, 1);\n  });\n\nconst storageMemoryBarrierLoadStoreTestCode = `\n  let r0 = test_locations.value[x_0];\n  workgroupBarrier();\n  test_locations.value[x_1] = 1u;\n  atomicStore(&results.value[shuffled_workgroup * workgroupXSize + id_0].r0, r0);\n`;\n\nconst workgroupMemoryBarrierLoadStoreTestCode = `\n  let r0 = wg_test_locations[x_0];\n  workgroupBarrier();\n  wg_test_locations[x_1] = 1u;\n  atomicStore(&results.value[shuffled_workgroup * workgroupXSize + id_0].r0, r0);\n`;\n\ng.test('workgroup_barrier_load_store')\n  .desc(\n    `Checks whether the workgroup barrier properly synchronizes a non-atomic write and read on\n    separate threads in the same workgroup. Within a workgroup, the barrier should force an invocation\n    before the barrier to not read the write from an invocation after the barrier.\n    `\n  )\n  .paramsSimple([\n    { memType: MemoryType.NonAtomicStorageClass, _testCode: storageMemoryBarrierLoadStoreTestCode },\n    {\n      memType: MemoryType.NonAtomicWorkgroupClass,\n      _testCode: workgroupMemoryBarrierLoadStoreTestCode,\n    },\n  ])\n  .fn(async t => {\n    const resultCode = `\n      if (r0 == 0u) {\n        atomicAdd(&test_results.seq, 1u);\n      } else if (r0 == 1u) {\n        atomicAdd(&test_results.weak, 1u);\n      }\n    `;\n    const testShader = buildTestShader(\n      t.params._testCode,\n      t.params.memType,\n      TestType.IntraWorkgroup\n    );\n    const resultShader = buildResultShader(\n      resultCode,\n      TestType.IntraWorkgroup,\n      ResultType.TwoBehavior\n    );\n    const memModelTester = new MemoryModelTester(\n      t,\n      memoryModelTestParams,\n      testShader,\n      resultShader\n    );\n    await memModelTester.run(12, 1);\n  });\n\nconst storageMemoryBarrierStoreStoreTestCode = `\n  test_locations.value[x_0] = 1u;\n  storageBarrier();\n  test_locations.value[x_1] = 2u;\n`;\n\nconst workgroupMemoryBarrierStoreStoreTestCode = `\n  wg_test_locations[x_0] = 1u;\n  workgroupBarrier();\n  wg_test_locations[x_1] = 2u;\n  workgroupBarrier();\n  test_locations.value[shuffled_workgroup * workgroupXSize * stress_params.mem_stride * 2u + x_1] = wg_test_locations[x_1];\n`;\n\ng.test('workgroup_barrier_store_store')\n  .desc(\n    `Checks whether the workgroup barrier properly synchronizes non-atomic writes on\n    separate threads in the same workgroup. Within a workgroup, the barrier should force the value in memory\n    to be the result of the write after the barrier, not the write before.\n    `\n  )\n  .paramsSimple([\n    {\n      memType: MemoryType.NonAtomicStorageClass,\n      _testCode: storageMemoryBarrierStoreStoreTestCode,\n    },\n    {\n      memType: MemoryType.NonAtomicWorkgroupClass,\n      _testCode: workgroupMemoryBarrierStoreStoreTestCode,\n    },\n  ])\n  .fn(async t => {\n    const resultCode = `\n      if (mem_x_0 == 2u) {\n        atomicAdd(&test_results.seq, 1u);\n      } else if (mem_x_0 == 1u) {\n        atomicAdd(&test_results.weak, 1u);\n      }\n    `;\n    const testShader = buildTestShader(\n      t.params._testCode,\n      t.params.memType,\n      TestType.IntraWorkgroup\n    );\n    const resultShader = buildResultShader(\n      resultCode,\n      TestType.IntraWorkgroup,\n      ResultType.TwoBehavior\n    );\n    const memModelTester = new MemoryModelTester(\n      t,\n      memoryModelTestParams,\n      testShader,\n      resultShader\n    );\n    await memModelTester.run(10, 1);\n  });\n"],"file":"barrier.spec.js"}