{"version":3,"file":"case_cache.js","names":["dataCache","deserializeComparator","Scalar","Vector","serializeValue","deserializeValue","Matrix","deserializeF32Interval","F32Interval","serializeF32Interval","flatten2DArray","unflatten2DArray","serializeExpectation","e","kind","value","Array","cols","length","rows","map","Function","comp","undefined","data","deserializeExpectation","serializeCase","c","input","v","expected","deserializeCase","CaseCache","constructor","name","builders","path","get","fetch","build","built","cases","Promise","resolve","serialize","serialized","JSON","stringify","deserialize","parse","casesByName","caseData","makeCaseCache"],"sources":["../../../../../src/webgpu/shader/execution/expression/case_cache.ts"],"sourcesContent":["import { Cacheable, dataCache } from '../../../../common/framework/data_cache.js';\nimport { SerializedComparator, deserializeComparator } from '../../../util/compare.js';\nimport {\n  Scalar,\n  Vector,\n  serializeValue,\n  SerializedValue,\n  deserializeValue,\n  Matrix,\n} from '../../../util/conversion.js';\nimport {\n  deserializeF32Interval,\n  F32Interval,\n  SerializedF32Interval,\n  serializeF32Interval,\n} from '../../../util/f32_interval.js';\nimport { flatten2DArray, unflatten2DArray } from '../../../util/math.js';\n\nimport { Case, CaseList, Expectation } from './expression.js';\n\n/**\n * SerializedExpectationValue holds the serialized form of an Expectation when\n * the Expectation is a Value\n * This form can be safely encoded to JSON.\n */\ntype SerializedExpectationValue = {\n  kind: 'value';\n  value: SerializedValue;\n};\n\n/**\n * SerializedExpectationInterval holds the serialized form of an Expectation when\n * the Expectation is an Interval\n * This form can be safely encoded to JSON.\n */\ntype SerializedExpectationInterval = {\n  kind: 'interval';\n  value: SerializedF32Interval;\n};\n\n/**\n * SerializedExpectationIntervals holds the serialized form of an Expectation when\n * the Expectation is a list of Intervals\n * This form can be safely encoded to JSON.\n */\ntype SerializedExpectationIntervals = {\n  kind: 'intervals';\n  value: SerializedF32Interval[];\n};\n\n/**\n * SerializedExpectation2DIntervalArray holds the serialized form of an\n * Expectation when the Expectation is a 2d array of Intervals. The array is\n * flattened to a 1D array for storage.\n * This form can be safely encoded to JSON.\n */\ntype SerializedExpectation2DIntervalArray = {\n  kind: '2d-interval-array';\n  cols: number;\n  rows: number;\n  value: SerializedF32Interval[];\n};\n\n/**\n * SerializedExpectationValue holds the serialized form of an Expectation when\n * the Expectation is a Comparator\n * This form can be safely encoded to JSON.\n */\ntype SerializedExpectationComparator = {\n  kind: 'comparator';\n  value: SerializedComparator;\n};\n\n/**\n * SerializedExpectation holds the serialized form of an Expectation.\n * This form can be safely encoded to JSON.\n */\nexport type SerializedExpectation =\n  | SerializedExpectationValue\n  | SerializedExpectationInterval\n  | SerializedExpectationIntervals\n  | SerializedExpectation2DIntervalArray\n  | SerializedExpectationComparator;\n\n/** serializeExpectation() converts an Expectation to a SerializedExpectation */\nexport function serializeExpectation(e: Expectation): SerializedExpectation {\n  if (e instanceof Scalar || e instanceof Vector || e instanceof Matrix) {\n    return { kind: 'value', value: serializeValue(e) };\n  }\n  if (e instanceof F32Interval) {\n    return { kind: 'interval', value: serializeF32Interval(e) };\n  }\n  if (e instanceof Array) {\n    if (e[0] instanceof Array) {\n      e = e as F32Interval[][];\n      const cols = e.length;\n      const rows = e[0].length;\n      return {\n        kind: '2d-interval-array',\n        cols,\n        rows,\n        value: flatten2DArray(e).map(serializeF32Interval),\n      };\n    } else {\n      e = e as F32Interval[];\n      return { kind: 'intervals', value: e.map(serializeF32Interval) };\n    }\n  }\n  if (e instanceof Function) {\n    const comp = (e as unknown) as SerializedComparator;\n    if (comp !== undefined) {\n      // if blocks used to refine the type of comp.kind, otherwise it is\n      // actually the union of the string values\n      if (comp.kind === 'anyOf') {\n        return { kind: 'comparator', value: { kind: comp.kind, data: comp.data } };\n      }\n      if (comp.kind === 'skipUndefined') {\n        return { kind: 'comparator', value: { kind: comp.kind, data: comp.data } };\n      }\n    }\n    throw 'cannot serialize comparator';\n  }\n  throw 'cannot serialize expectation';\n}\n\n/** deserializeExpectation() converts a SerializedExpectation to a Expectation */\nexport function deserializeExpectation(data: SerializedExpectation): Expectation {\n  switch (data.kind) {\n    case 'value':\n      return deserializeValue(data.value);\n    case 'interval':\n      return deserializeF32Interval(data.value);\n    case 'intervals':\n      return data.value.map(deserializeF32Interval);\n    case '2d-interval-array':\n      return unflatten2DArray(data.value.map(deserializeF32Interval), data.cols, data.rows);\n    case 'comparator':\n      return deserializeComparator(data.value);\n  }\n}\n\n/**\n * SerializedCase holds the serialized form of a Case.\n * This form can be safely encoded to JSON.\n */\nexport type SerializedCase = {\n  input: SerializedValue | SerializedValue[];\n  expected: SerializedExpectation;\n};\n\n/** serializeCase() converts an Case to a SerializedCase */\nexport function serializeCase(c: Case): SerializedCase {\n  return {\n    input: c.input instanceof Array ? c.input.map(v => serializeValue(v)) : serializeValue(c.input),\n    expected: serializeExpectation(c.expected),\n  };\n}\n\n/** serializeCase() converts an SerializedCase to a Case */\nexport function deserializeCase(data: SerializedCase): Case {\n  return {\n    input:\n      data.input instanceof Array\n        ? data.input.map(v => deserializeValue(v))\n        : deserializeValue(data.input),\n    expected: deserializeExpectation(data.expected),\n  };\n}\n\n/** CaseListBuilder is a function that builds a CaseList */\nexport type CaseListBuilder = () => CaseList;\n\n/**\n * CaseCache is a cache of CaseList.\n * CaseCache implements the Cacheable interface, so the cases can be pre-built\n * and stored in the data cache, reducing computation costs at CTS runtime.\n */\nexport class CaseCache implements Cacheable<Record<string, CaseList>> {\n  /**\n   * Constructor\n   * @param name the name of the cache. This must be globally unique.\n   * @param builders a Record of case-list name to case-list builder.\n   */\n  constructor(name: string, builders: Record<string, CaseListBuilder>) {\n    this.path = `webgpu/shader/execution/case-cache/${name}.json`;\n    this.builders = builders;\n  }\n\n  /** get() returns the list of cases with the given name */\n  public async get(name: string): Promise<CaseList> {\n    const data = await dataCache.fetch(this);\n    return data[name];\n  }\n\n  /**\n   * build() implements the Cacheable.build interface.\n   * @returns the data.\n   */\n  build(): Promise<Record<string, CaseList>> {\n    const built: Record<string, CaseList> = {};\n    for (const name in this.builders) {\n      const cases = this.builders[name]();\n      built[name] = cases;\n    }\n    return Promise.resolve(built);\n  }\n\n  /**\n   * serialize() implements the Cacheable.serialize interface.\n   * @returns the serialized data.\n   */\n  serialize(data: Record<string, CaseList>): string {\n    const serialized: Record<string, SerializedCase[]> = {};\n    for (const name in data) {\n      serialized[name] = data[name].map(c => serializeCase(c));\n    }\n    return JSON.stringify(serialized);\n  }\n\n  /**\n   * deserialize() implements the Cacheable.deserialize interface.\n   * @returns the deserialize data.\n   */\n  deserialize(serialized: string): Record<string, CaseList> {\n    const data = JSON.parse(serialized) as Record<string, SerializedCase[]>;\n    const casesByName: Record<string, CaseList> = {};\n    for (const name in data) {\n      const cases = data[name].map(caseData => deserializeCase(caseData));\n      casesByName[name] = cases;\n    }\n    return casesByName;\n  }\n\n  public readonly path: string;\n  private readonly builders: Record<string, CaseListBuilder>;\n}\n\nexport function makeCaseCache(name: string, builders: Record<string, CaseListBuilder>): CaseCache {\n  return new CaseCache(name, builders);\n}\n"],"mappings":";AAAA;AAAA,GAAA,SAAoBA,SAAS,QAAQ,4CAA4C,CACjF,SAA+BC,qBAAqB,QAAQ,0BAA0B,CACtF;AACEC,MAAM;AACNC,MAAM;AACNC,cAAc;;AAEdC,gBAAgB;AAChBC,MAAM;AACD,6BAA6B;AACpC;AACEC,sBAAsB;AACtBC,WAAW;;AAEXC,oBAAoB;AACf,+BAA+B;AACtC,SAASC,cAAc,EAAEC,gBAAgB,QAAQ,uBAAuB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAoExE;AACA,OAAO,SAASC,oBAAoB,CAACC,CAAc,EAAyB;EAC1E,IAAIA,CAAC,YAAYX,MAAM,IAAIW,CAAC,YAAYV,MAAM,IAAIU,CAAC,YAAYP,MAAM,EAAE;IACrE,OAAO,EAAEQ,IAAI,EAAE,OAAO,EAAEC,KAAK,EAAEX,cAAc,CAACS,CAAC,CAAC,CAAC,CAAC;EACpD;EACA,IAAIA,CAAC,YAAYL,WAAW,EAAE;IAC5B,OAAO,EAAEM,IAAI,EAAE,UAAU,EAAEC,KAAK,EAAEN,oBAAoB,CAACI,CAAC,CAAC,CAAC,CAAC;EAC7D;EACA,IAAIA,CAAC,YAAYG,KAAK,EAAE;IACtB,IAAIH,CAAC,CAAC,CAAC,CAAC,YAAYG,KAAK,EAAE;MACzBH,CAAC,GAAGA,CAAoB;MACxB,MAAMI,IAAI,GAAGJ,CAAC,CAACK,MAAM;MACrB,MAAMC,IAAI,GAAGN,CAAC,CAAC,CAAC,CAAC,CAACK,MAAM;MACxB,OAAO;QACLJ,IAAI,EAAE,mBAAmB;QACzBG,IAAI;QACJE,IAAI;QACJJ,KAAK,EAAEL,cAAc,CAACG,CAAC,CAAC,CAACO,GAAG,CAACX,oBAAoB;MACnD,CAAC;IACH,CAAC,MAAM;MACLI,CAAC,GAAGA,CAAkB;MACtB,OAAO,EAAEC,IAAI,EAAE,WAAW,EAAEC,KAAK,EAAEF,CAAC,CAACO,GAAG,CAACX,oBAAoB,CAAC,CAAC,CAAC;IAClE;EACF;EACA,IAAII,CAAC,YAAYQ,QAAQ,EAAE;IACzB,MAAMC,IAAI,GAAIT,CAAqC;IACnD,IAAIS,IAAI,KAAKC,SAAS,EAAE;MACtB;MACA;MACA,IAAID,IAAI,CAACR,IAAI,KAAK,OAAO,EAAE;QACzB,OAAO,EAAEA,IAAI,EAAE,YAAY,EAAEC,KAAK,EAAE,EAAED,IAAI,EAAEQ,IAAI,CAACR,IAAI,EAAEU,IAAI,EAAEF,IAAI,CAACE,IAAI,CAAC,CAAC,CAAC,CAAC;MAC5E;MACA,IAAIF,IAAI,CAACR,IAAI,KAAK,eAAe,EAAE;QACjC,OAAO,EAAEA,IAAI,EAAE,YAAY,EAAEC,KAAK,EAAE,EAAED,IAAI,EAAEQ,IAAI,CAACR,IAAI,EAAEU,IAAI,EAAEF,IAAI,CAACE,IAAI,CAAC,CAAC,CAAC,CAAC;MAC5E;IACF;IACA,MAAM,6BAA6B;EACrC;EACA,MAAM,8BAA8B;AACtC;;AAEA;AACA,OAAO,SAASC,sBAAsB,CAACD,IAA2B,EAAe;EAC/E,QAAQA,IAAI,CAACV,IAAI;IACf,KAAK,OAAO;MACV,OAAOT,gBAAgB,CAACmB,IAAI,CAACT,KAAK,CAAC;IACrC,KAAK,UAAU;MACb,OAAOR,sBAAsB,CAACiB,IAAI,CAACT,KAAK,CAAC;IAC3C,KAAK,WAAW;MACd,OAAOS,IAAI,CAACT,KAAK,CAACK,GAAG,CAACb,sBAAsB,CAAC;IAC/C,KAAK,mBAAmB;MACtB,OAAOI,gBAAgB,CAACa,IAAI,CAACT,KAAK,CAACK,GAAG,CAACb,sBAAsB,CAAC,EAAEiB,IAAI,CAACP,IAAI,EAAEO,IAAI,CAACL,IAAI,CAAC;IACvF,KAAK,YAAY;MACf,OAAOlB,qBAAqB,CAACuB,IAAI,CAACT,KAAK,CAAC,CAAC;;AAE/C;;AAEA;AACA;AACA;AACA;;;;;;AAMA;AACA,OAAO,SAASW,aAAa,CAACC,CAAO,EAAkB;EACrD,OAAO;IACLC,KAAK,EAAED,CAAC,CAACC,KAAK,YAAYZ,KAAK,GAAGW,CAAC,CAACC,KAAK,CAACR,GAAG,CAAC,CAAAS,CAAC,KAAIzB,cAAc,CAACyB,CAAC,CAAC,CAAC,GAAGzB,cAAc,CAACuB,CAAC,CAACC,KAAK,CAAC;IAC/FE,QAAQ,EAAElB,oBAAoB,CAACe,CAAC,CAACG,QAAQ;EAC3C,CAAC;AACH;;AAEA;AACA,OAAO,SAASC,eAAe,CAACP,IAAoB,EAAQ;EAC1D,OAAO;IACLI,KAAK;IACHJ,IAAI,CAACI,KAAK,YAAYZ,KAAK;IACvBQ,IAAI,CAACI,KAAK,CAACR,GAAG,CAAC,CAAAS,CAAC,KAAIxB,gBAAgB,CAACwB,CAAC,CAAC,CAAC;IACxCxB,gBAAgB,CAACmB,IAAI,CAACI,KAAK,CAAC;IAClCE,QAAQ,EAAEL,sBAAsB,CAACD,IAAI,CAACM,QAAQ;EAChD,CAAC;AACH;;AAEA;;;AAGA;AACA;AACA;AACA;AACA;AACA,OAAO,MAAME,SAAS,CAAgD;EACpE;AACF;AACA;AACA;AACA;EACEC,WAAW,CAACC,IAAY,EAAEC,QAAyC,EAAE;IACnE,IAAI,CAACC,IAAI,GAAI,sCAAqCF,IAAK,OAAM;IAC7D,IAAI,CAACC,QAAQ,GAAGA,QAAQ;EAC1B;;EAEA;EACA,MAAaE,GAAG,CAACH,IAAY,EAAqB;IAChD,MAAMV,IAAI,GAAG,MAAMxB,SAAS,CAACsC,KAAK,CAAC,IAAI,CAAC;IACxC,OAAOd,IAAI,CAACU,IAAI,CAAC;EACnB;;EAEA;AACF;AACA;AACA;EACEK,KAAK,GAAsC;IACzC,MAAMC,KAA+B,GAAG,CAAC,CAAC;IAC1C,KAAK,MAAMN,IAAI,IAAI,IAAI,CAACC,QAAQ,EAAE;MAChC,MAAMM,KAAK,GAAG,IAAI,CAACN,QAAQ,CAACD,IAAI,CAAC,EAAE;MACnCM,KAAK,CAACN,IAAI,CAAC,GAAGO,KAAK;IACrB;IACA,OAAOC,OAAO,CAACC,OAAO,CAACH,KAAK,CAAC;EAC/B;;EAEA;AACF;AACA;AACA;EACEI,SAAS,CAACpB,IAA8B,EAAU;IAChD,MAAMqB,UAA4C,GAAG,CAAC,CAAC;IACvD,KAAK,MAAMX,IAAI,IAAIV,IAAI,EAAE;MACvBqB,UAAU,CAACX,IAAI,CAAC,GAAGV,IAAI,CAACU,IAAI,CAAC,CAACd,GAAG,CAAC,CAAAO,CAAC,KAAID,aAAa,CAACC,CAAC,CAAC,CAAC;IAC1D;IACA,OAAOmB,IAAI,CAACC,SAAS,CAACF,UAAU,CAAC;EACnC;;EAEA;AACF;AACA;AACA;EACEG,WAAW,CAACH,UAAkB,EAA4B;IACxD,MAAMrB,IAAI,GAAGsB,IAAI,CAACG,KAAK,CAACJ,UAAU,CAAqC;IACvE,MAAMK,WAAqC,GAAG,CAAC,CAAC;IAChD,KAAK,MAAMhB,IAAI,IAAIV,IAAI,EAAE;MACvB,MAAMiB,KAAK,GAAGjB,IAAI,CAACU,IAAI,CAAC,CAACd,GAAG,CAAC,CAAA+B,QAAQ,KAAIpB,eAAe,CAACoB,QAAQ,CAAC,CAAC;MACnED,WAAW,CAAChB,IAAI,CAAC,GAAGO,KAAK;IAC3B;IACA,OAAOS,WAAW;EACpB;;;;AAIF;;AAEA,OAAO,SAASE,aAAa,CAAClB,IAAY,EAAEC,QAAyC,EAAa;EAChG,OAAO,IAAIH,SAAS,CAACE,IAAI,EAAEC,QAAQ,CAAC;AACtC"}