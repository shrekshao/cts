{"version":3,"sources":["../../../src/common/runtime/cmdline.ts"],"names":["fs","path","process","DefaultTestFileLoader","prettyPrintLog","Logger","parseQuery","parseExpectationsForTestQuery","assert","unreachable","usage","rc","console","log","exit","existsSync","verbose","debug","printJSON","loadWebGPUExpectations","undefined","queries","i","argv","length","a","startsWith","expectationsFile","resolve","cwd","then","m","expectations","push","loader","filterQuery","testcases","loadCases","globalDebugMode","failed","warned","skipped","total","testcase","name","query","toString","rec","res","record","run","printResults","status","asJSON","passed","pct","x","toFixed","rpt","xs","padStart","Math","log10","catch","ex","stack","results","r","timems","logs","l"],"mappings":"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","sourcesContent":["/* eslint no-console: \"off\" */\n/* eslint no-process-exit: \"off\" */\n\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport * as process from 'process';\n\nimport { DefaultTestFileLoader } from '../internal/file_loader.js';\nimport { prettyPrintLog } from '../internal/logging/log_message.js';\nimport { Logger } from '../internal/logging/logger.js';\nimport { LiveTestCaseResult } from '../internal/logging/result.js';\nimport { parseQuery } from '../internal/query/parseQuery.js';\nimport { parseExpectationsForTestQuery } from '../internal/query/query.js';\nimport { assert, unreachable } from '../util/util.js';\n\nfunction usage(rc: number): never {\n  console.log('Usage:');\n  console.log('  tools/run [OPTIONS...] QUERIES...');\n  console.log(\"  tools/run 'unittests:*' 'webgpu:buffers,*'\");\n  console.log('Options:');\n  console.log('  --verbose       Print result/log of every test as it runs.');\n  console.log('  --debug         Include debug messages in logging.');\n  console.log('  --print-json    Print the complete result JSON in the output.');\n  console.log('  --expectations  Path to expectations file.');\n  return process.exit(rc);\n}\n\nif (!fs.existsSync('src/common/runtime/cmdline.ts')) {\n  console.log('Must be run from repository root');\n  usage(1);\n}\n\nlet verbose = false;\nlet debug = false;\nlet printJSON = false;\nlet loadWebGPUExpectations: Promise<unknown> | undefined = undefined;\n\nconst queries: string[] = [];\nfor (let i = 2; i < process.argv.length; ++i) {\n  const a = process.argv[i];\n  if (a.startsWith('-')) {\n    if (a === '--verbose') {\n      verbose = true;\n    } else if (a === '--debug') {\n      debug = true;\n    } else if (a === '--print-json') {\n      printJSON = true;\n    } else if (a === '--expectations') {\n      const expectationsFile = path.resolve(process.cwd(), process.argv[++i]);\n      loadWebGPUExpectations = import(expectationsFile).then(m => m.expectations);\n    } else {\n      usage(1);\n    }\n  } else {\n    queries.push(a);\n  }\n}\n\nif (queries.length === 0) {\n  usage(0);\n}\n\n(async () => {\n  const loader = new DefaultTestFileLoader();\n  assert(queries.length === 1, 'currently, there must be exactly one query on the cmd line');\n  const filterQuery = parseQuery(queries[0]);\n  const testcases = await loader.loadCases(filterQuery);\n  const expectations = parseExpectationsForTestQuery(\n    await (loadWebGPUExpectations ?? []),\n    filterQuery\n  );\n\n  Logger.globalDebugMode = debug;\n  const log = new Logger();\n\n  const failed: Array<[string, LiveTestCaseResult]> = [];\n  const warned: Array<[string, LiveTestCaseResult]> = [];\n  const skipped: Array<[string, LiveTestCaseResult]> = [];\n\n  let total = 0;\n\n  for (const testcase of testcases) {\n    const name = testcase.query.toString();\n    const [rec, res] = log.record(name);\n    await testcase.run(rec, expectations);\n\n    if (verbose) {\n      printResults([[name, res]]);\n    }\n\n    total++;\n    switch (res.status) {\n      case 'pass':\n        break;\n      case 'fail':\n        failed.push([name, res]);\n        break;\n      case 'warn':\n        warned.push([name, res]);\n        break;\n      case 'skip':\n        skipped.push([name, res]);\n        break;\n      default:\n        unreachable('unrecognized status');\n    }\n  }\n\n  assert(total > 0, 'found no tests!');\n\n  // TODO: write results out somewhere (a file?)\n  if (printJSON) {\n    console.log(log.asJSON(2));\n  }\n\n  if (skipped.length) {\n    console.log('');\n    console.log('** Skipped **');\n    printResults(skipped);\n  }\n  if (warned.length) {\n    console.log('');\n    console.log('** Warnings **');\n    printResults(warned);\n  }\n  if (failed.length) {\n    console.log('');\n    console.log('** Failures **');\n    printResults(failed);\n  }\n\n  const passed = total - warned.length - failed.length - skipped.length;\n  const pct = (x: number) => ((100 * x) / total).toFixed(2);\n  const rpt = (x: number) => {\n    const xs = x.toString().padStart(1 + Math.log10(total), ' ');\n    return `${xs} / ${total} = ${pct(x).padStart(6, ' ')}%`;\n  };\n  console.log('');\n  console.log(`** Summary **\nPassed  w/o warnings = ${rpt(passed)}\nPassed with warnings = ${rpt(warned.length)}\nSkipped              = ${rpt(skipped.length)}\nFailed               = ${rpt(failed.length)}`);\n\n  if (failed.length || warned.length) {\n    process.exit(1);\n  }\n})().catch(ex => {\n  console.log(ex.stack ?? ex.toString());\n  process.exit(1);\n});\n\nfunction printResults(results: Array<[string, LiveTestCaseResult]>): void {\n  for (const [name, r] of results) {\n    console.log(`[${r.status}] ${name} (${r.timems}ms). Log:`);\n    if (r.logs) {\n      for (const l of r.logs) {\n        console.log(prettyPrintLog(l));\n      }\n    }\n  }\n}\n"],"file":"cmdline.js"}