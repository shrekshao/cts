{"version":3,"sources":["../../../src/common/tools/checklist.ts"],"names":["fs","process","DefaultTestFileLoader","Ordering","compareQueries","parseQuery","TestQueryMultiFile","loadTreeForQuery","StacklessError","assert","usage","rc","console","error","exit","argv","length","loadQueryListFromTextFile","filename","lines","promises","readFile","split","allQueries","filter","l","map","trim","queriesBySuite","Map","query","suiteQueries","get","suite","undefined","set","push","checkForOverlappingQueries","queries","q1","q2","Unordered","checkForUnmatchedSubtrees","tree","matchQueries","subtreeCount","unmatchedSubtrees","overbroadMatches","alwaysExpandThroughLevel","collapsedSubtree","iterateCollapsedQueries","subtreeMatched","q","comparison","StrictSubset","StrictSuperset","log","join","Array","from","keys","loader","queriesInSuite","entries","suiteQuery","catch","ex","stack","toString"],"mappings":"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","sourcesContent":["import * as fs from 'fs';\nimport * as process from 'process';\n\nimport { DefaultTestFileLoader } from '../internal/file_loader.js';\nimport { Ordering, compareQueries } from '../internal/query/compare.js';\nimport { parseQuery } from '../internal/query/parseQuery.js';\nimport { TestQuery, TestQueryMultiFile } from '../internal/query/query.js';\nimport { loadTreeForQuery, TestTree } from '../internal/tree.js';\nimport { StacklessError } from '../internal/util.js';\nimport { assert } from '../util/util.js';\n\nfunction usage(rc: number): void {\n  console.error('Usage:');\n  console.error('  tools/checklist FILE');\n  console.error('  tools/checklist my/list.txt');\n  process.exit(rc);\n}\n\nif (process.argv.length === 2) usage(0);\nif (process.argv.length !== 3) usage(1);\n\ntype QueriesBySuite = Map<string, TestQuery[]>;\nasync function loadQueryListFromTextFile(filename: string): Promise<QueriesBySuite> {\n  const lines = (await fs.promises.readFile(filename, 'utf8')).split(/\\r?\\n/);\n  const allQueries = lines.filter(l => l).map(l => parseQuery(l.trim()));\n\n  const queriesBySuite: QueriesBySuite = new Map();\n  for (const query of allQueries) {\n    let suiteQueries = queriesBySuite.get(query.suite);\n    if (suiteQueries === undefined) {\n      suiteQueries = [];\n      queriesBySuite.set(query.suite, suiteQueries);\n    }\n\n    suiteQueries.push(query);\n  }\n\n  return queriesBySuite;\n}\n\nfunction checkForOverlappingQueries(queries: TestQuery[]): void {\n  for (const q1 of queries) {\n    for (const q2 of queries) {\n      if (q1 !== q2 && compareQueries(q1, q2) !== Ordering.Unordered) {\n        throw new StacklessError(`The following checklist items overlap:\\n    ${q1}\\n    ${q2}`);\n      }\n    }\n  }\n}\n\nfunction checkForUnmatchedSubtrees(tree: TestTree, matchQueries: TestQuery[]): number {\n  let subtreeCount = 0;\n  const unmatchedSubtrees: TestQuery[] = [];\n  const overbroadMatches: [TestQuery, TestQuery][] = [];\n  const alwaysExpandThroughLevel = 1; // expand to, at minimum, every file.\n  for (const collapsedSubtree of tree.iterateCollapsedQueries(true, alwaysExpandThroughLevel)) {\n    subtreeCount++;\n    let subtreeMatched = false;\n    for (const q of matchQueries) {\n      const comparison = compareQueries(q, collapsedSubtree);\n      assert(comparison !== Ordering.StrictSubset); // shouldn't happen, due to subqueriesToExpand\n      if (comparison === Ordering.StrictSuperset) overbroadMatches.push([q, collapsedSubtree]);\n      if (comparison !== Ordering.Unordered) subtreeMatched = true;\n    }\n    if (!subtreeMatched) unmatchedSubtrees.push(collapsedSubtree);\n  }\n\n  if (overbroadMatches.length) {\n    // (note, this doesn't show ALL multi-test queries - just ones that actually match any .spec.ts)\n    console.log(`  FYI, the following checklist items were broader than one file:`);\n    for (const [q, collapsedSubtree] of overbroadMatches) {\n      console.log(`    ${q}  >  ${collapsedSubtree}`);\n    }\n  }\n\n  if (unmatchedSubtrees.length) {\n    throw new StacklessError(`Found unmatched tests:\\n    ${unmatchedSubtrees.join('\\n    ')}`);\n  }\n  return subtreeCount;\n}\n\n(async () => {\n  console.log('Loading queries...');\n  const queriesBySuite = await loadQueryListFromTextFile(process.argv[2]);\n  console.log('  Found suites: ' + Array.from(queriesBySuite.keys()).join(' '));\n\n  const loader = new DefaultTestFileLoader();\n  for (const [suite, queriesInSuite] of queriesBySuite.entries()) {\n    console.log(`Suite \"${suite}\":`);\n    console.log(`  Checking overlaps between ${queriesInSuite.length} checklist items...`);\n    checkForOverlappingQueries(queriesInSuite);\n    const suiteQuery = new TestQueryMultiFile(suite, []);\n    console.log(`  Loading tree ${suiteQuery}...`);\n    const tree = await loadTreeForQuery(loader, suiteQuery, queriesInSuite);\n    console.log('  Found no invalid queries in the checklist. Checking for unmatched tests...');\n    const subtreeCount = checkForUnmatchedSubtrees(tree, queriesInSuite);\n    console.log(`  No unmatched tests among ${subtreeCount} subtrees!`);\n  }\n  console.log(`Checklist looks good!`);\n})().catch(ex => {\n  console.log(ex.stack ?? ex.toString());\n  process.exit(1);\n});\n"],"file":"checklist.js"}